<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSG Contact Manager</title>

    <!-- Tailwind CSS CDN for responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom CSS embedded inline */
        .priority-high {
            @apply border-l-4 border-red-500;
        }

        .priority-medium {
            @apply border-l-4 border-yellow-500;
        }

        .priority-low {
            @apply border-l-4 border-green-500;
        }

        .priority-none {
            @apply border-l-4 border-gray-300;
        }

        .status-new {
            @apply bg-blue-100 text-blue-800;
        }

        .status-contacted {
            @apply bg-yellow-100 text-yellow-800;
        }

        .status-qualified {
            @apply bg-green-100 text-green-800;
        }

        .status-converted {
            @apply bg-purple-100 text-purple-800;
        }

        .status-inactive {
            @apply bg-gray-100 text-gray-800;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .score-bar {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner-sm {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        .loading-spinner-lg {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 200px;
        }

        /* Progress bar styles */
        .progress-container {
            width: 100%;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 0.5rem;
            transition: width 0.3s ease;
        }

        /* Button loading states */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* Error state styles */
        .error-container {
            border: 2px dashed #ef4444;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            background-color: #fef2f2;
        }

        .error-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: #ef4444;
        }

        /* Success state styles */
        .success-container {
            border: 2px solid #10b981;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            background-color: #f0fdf4;
        }

        .success-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: #10b981;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile responsive table styles */
        @media (max-width: 768px) {
            /* Hide desktop table on mobile */
            .desktop-table {
                display: none !important;
            }

            /* Show mobile cards on mobile */
            .mobile-cards-container {
                display: block !important;
            }

            /* Mobile card styles */
            .mobile-contact-card {
                display: block !important;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                margin-bottom: 1rem;
                padding: 1rem;
                background: white;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
                transition: all 0.2s ease;
                position: relative;
            }

            .mobile-contact-card:active {
                transform: scale(0.98);
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            }

            .mobile-contact-card.selected {
                border-color: #3b82f6;
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
            }

            /* Mobile card header */
            .mobile-card-header {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                margin-bottom: 0.75rem;
            }

            .mobile-card-avatar {
                width: 3rem;
                height: 3rem;
                border-radius: 50%;
                background-color: #f3f4f6;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                color: #374151;
                margin-right: 0.75rem;
                flex-shrink: 0;
            }

            .mobile-card-info {
                flex: 1;
                min-width: 0;
            }

            .mobile-card-name {
                font-size: 1rem;
                font-weight: 600;
                color: #111827;
                margin-bottom: 0.25rem;
                line-height: 1.25;
            }

            .mobile-card-title {
                font-size: 0.875rem;
                color: #6b7280;
                margin-bottom: 0.25rem;
                line-height: 1.25;
            }

            .mobile-card-company {
                font-size: 0.875rem;
                color: #374151;
                font-weight: 500;
            }

            /* Mobile card badges */
            .mobile-card-badges {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin: 0.75rem 0;
            }

            .mobile-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.25rem 0.5rem;
                border-radius: 0.375rem;
                font-size: 0.75rem;
                font-weight: 500;
                line-height: 1;
            }

            /* Mobile score display */
            .mobile-score-container {
                display: flex;
                align-items: center;
                margin: 0.75rem 0;
                padding: 0.5rem;
                background-color: #f9fafb;
                border-radius: 0.5rem;
            }

            .mobile-score-value {
                font-size: 1.125rem;
                font-weight: 700;
                margin-right: 0.5rem;
            }

            .mobile-score-bar {
                flex: 1;
                height: 0.5rem;
                background-color: #e5e7eb;
                border-radius: 0.25rem;
                overflow: hidden;
                margin-right: 0.5rem;
            }

            .mobile-score-fill {
                height: 100%;
                transition: width 0.3s ease;
                border-radius: 0.25rem;
            }

            .mobile-score-label {
                font-size: 0.75rem;
                font-weight: 500;
            }

            /* Mobile card details */
            .mobile-card-details {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
                margin: 0.75rem 0;
                padding-top: 0.75rem;
                border-top: 1px solid #f3f4f6;
            }

            .mobile-detail-item {
                display: flex;
                flex-direction: column;
            }

            .mobile-detail-label {
                font-size: 0.75rem;
                color: #6b7280;
                font-weight: 500;
                margin-bottom: 0.25rem;
                text-transform: uppercase;
                letter-spacing: 0.025em;
            }

            .mobile-detail-value {
                font-size: 0.875rem;
                color: #374151;
                font-weight: 500;
            }

            /* Mobile actions */
            .mobile-card-actions {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 1rem;
                padding-top: 0.75rem;
                border-top: 1px solid #f3f4f6;
            }

            .mobile-action-buttons {
                display: flex;
                gap: 0.5rem;
            }

            .mobile-action-btn {
                padding: 0.5rem 0.75rem;
                border-radius: 0.375rem;
                font-size: 0.875rem;
                font-weight: 500;
                border: 1px solid #d1d5db;
                background-color: white;
                color: #374151;
                transition: all 0.2s ease;
                touch-action: manipulation;
                min-height: 44px; /* iOS touch target minimum */
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .mobile-action-btn:active {
                transform: scale(0.95);
                background-color: #f9fafb;
            }

            .mobile-action-btn.primary {
                background-color: #3b82f6;
                border-color: #3b82f6;
                color: white;
            }

            .mobile-action-btn.danger {
                color: #dc2626;
                border-color: #fecaca;
            }

            /* Mobile checkbox */
            .mobile-checkbox {
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 1.25rem;
                height: 1.25rem;
                border-radius: 0.25rem;
                border: 2px solid #d1d5db;
                background-color: white;
                cursor: pointer;
                touch-action: manipulation;
            }

            .mobile-checkbox:checked {
                background-color: #3b82f6;
                border-color: #3b82f6;
            }

            /* Mobile header adjustments */
            .mobile-header {
                padding: 1rem;
                background-color: white;
                border-bottom: 1px solid #e5e7eb;
            }

            .mobile-header h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }

            /* Mobile search and filters */
            .mobile-search-container {
                margin-bottom: 1rem;
            }

            .mobile-filters-toggle {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0.75rem;
                background-color: #f9fafb;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                cursor: pointer;
                touch-action: manipulation;
            }

            .mobile-filters-content {
                display: none;
                padding: 1rem;
                background-color: white;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
            }

            .mobile-filters-content.active {
                display: block;
            }

            .mobile-filter-row {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            .mobile-filter-row:last-child {
                margin-bottom: 0;
            }

            /* Mobile bulk actions */
            .mobile-bulk-actions {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: white;
                border-top: 1px solid #e5e7eb;
                padding: 1rem;
                box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
                z-index: 40;
                transform: translateY(100%);
                transition: transform 0.3s ease;
            }

            .mobile-bulk-actions.active {
                transform: translateY(0);
            }

            .mobile-bulk-buttons {
                display: flex;
                gap: 0.5rem;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }

            .mobile-bulk-btn {
                flex-shrink: 0;
                padding: 0.75rem 1rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                font-weight: 500;
                border: 1px solid #d1d5db;
                background-color: white;
                color: #374151;
                min-height: 44px;
                touch-action: manipulation;
                white-space: nowrap;
            }

            /* Mobile pagination */
            .mobile-pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;
                padding: 1rem;
                background-color: white;
                border-top: 1px solid #e5e7eb;
            }

            .mobile-page-btn {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 0.5rem;
                font-weight: 500;
                touch-action: manipulation;
            }

            /* Mobile modal adjustments */
            .mobile-modal {
                margin: 0;
                max-height: 100vh;
                border-radius: 0;
                width: 100vw;
                height: 100vh;
                overflow-y: auto;
            }

            .mobile-modal-header {
                position: sticky;
                top: 0;
                background-color: white;
                border-bottom: 1px solid #e5e7eb;
                padding: 1rem;
                z-index: 10;
            }

            .mobile-modal-content {
                padding: 1rem;
                padding-bottom: 6rem; /* Space for fixed footer */
            }

            .mobile-modal-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: white;
                border-top: 1px solid #e5e7eb;
                padding: 1rem;
                z-index: 10;
            }

            /* Touch-friendly form elements */
            .mobile-form-input {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.75rem;
                border-radius: 0.5rem;
                border: 1px solid #d1d5db;
                width: 100%;
                margin-bottom: 1rem;
            }

            .mobile-form-select {
                min-height: 44px;
                font-size: 16px;
                padding: 0.75rem;
                border-radius: 0.5rem;
                border: 1px solid #d1d5db;
                width: 100%;
                margin-bottom: 1rem;
                background-color: white;
            }

            .mobile-form-textarea {
                min-height: 88px;
                font-size: 16px;
                padding: 0.75rem;
                border-radius: 0.5rem;
                border: 1px solid #d1d5db;
                width: 100%;
                margin-bottom: 1rem;
                resize: vertical;
            }
        }

        @media (min-width: 769px) {
            /* Hide mobile elements on desktop */
            .mobile-cards-container {
                display: none !important;
            }

            .mobile-bulk-actions {
                display: none !important;
            }

            .mobile-filters-toggle {
                display: none !important;
            }

            /* Show desktop table */
            .desktop-table {
                display: block !important;
            }
        }

        /* Tablet adjustments */
        @media (max-width: 1024px) and (min-width: 769px) {
            .table-mobile-responsive th:nth-child(n+7),
            .table-mobile-responsive td:nth-child(n+7) {
                display: none;
            }
        }

        /* Activity tracking styles */
        .contact-tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .contact-tab-content {
            min-height: 400px;
        }

        .activity-item {
            position: relative;
            padding-left: 2rem;
        }

        .activity-item::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0.5rem;
            width: 0.5rem;
            height: 0.5rem;
            background-color: #3b82f6;
            border-radius: 50%;
        }

        .activity-item::after {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 1rem;
            width: 1px;
            height: calc(100% - 0.5rem);
            background-color: #e5e7eb;
        }

        .activity-item:last-child::after {
            display: none;
        }

        .activity-type-email {}

        .activity-type-email::before {
            background-color: #10b981;
        }

        .activity-type-phone {}

        .activity-type-phone::before {
            background-color: #f59e0b;
        }

        .activity-type-meeting {}

        .activity-type-meeting::before {
            background-color: #8b5cf6;
        }

        .activity-type-followup {}

        .activity-type-followup::before {
            background-color: #ef4444;
        }

        .activity-type-note {}

        .activity-type-note::before {
            background-color: #6b7280;
        }

        /* Main tab styles */
        .main-tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .main-tab-content {
            min-height: 400px;
        }

        /* Analytics styles */
        .progress-bar {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .insight-card {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .insight-card.warning {
            border-left-color: #f59e0b;
        }

        .insight-card.success {
            border-left-color: #10b981;
        }

        .insight-card.danger {
            border-left-color: #ef4444;
        }

        .metric-trend-up {
            color: #10b981;
        }

        .metric-trend-down {
            color: #ef4444;
        }

        .metric-trend-neutral {
            color: #6b7280;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Configuration Section -->
    <script>
        // ============================================
        // CONFIGURATION SECTION
        // ============================================
        // IMPORTANT: Replace YOUR_GOOGLE_APPS_SCRIPT_URL_HERE with your actual Google Apps Script Web App URL
        // Example: https://script.google.com/macros/s/AKfycby.../exec
        const CONFIG = {
            GOOGLE_SCRIPT_URL: 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE', // Replace with your Google Apps Script Web App URL
            APP_NAME: 'GSG Contact Manager',
            VERSION: '1.0.0',
            TEAM_MEMBERS: ['Duaa', 'Israa', 'Mohammad', 'Zaid', 'Raouf'],
            CONTACT_STATUSES: ['New', 'Contacted', 'Qualified', 'Converted', 'Inactive'],
            PRIORITY_LEVELS: ['High', 'Medium', 'Low', 'None'],
            ACTIVITY_TYPES: ['Email Sent', 'Phone Call', 'Meeting Scheduled', 'Follow-up', 'Note Added']
        };
    </script>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Desktop Header -->
            <div class="hidden md:flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">GSG Contact Manager</h1>
                    <span id="connection-status" class="ml-4 px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                        Checking connection...
                    </span>
                    <span id="offline-queue-status"
                        class="ml-2 px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800"
                        style="display: none;">
                        0 pending
                    </span>
                    <span id="storage-usage-indicator" 
                        class="ml-2 text-xs text-gray-500"
                        title="Local storage usage">
                        Storage: 0%
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="help-btn"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        onclick="showHelpModal()" title="Help & Documentation (F1)">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Help
                    </button>
                    <button id="setup-btn"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        onclick="showSetupModal()">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Setup
                    </button>
                    <button id="sync-btn"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        Sync
                    </button>
                    <button id="import-contacts-btn"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        Import
                    </button>
                    <button id="export-contacts-btn"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export
                    </button>
                    <button id="add-contact-btn"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Contact
                    </button>
                </div>
            </div>

            <!-- Mobile Header -->
            <div class="md:hidden flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-lg font-bold text-gray-900">GSG Contacts</h1>
                    <span id="connection-status-mobile" class="ml-2 w-2 h-2 rounded-full bg-gray-400"></span>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="mobile-menu-btn" onclick="toggleMobileMenu()"
                        class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200 bg-white">
                <div class="px-2 pt-2 pb-3 space-y-1">
                    <button onclick="showHelpModal(); toggleMobileMenu();"
                        class="w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 flex items-center">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Help
                    </button>
                    <button onclick="showSetupModal(); toggleMobileMenu();"
                        class="w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 flex items-center">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Setup
                    </button>
                    <button onclick="syncContacts(); toggleMobileMenu();"
                        class="w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 flex items-center">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        Sync
                    </button>
                    <button onclick="document.getElementById('import-contacts-btn').click(); toggleMobileMenu();"
                        class="w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 flex items-center">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        Import
                    </button>
                    <button onclick="exportContacts(); toggleMobileMenu();"
                        class="w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50 flex items-center">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export
                    </button>
                </div>
                <div class="pt-4 pb-3 border-t border-gray-200">
                    <button onclick="openAddContactModal(); toggleMobileMenu();"
                        class="w-full mx-2 mb-2 inline-flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Contact
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Stats -->
        <div id="dashboard-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Total Contacts</dt>
                                <dd id="total-contacts" class="text-lg font-medium text-gray-900">0</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                </path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Companies</dt>
                                <dd id="total-companies" class="text-lg font-medium text-gray-900">0</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Individuals</dt>
                                <dd id="total-individuals" class="text-lg font-medium text-gray-900">0</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Follow-ups Due</dt>
                                <dd id="followups-due" class="text-lg font-medium text-red-600">0</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="hidden md:block bg-white shadow rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
                    <div class="flex-1 min-w-0">
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input id="search-input" type="text"
                                class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md"
                                placeholder="Search contacts...">
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <select id="status-filter"
                            class="block pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">All Statuses</option>
                        </select>
                        <select id="assignee-filter"
                            class="block pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">All Assignees</option>
                        </select>
                        <select id="priority-filter"
                            class="block pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">All Priorities</option>
                        </select>
                        <select id="score-filter"
                            class="block pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">All Scores</option>
                            <option value="80-100">High Priority (80-100)</option>
                            <option value="60-79">Medium Priority (60-79)</option>
                            <option value="40-59">Low Priority (40-59)</option>
                            <option value="0-39">Very Low (0-39)</option>
                        </select>
                        <select id="type-filter"
                            class="block pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">All Types</option>
                            <option value="Individual">Individual</option>
                            <option value="Company">Company</option>
                        </select>
                        <select id="industry-filter"
                            class="block pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">All Industries</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <button id="advanced-filters-btn" onclick="toggleAdvancedFilters()"
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4">
                                </path>
                            </svg>
                            Advanced
                        </button>
                        <button id="clear-filters-btn" onclick="clearAllFilters()"
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                            title="Clear all filters">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Clear
                        </button>
                        <button id="save-search-btn" onclick="showSaveSearchModal()"
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                            title="Save current search and filters">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                            </svg>
                            Save
                        </button>
                        <div class="relative">
                            <button id="saved-searches-btn" onclick="toggleSavedSearches()"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                title="Load saved searches">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                Saved
                                <span id="saved-searches-count" class="ml-1 bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded-full">0</span>
                            </button>
                            <div id="saved-searches-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-50 border border-gray-200">
                                <div class="py-1" id="saved-searches-list">
                                    <div class="px-4 py-2 text-sm text-gray-500 text-center">No saved searches</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Filters Panel -->
            <div id="advanced-filters-panel" class="hidden px-6 py-4 border-t border-gray-200 bg-gray-50">
                <!-- Search Logic Toggle -->
                <div class="mb-4 flex items-center space-x-4">
                    <label class="block text-sm font-medium text-gray-700">Search Logic:</label>
                    <div class="flex items-center space-x-2">
                        <input type="radio" id="search-logic-and" name="search-logic" value="and" checked
                            class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                        <label for="search-logic-and" class="text-sm text-gray-700">Match ALL criteria (AND)</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="radio" id="search-logic-or" name="search-logic" value="or"
                            class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                        <label for="search-logic-or" class="text-sm text-gray-700">Match ANY criteria (OR)</label>
                    </div>
                </div>

                <!-- Multi-field Search -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Multi-field Search</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div>
                            <input type="text" id="search-name" placeholder="Search by name..."
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <input type="text" id="search-company" placeholder="Search by company..."
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <input type="text" id="search-title" placeholder="Search by title..."
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <input type="text" id="search-email" placeholder="Search by email..."
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <input type="text" id="search-industry" placeholder="Search by industry..."
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <input type="text" id="search-notes" placeholder="Search by notes..."
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date Added</label>
                        <div class="flex space-x-2">
                            <input type="date" id="date-added-from"
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                placeholder="From">
                            <input type="date" id="date-added-to"
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                placeholder="To">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Contacted</label>
                        <div class="flex space-x-2">
                            <input type="date" id="last-contacted-from"
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                placeholder="From">
                            <input type="date" id="last-contacted-to"
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                placeholder="To">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Follow-up Status</label>
                        <select id="followup-filter"
                            class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Follow-ups</option>
                            <option value="overdue">Overdue</option>
                            <option value="due-today">Due Today</option>
                            <option value="due-this-week">Due This Week</option>
                            <option value="no-followup">No Follow-up Set</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Has LinkedIn</label>
                        <select id="linkedin-filter"
                            class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Contacts</option>
                            <option value="yes">Has LinkedIn</option>
                            <option value="no">No LinkedIn</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Has Phone</label>
                        <select id="phone-filter"
                            class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Contacts</option>
                            <option value="yes">Has Phone</option>
                            <option value="no">No Phone</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Score Range</label>
                        <div class="flex space-x-2">
                            <input type="number" id="score-min" min="0" max="100"
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Min">
                            <input type="number" id="score-max" min="0" max="100"
                                class="block w-full text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Max">
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-3">
                    <button onclick="clearAdvancedFilters()"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Clear Advanced
                    </button>
                    <button onclick="applyAdvancedFilters()"
                        class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Navigation Tabs -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4 md:space-x-8 px-4 md:px-6 overflow-x-auto" aria-label="Main Tabs">
                    <button id="dashboard-main-tab"
                        class="main-tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-4 px-2 md:px-1 border-b-2 font-medium text-sm active flex-shrink-0"
                        onclick="switchMainTab('dashboard')">
                        <svg class="w-5 h-5 inline mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h2a2 2 0 012 2v6H8V5z"></path>
                        </svg>
                        <span class="hidden sm:inline">Dashboard</span>
                        <span class="sm:hidden">Home</span>
                    </button>
                    <button id="contacts-main-tab"
                        class="main-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-2 md:px-1 border-b-2 font-medium text-sm flex-shrink-0"
                        onclick="switchMainTab('contacts')">
                        <svg class="w-5 h-5 inline mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        Contacts
                    </button>
                    <button id="analytics-main-tab"
                        class="main-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-2 md:px-1 border-b-2 font-medium text-sm flex-shrink-0"
                        onclick="switchMainTab('analytics')">
                        <svg class="w-5 h-5 inline mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span class="hidden sm:inline">Analytics & Insights</span>
                        <span class="sm:hidden">Analytics</span>
                    </button>
                </nav>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="main-tab-content">
            <!-- Dashboard Header -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Dashboard Overview</h3>
                            <p class="mt-1 text-sm text-gray-500">Key metrics and priority contacts at a glance</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="dashboard-last-updated" class="text-sm text-gray-500">Last updated: Never</span>
                            <button onclick="refreshDashboard()" 
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Key Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Contacts Card -->
                <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-md transition-shadow duration-200">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-100 rounded-md flex items-center justify-center">
                                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Contacts</dt>
                                    <dd class="flex items-baseline">
                                        <div id="dashboard-total-contacts" class="text-2xl font-semibold text-gray-900">0</div>
                                        <div id="dashboard-contacts-trend" class="ml-2 flex items-baseline text-sm font-semibold text-green-600">
                                            <svg class="self-center flex-shrink-0 h-4 w-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span class="sr-only">Increased by</span>
                                            +0
                                        </div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="flex items-center text-sm">
                                <span class="text-gray-500">Active: </span>
                                <span id="dashboard-active-contacts" class="ml-1 font-medium text-gray-900">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- High Priority Contacts Card -->
                <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-md transition-shadow duration-200">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-red-100 rounded-md flex items-center justify-center">
                                    <svg class="h-5 w-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">High Priority</dt>
                                    <dd class="flex items-baseline">
                                        <div id="dashboard-high-priority" class="text-2xl font-semibold text-red-600">0</div>
                                        <div class="ml-2 text-sm text-gray-500">contacts</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button onclick="filterHighPriorityContacts()" class="text-sm text-red-600 hover:text-red-800 font-medium">
                                View all →
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Follow-ups Due Card -->
                <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-md transition-shadow duration-200">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-orange-100 rounded-md flex items-center justify-center">
                                    <svg class="h-5 w-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Follow-ups Due</dt>
                                    <dd class="flex items-baseline">
                                        <div id="dashboard-followups-due" class="text-2xl font-semibold text-orange-600">0</div>
                                        <div class="ml-2 text-sm text-gray-500">today</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="flex items-center text-sm">
                                <span class="text-gray-500">Overdue: </span>
                                <span id="dashboard-overdue-followups" class="ml-1 font-medium text-red-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Card -->
                <div class="bg-white overflow-hidden shadow rounded-lg hover:shadow-md transition-shadow duration-200">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-green-100 rounded-md flex items-center justify-center">
                                    <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Recent Activity</dt>
                                    <dd class="flex items-baseline">
                                        <div id="dashboard-recent-activities" class="text-2xl font-semibold text-green-600">0</div>
                                        <div class="ml-2 text-sm text-gray-500">this week</div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="flex items-center text-sm">
                                <span class="text-gray-500">Today: </span>
                                <span id="dashboard-today-activities" class="ml-1 font-medium text-green-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Priority Contacts and Follow-ups Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Priority Contacts Requiring Attention -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Priority Contacts</h3>
                            <button onclick="filterHighPriorityContacts()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                View all →
                            </button>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">High-priority contacts requiring immediate attention</p>
                    </div>
                    <div class="px-6 py-4">
                        <div id="priority-contacts-list" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <p class="mt-2 text-sm">No high-priority contacts found</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Follow-up Reminders -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Follow-up Reminders</h3>
                            <button onclick="filterOverdueFollowups()" class="text-sm text-orange-600 hover:text-orange-800 font-medium">
                                View all →
                            </button>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Contacts with upcoming or overdue follow-ups</p>
                    </div>
                    <div class="px-6 py-4">
                        <div id="followup-reminders-list" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p class="mt-2 text-sm">No follow-ups due</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Feed and Quick Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Recent Activity Feed -->
                <div class="lg:col-span-2 bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Recent Activity</h3>
                            <button onclick="switchMainTab('analytics')" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                View analytics →
                            </button>
                        </div>
                        <p class="mt-1 text-sm text-gray-500">Latest interactions and updates</p>
                    </div>
                    <div class="px-6 py-4">
                        <div id="recent-activity-feed" class="flow-root">
                            <div class="text-center text-gray-500 py-8">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                <p class="mt-2 text-sm">No recent activity</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Panel -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Quick Actions</h3>
                        <p class="mt-1 text-sm text-gray-500">Common tasks and shortcuts</p>
                    </div>
                    <div class="px-6 py-4">
                        <div class="space-y-3">
                            <button onclick="openAddContactModal()" 
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add New Contact
                            </button>
                            
                            <button onclick="document.getElementById('import-contacts-btn').click()" 
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Import Contacts
                            </button>
                            
                            <button onclick="document.getElementById('export-contacts-btn').click()" 
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export Data
                            </button>
                            
                            <button onclick="document.getElementById('sync-btn').click()" 
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Sync with Google Sheets
                            </button>
                            
                            <div class="border-t border-gray-200 pt-3 mt-3">
                                <button onclick="filterOverdueFollowups()" 
                                    class="w-full inline-flex items-center justify-center px-4 py-2 border border-orange-300 shadow-sm text-sm font-medium rounded-md text-orange-700 bg-orange-50 hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    View Overdue Follow-ups
                                </button>
                                
                                <button onclick="filterHighPriorityContacts()" 
                                    class="w-full mt-2 inline-flex items-center justify-center px-4 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                    View High Priority
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contacts Section -->
        <div id="contacts-section" class="main-tab-content hidden">
            <!-- Mobile Filters Toggle -->
            <div class="mobile-filters-toggle md:hidden" onclick="toggleMobileFilters()">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4">
                        </path>
                    </svg>
                    <span class="font-medium">Filters & Search</span>
                </div>
                <svg id="mobile-filters-chevron" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>

            <!-- Mobile Filters Content -->
            <div id="mobile-filters-content" class="mobile-filters-content">
                <div class="mobile-search-container">
                    <input id="mobile-search-input" type="text" 
                        class="mobile-form-input" 
                        placeholder="Search contacts...">
                </div>
                <div class="mobile-filter-row">
                    <select id="mobile-status-filter" class="mobile-form-select">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                <div class="mobile-filter-row">
                    <select id="mobile-assignee-filter" class="mobile-form-select">
                        <option value="">All Assignees</option>
                    </select>
                </div>
                <div class="mobile-filter-row">
                    <select id="mobile-priority-filter" class="mobile-form-select">
                        <option value="">All Priorities</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearAllFilters()" class="flex-1 mobile-action-btn">
                        Clear Filters
                    </button>
                    <button onclick="toggleMobileFilters()" class="flex-1 mobile-action-btn primary">
                        Apply
                    </button>
                </div>
            </div>

            <!-- Desktop Contacts Table -->
            <div class="desktop-table bg-white shadow overflow-hidden sm:rounded-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Contacts</h3>
                    <p class="mt-1 text-sm text-gray-500">Manage your business leader contacts</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table-mobile-responsive">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="select-all"
                                        class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="name">
                                    Name
                                    <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="company">
                                    Company
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="status">
                                    Status
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="priority">
                                    Priority
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="score">
                                    Score
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="relevance" id="relevance-header" style="display: none;">
                                    Relevance
                                    <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="assignee">
                                    Assignee
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                    data-sort="nextFollowUp">
                                    Follow-up
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Contact rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mobile Cards Container -->
            <div id="mobile-cards-container" class="mobile-cards-container hidden">
                <div class="px-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Contacts</h3>
                        <button onclick="openAddContactModal()" 
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add
                        </button>
                    </div>
                    <div id="mobile-contacts-list">
                        <!-- Mobile contact cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Desktop Bulk Actions Bar -->
            <div id="bulk-actions-bar" class="hidden bg-blue-50 border-t border-blue-200 px-6 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span id="selected-count" class="text-sm font-medium text-blue-900">0 contacts selected</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <select id="bulk-status-update"
                            class="text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Update Status...</option>
                            <option value="New">New</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Qualified">Qualified</option>
                            <option value="Converted">Converted</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                        <select id="bulk-assignee-update"
                            class="text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Assign to...</option>
                            <!-- Options populated by JavaScript -->
                        </select>
                        <select id="bulk-priority-update"
                            class="text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Set Priority...</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                            <option value="None">None</option>
                        </select>
                        <button id="apply-bulk-updates" onclick="applyBulkUpdates()"
                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Apply Updates
                        </button>
                        <button id="bulk-email" onclick="generateBulkEmailTemplate()"
                            class="inline-flex items-center px-3 py-2 border border-green-300 text-sm leading-4 font-medium rounded-md text-green-700 bg-white hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Email Template
                        </button>
                        <button id="bulk-delete" onclick="bulkDeleteContacts()"
                            class="inline-flex items-center px-3 py-2 border border-red-300 text-sm leading-4 font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Delete Selected
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile Bulk Actions Bar -->
            <div id="mobile-bulk-actions" class="mobile-bulk-actions">
                <div class="flex items-center justify-between mb-3">
                    <span id="mobile-selected-count" class="text-sm font-medium text-gray-900">0 contacts selected</span>
                    <button onclick="clearMobileSelection()" class="text-sm text-gray-500 hover:text-gray-700">
                        Clear Selection
                    </button>
                </div>
                <div class="mobile-bulk-buttons">
                    <select id="mobile-bulk-status" class="mobile-bulk-btn">
                        <option value="">Update Status...</option>
                        <option value="New">New</option>
                        <option value="Contacted">Contacted</option>
                        <option value="Qualified">Qualified</option>
                        <option value="Converted">Converted</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                    <select id="mobile-bulk-assignee" class="mobile-bulk-btn">
                        <option value="">Assign to...</option>
                        <!-- Options populated by JavaScript -->
                    </select>
                    <select id="mobile-bulk-priority" class="mobile-bulk-btn">
                        <option value="">Set Priority...</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                        <option value="None">None</option>
                    </select>
                    <button onclick="applyMobileBulkUpdates()" class="mobile-bulk-btn bg-blue-600 text-white border-blue-600">
                        Apply Updates
                    </button>
                    <button onclick="generateBulkEmailTemplate()" class="mobile-bulk-btn bg-green-600 text-white border-green-600">
                        Email Template
                    </button>
                    <button onclick="bulkDeleteContacts()" class="mobile-bulk-btn bg-red-600 text-white border-red-600">
                        Delete Selected
                    </button>
                </div>
            </div>

            <!-- Desktop Pagination Controls -->
            <div id="pagination-controls"
                class="hidden md:flex bg-white px-6 py-3 border-t border-gray-200 items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-700">
                        Showing <span id="showing-start">1</span> to <span id="showing-end">25</span> of <span
                            id="total-contacts-count">0</span> contacts
                    </div>
                    <select id="items-per-page" onchange="changeItemsPerPage(this.value)"
                        class="text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="10">10 per page</option>
                        <option value="25" selected>25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="prev-page" onclick="goToPage(currentPage - 1)"
                        class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                            </path>
                        </svg>
                        Previous
                    </button>
                    <div id="page-numbers" class="flex space-x-1">
                        <!-- Page numbers will be populated here -->
                    </div>
                    <button id="next-page" onclick="goToPage(currentPage + 1)"
                        class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Pagination Controls -->
            <div id="mobile-pagination-controls" class="md:hidden mobile-pagination">
                <div class="text-sm text-gray-700 mb-3 text-center">
                    <span id="mobile-showing-start">1</span>-<span id="mobile-showing-end">25</span> of <span id="mobile-total-contacts-count">0</span>
                </div>
                <div class="flex items-center justify-center space-x-2">
                    <button id="mobile-prev-page" onclick="goToPage(currentPage - 1)"
                        class="mobile-page-btn border border-gray-300 bg-white text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <div class="flex items-center space-x-1">
                        <span id="mobile-current-page" class="mobile-page-btn bg-blue-600 text-white border-blue-600">1</span>
                        <span class="text-gray-500">of</span>
                        <span id="mobile-total-pages" class="text-gray-900 font-medium">1</span>
                    </div>
                    <button id="mobile-next-page" onclick="goToPage(currentPage + 1)"
                        class="mobile-page-btn border border-gray-300 bg-white text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
                <div class="mt-3 text-center">
                    <select id="mobile-items-per-page" onchange="changeItemsPerPage(this.value)"
                        class="text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="10">10 per page</option>
                        <option value="25" selected>25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No contacts</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by adding your first contact.</p>
                <div class="mt-6">
                    <button type="button"
                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Contact
                    </button>
                </div>
            </div>
        </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics-section" class="main-tab-content hidden">
            <!-- Analytics Header -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Analytics & Insights</h2>
                            <p class="mt-1 text-sm text-gray-500">Performance metrics and actionable insights for your contact management</p>
                        </div>
                        <button onclick="updateAnalyticsDashboard()" 
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="space-y-6">
                <!-- Key Metrics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Conversion Rate</dt>
                                        <dd id="conversion-rate" class="text-lg font-medium text-gray-900">0%</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Avg. Score</dt>
                                        <dd id="average-score" class="text-lg font-medium text-gray-900">0</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-6 w-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Avg. Days to Contact</dt>
                                        <dd id="avg-days-to-contact" class="text-lg font-medium text-gray-900">0</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="h-6 w-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Active Team Members</dt>
                                        <dd id="active-team-members" class="text-lg font-medium text-gray-900">0</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Contact Distribution Chart -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Contact Distribution</h3>
                            <p class="mt-1 text-sm text-gray-500">Breakdown by status, industry, and priority</p>
                        </div>
                        <div class="p-6">
                            <div class="space-y-6">
                                <!-- Status Distribution -->
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">By Status</h4>
                                    <div id="status-distribution" class="space-y-2">
                                        <!-- Status bars will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Priority Distribution -->
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">By Priority</h4>
                                    <div id="priority-distribution" class="space-y-2">
                                        <!-- Priority bars will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Score Distribution -->
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-3">By Score Range</h4>
                                    <div id="score-distribution" class="space-y-2">
                                        <!-- Score distribution bars will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Industry Insights -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Industry Insights</h3>
                            <p class="mt-1 text-sm text-gray-500">Top industries and conversion rates</p>
                        </div>
                        <div class="p-6">
                            <div id="industry-insights" class="space-y-4">
                                <!-- Industry insights will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Performance and Trends -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Team Performance -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Team Performance</h3>
                            <p class="mt-1 text-sm text-gray-500">Individual team member statistics</p>
                        </div>
                        <div class="p-6">
                            <div id="team-performance" class="space-y-4">
                                <!-- Team performance will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Trend Analysis -->
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Trend Analysis</h3>
                            <p class="mt-1 text-sm text-gray-500">Contact acquisition and engagement trends</p>
                        </div>
                        <div class="p-6">
                            <div id="trend-analysis" class="space-y-4">
                                <!-- Trend analysis will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actionable Insights -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Actionable Insights</h3>
                        <p class="mt-1 text-sm text-gray-500">AI-powered recommendations to improve performance</p>
                    </div>
                    <div class="p-6">
                        <div id="actionable-insights" class="space-y-4">
                            <!-- Actionable insights will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Contact Modal -->
    <div id="contact-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity modal-overlay" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div class="inline-block align-bottom bg-white text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full max-h-screen overflow-y-auto md:rounded-lg mobile-modal">
                <div class="bg-white">
                    <!-- Modal Header -->
                    <div class="mobile-modal-header px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Add New Contact
                            </h3>
                            <button onclick="closeContactModal()" class="md:hidden p-2 text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                            <button id="contact-details-tab"
                                class="contact-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm active"
                                onclick="switchContactTab('details')">
                                Contact Details
                            </button>
                            <button id="contact-activities-tab"
                                class="contact-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
                                onclick="switchContactTab('activities')" style="display: none;">
                                Activities
                                <span id="activity-count-badge"
                                    class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">0</span>
                            </button>
                        </nav>
                    </div>

                    <!-- Tab Content -->
                    <div class="mobile-modal-content px-6 py-4">
                        <!-- Contact Details Tab -->
                        <div id="contact-details-content" class="contact-tab-content">
                            <form id="contact-form">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="contact-type"
                                            class="block text-sm font-medium text-gray-700">Type</label>
                                        <select id="contact-type" name="type"
                                            class="mobile-form-select mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                            <option value="Individual">Individual</option>
                                            <option value="Company">Company</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label for="contact-name" class="block text-sm font-medium text-gray-700">Name
                                            *</label>
                                        <input type="text" id="contact-name" name="name" required
                                            class="mobile-form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div>
                                        <label for="contact-title"
                                            class="block text-sm font-medium text-gray-700">Title</label>
                                        <input type="text" id="contact-title" name="title"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div>
                                        <label for="contact-company"
                                            class="block text-sm font-medium text-gray-700">Company</label>
                                        <input type="text" id="contact-company" name="company"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div>
                                        <label for="contact-industry"
                                            class="block text-sm font-medium text-gray-700">Industry</label>
                                        <input type="text" id="contact-industry" name="industry"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div>
                                        <label for="contact-email" class="block text-sm font-medium text-gray-700">Email
                                            *</label>
                                        <input type="email" id="contact-email" name="email" required
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div>
                                        <label for="contact-linkedin"
                                            class="block text-sm font-medium text-gray-700">LinkedIn</label>
                                        <input type="url" id="contact-linkedin" name="linkedin"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div>
                                        <label for="contact-phone"
                                            class="block text-sm font-medium text-gray-700">Phone</label>
                                        <input type="tel" id="contact-phone" name="phone"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div>
                                        <label for="contact-status"
                                            class="block text-sm font-medium text-gray-700">Status</label>
                                        <select id="contact-status" name="status"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                            <!-- Options populated by JavaScript -->
                                        </select>
                                    </div>

                                    <div>
                                        <label for="contact-priority"
                                            class="block text-sm font-medium text-gray-700">Priority</label>
                                        <select id="contact-priority" name="priority"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                            <!-- Options populated by JavaScript -->
                                        </select>
                                    </div>

                                    <div>
                                        <label for="contact-assignee"
                                            class="block text-sm font-medium text-gray-700">Assignee</label>
                                        <select id="contact-assignee" name="assignee"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                            <option value="">Unassigned</option>
                                            <!-- Options populated by JavaScript -->
                                        </select>
                                    </div>

                                    <div>
                                        <label for="contact-followup-date"
                                            class="block text-sm font-medium text-gray-700">Follow-up Date</label>
                                        <input type="date" id="contact-followup-date" name="nextFollowUp"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    </div>

                                    <div class="md:col-span-2">
                                        <label for="contact-notes"
                                            class="block text-sm font-medium text-gray-700">Notes</label>
                                        <textarea id="contact-notes" name="notes" rows="3"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                                    </div>

                                    <!-- Manual Score Adjustment Section -->
                                    <div class="md:col-span-2 pt-4 border-t border-gray-200">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="text-sm font-medium text-gray-900">Score Management</h4>
                                            <button type="button" id="recalculate-score-btn" onclick="recalculateContactScore()"
                                                class="text-xs text-blue-600 hover:text-blue-800 underline">
                                                Recalculate Auto Score
                                            </button>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="contact-auto-score" class="block text-sm font-medium text-gray-700">
                                                    Automatic Score
                                                    <span class="text-xs text-gray-500">(calculated)</span>
                                                </label>
                                                <div class="mt-1 flex items-center space-x-2">
                                                    <input type="number" id="contact-auto-score" readonly
                                                        class="block w-20 border-gray-300 rounded-md shadow-sm bg-gray-50 text-gray-600 sm:text-sm"
                                                        min="0" max="100">
                                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                                        <div id="auto-score-bar" class="h-2 rounded-full transition-all duration-300" 
                                                             style="width: 0%"></div>
                                                    </div>
                                                    <span id="auto-score-label" class="text-xs text-gray-600">Very Low</span>
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <label for="contact-manual-score" class="block text-sm font-medium text-gray-700">
                                                    Manual Score Override
                                                    <span class="text-xs text-gray-500">(optional)</span>
                                                </label>
                                                <div class="mt-1 flex items-center space-x-2">
                                                    <input type="number" id="contact-manual-score" name="manualScore"
                                                        class="block w-20 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                        min="0" max="100" placeholder="Auto">
                                                    <div class="flex-1 bg-gray-200 rounded-full h-2">
                                                        <div id="manual-score-bar" class="h-2 rounded-full transition-all duration-300" 
                                                             style="width: 0%"></div>
                                                    </div>
                                                    <span id="manual-score-label" class="text-xs text-gray-600">Auto</span>
                                                </div>
                                                <p class="mt-1 text-xs text-gray-500">
                                                    Leave empty to use automatic score. Override to manually set priority.
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-gray-700">Final Score:</span>
                                                <div class="flex items-center space-x-2">
                                                    <span id="final-score-value" class="text-lg font-bold text-gray-900">0</span>
                                                    <span id="final-score-source" class="text-xs text-gray-500">(automatic)</span>
                                                </div>
                                            </div>
                                            <div class="mt-1 w-full bg-gray-200 rounded-full h-3">
                                                <div id="final-score-bar" class="h-3 rounded-full transition-all duration-300" 
                                                     style="width: 0%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Assignment History Section -->
                                <div id="assignment-history-section" class="mt-6 pt-6 border-t border-gray-200" style="display: none;">
                                    <h4 class="text-sm font-medium text-gray-900 mb-3">Assignment History</h4>
                                    <div id="assignment-history-list" class="space-y-2">
                                        <!-- Assignment history items will be populated here -->
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Activities Tab -->
                        <div id="contact-activities-content" class="contact-tab-content hidden">
                            <!-- Add Activity Form -->
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Add New Activity</h4>
                                <form id="activity-form" class="space-y-3">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label for="activity-type"
                                                class="block text-sm font-medium text-gray-700">Activity Type</label>
                                            <select id="activity-type" name="type"
                                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                                <!-- Options populated by JavaScript -->
                                            </select>
                                        </div>
                                        <div>
                                            <label for="activity-date"
                                                class="block text-sm font-medium text-gray-700">Date</label>
                                            <input type="datetime-local" id="activity-date" name="date"
                                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="activity-notes"
                                            class="block text-sm font-medium text-gray-700">Notes</label>
                                        <textarea id="activity-notes" name="notes" rows="2"
                                            placeholder="Add details about this activity..."
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="button" onclick="addActivity()"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            Add Activity
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Activity Timeline -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-900 mb-3">Activity Timeline</h4>
                                <div id="activity-timeline" class="space-y-3">
                                    <div class="text-center py-8 text-gray-500">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <p class="mt-2 text-sm">No activities recorded yet</p>
                                        <p class="text-xs text-gray-400">Activities will appear here once you add them
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="bg-gray-50 px-6 py-3 flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <button type="button" id="add-activity-btn" onclick="switchContactTab('activities')"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                style="display: none;">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Add Activity
                            </button>
                        </div>
                        <div class="mobile-modal-footer flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
                            <button type="button" id="cancel-modal"
                                class="w-full md:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-3 md:py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm mobile-form-input">
                                Cancel
                            </button>
                            <button type="button" id="save-contact-btn" onclick="saveContact()"
                                class="w-full md:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-3 md:py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm mobile-form-input">
                                Save Contact
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Instructions Modal -->
    <div id="setup-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity modal-overlay" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-center mb-4">
                        <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3 class="text-lg leading-6 font-medium text-gray-900">
                            Google Apps Script Setup Required
                        </h3>
                    </div>

                    <div class="prose prose-sm max-w-none">
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                            <p class="text-sm text-blue-800 mb-2">
                                <strong>Current Status:</strong> <span id="setup-status">Google Apps Script URL not
                                    configured</span>
                            </p>
                            <p class="text-sm text-blue-700">
                                To use the GSG Contact Manager, you need to set up a Google Apps Script backend that
                                will sync with your Google Sheet.
                            </p>
                        </div>

                        <h4 class="text-md font-semibold text-gray-900 mb-3">Step-by-Step Setup Instructions:</h4>

                        <ol class="list-decimal list-inside space-y-3 text-sm text-gray-700">
                            <li>
                                <strong>Create Google Apps Script Project:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                    <li>Go to <a href="https://script.google.com" target="_blank"
                                            class="text-blue-600 hover:text-blue-800 underline">script.google.com</a>
                                    </li>
                                    <li>Click "New Project"</li>
                                    <li>Give your project a name like "GSG Contact Manager API"</li>
                                </ul>
                            </li>

                            <li>
                                <strong>Add the Script Code:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                    <li>Delete the default code in the editor</li>
                                    <li>Copy and paste the Google Apps Script code (provided separately)</li>
                                    <li>Save the project (Ctrl+S or Cmd+S)</li>
                                </ul>
                            </li>

                            <li>
                                <strong>Create Google Sheet:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                    <li>Create a new Google Sheet for your contacts</li>
                                    <li>Name it "GSG Contact Manager Database"</li>
                                    <li>Copy the Sheet ID from the URL</li>
                                    <li>Update the SHEET_ID variable in your Apps Script code</li>
                                </ul>
                            </li>

                            <li>
                                <strong>Deploy as Web App:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                    <li>Click "Deploy" → "New deployment"</li>
                                    <li>Choose "Web app" as the type</li>
                                    <li>Set "Execute as" to "Me"</li>
                                    <li>Set "Who has access" to "Anyone"</li>
                                    <li>Click "Deploy"</li>
                                </ul>
                            </li>

                            <li>
                                <strong>Configure This HTML File:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                    <li>Copy the Web App URL from the deployment</li>
                                    <li>Open this HTML file in a text editor</li>
                                    <li>Find the CONFIGURATION SECTION at the top</li>
                                    <li>Replace 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE' with your Web App URL</li>
                                    <li>Save the HTML file</li>
                                </ul>
                            </li>

                            <li>
                                <strong>Test the Connection:</strong>
                                <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                                    <li>Refresh this page in your browser</li>
                                    <li>The connection status should show "Connected"</li>
                                    <li>Try adding a test contact to verify everything works</li>
                                </ul>
                            </li>
                        </ol>

                        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                            <h5 class="text-sm font-semibold text-yellow-800 mb-2">Important Notes:</h5>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>• The Google Apps Script must be deployed with "Anyone" access to work without
                                    authentication</li>
                                <li>• Make sure your Google Sheet has the correct permissions for the script to access
                                    it</li>
                                <li>• If you update the script code, you'll need to create a new deployment</li>
                                <li>• Keep your Web App URL secure - anyone with it can access your contact data</li>
                            </ul>
                        </div>

                        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                            <h5 class="text-sm font-semibold text-green-800 mb-2">Need Help?</h5>
                            <p class="text-sm text-green-700">
                                If you encounter issues during setup, check the browser console for error messages and
                                verify that:
                            </p>
                            <ul class="text-sm text-green-700 mt-2 space-y-1">
                                <li>• Your Google Apps Script URL is correct and accessible</li>
                                <li>• The script has proper permissions to access your Google Sheet</li>
                                <li>• Your browser allows requests to the Google Apps Script domain</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Offline Queue Status Section -->
                    <div id="queue-status-section" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-md">
                        <h4 class="text-md font-semibold text-gray-900 mb-3 flex items-center">
                            <svg class="w-5 h-5 text-orange-500 mr-2" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Offline Queue Status
                        </h4>
                        <div id="queue-status-content">
                            <p class="text-sm text-gray-600 mb-2">
                                <span id="queue-count">0</span> operations pending sync
                            </p>
                            <div class="flex space-x-2">
                                <button type="button" id="process-queue-btn"
                                    class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                    Process Queue
                                </button>
                                <button type="button" id="clear-queue-btn"
                                    class="inline-flex items-center px-3 py-1 border border-red-300 shadow-sm text-xs font-medium rounded text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                    Clear Queue
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Local Storage Status Section -->
                    <div id="storage-status-section" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                        <h4 class="text-md font-semibold text-gray-900 mb-3 flex items-center">
                            <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                            </svg>
                            Local Storage Status
                        </h4>
                        <div id="storage-status-content">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Contacts:</span>
                                    <span id="storage-contacts-count" class="font-medium">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Activities:</span>
                                    <span id="storage-activities-count" class="font-medium">0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Storage Used:</span>
                                    <span id="storage-usage-percent" class="font-medium">0%</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Last Sync:</span>
                                    <span id="storage-last-sync" class="font-medium">Never</span>
                                </div>
                            </div>
                            <div class="mt-3 flex space-x-2">
                                <button type="button" id="backup-data-btn" onclick="createDataBackup()"
                                    class="inline-flex items-center px-3 py-1 border border-blue-300 shadow-sm text-xs font-medium rounded text-blue-700 bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                    Backup Data
                                </button>
                                <button type="button" id="clear-storage-btn" onclick="clearLocalStorage()"
                                    class="inline-flex items-center px-3 py-1 border border-red-300 shadow-sm text-xs font-medium rounded text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    Clear Storage
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="test-connection-btn"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Test Connection
                    </button>
                    <button type="button" id="close-setup-modal"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Email Template Modal -->
    <div id="bulk-email-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity modal-overlay" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-center mb-4">
                        <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <h3 class="text-lg leading-6 font-medium text-gray-900">
                            Bulk Email Template Generator
                        </h3>
                    </div>

                    <div class="mb-6">
                        <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-md">
                            <p class="text-sm text-green-800 mb-2">
                                <strong>Selected Contacts:</strong> <span id="bulk-email-count">0</span> contacts
                            </p>
                            <p class="text-sm text-green-700">
                                Generate personalized email templates for your selected contacts. You can customize the template and copy the generated emails to your email client.
                            </p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label for="email-subject" class="block text-sm font-medium text-gray-700 mb-1">Email Subject</label>
                                <input type="text" id="email-subject" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Partnership Opportunity with GSG Palestine"
                                    value="Partnership Opportunity with GSG Palestine">
                            </div>

                            <div>
                                <label for="email-template" class="block text-sm font-medium text-gray-700 mb-1">Email Template</label>
                                <textarea id="email-template" rows="8" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Dear {{name}},

I hope this email finds you well. I am reaching out from GSG Palestine regarding our Business Leaders for Peace initiative.

{{custom_message}}

Best regards,
{{sender_name}}
GSG Palestine">Dear {{name}},

I hope this email finds you well. I am reaching out from GSG Palestine regarding our Business Leaders for Peace initiative.

Given your role as {{title}} at {{company}} in the {{industry}} sector, I believe there could be valuable opportunities for collaboration.

We would love to discuss how we can work together to create positive impact in the region.

Would you be available for a brief call next week to explore potential partnerships?

Best regards,
{{sender_name}}
GSG Palestine</textarea>
                                <div class="mt-2 text-xs text-gray-500">
                                    Available placeholders: {{name}}, {{title}}, {{company}}, {{industry}}, {{sender_name}}
                                </div>
                            </div>

                            <div>
                                <label for="sender-name" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                                <input type="text" id="sender-name" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Your Name">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-md font-medium text-gray-900">Generated Emails Preview</h4>
                            <button id="generate-emails-btn" onclick="generateEmailPreviews()"
                                class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Generate Preview
                            </button>
                        </div>
                        <div id="email-previews" class="max-h-64 overflow-y-auto border border-gray-200 rounded-md p-3 bg-gray-50">
                            <p class="text-sm text-gray-500 text-center">Click "Generate Preview" to see personalized emails</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-3 flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <button id="copy-all-emails" onclick="copyAllEmails()" disabled
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy All Emails
                        </button>
                        <button id="export-email-csv" onclick="exportEmailCSV()" disabled
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export CSV
                        </button>
                    </div>
                    <button type="button" id="close-bulk-email-modal"
                        class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Contacts Modal -->
    <div id="import-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity modal-overlay" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Import Contacts
                            </h3>
                            <div class="mt-4">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Select CSV File
                                    </label>
                                    <input type="file" id="import-file-input" accept=".csv" 
                                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p class="mt-1 text-xs text-gray-500">
                                        CSV file with headers: Name, Email, Company, Title, Industry, Status, Priority, Assignee, Phone, LinkedIn, Notes
                                    </p>
                                </div>
                                
                                <div id="import-preview" class="hidden">
                                    <h4 class="text-sm font-medium text-gray-900 mb-2">Preview</h4>
                                    <div class="max-h-40 overflow-y-auto border border-gray-200 rounded">
                                        <table class="min-w-full text-xs">
                                            <thead id="import-preview-headers" class="bg-gray-50"></thead>
                                            <tbody id="import-preview-body"></tbody>
                                        </table>
                                    </div>
                                    <div class="mt-2 text-sm text-gray-600">
                                        <span id="import-total-count">0</span> contacts found, 
                                        <span id="import-valid-count">0</span> valid, 
                                        <span id="import-duplicate-count">0</span> duplicates
                                    </div>
                                </div>

                                <div id="import-options" class="hidden mt-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-2">Import Options</h4>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="duplicate-handling" value="skip" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                            <span class="ml-2 text-sm text-gray-700">Skip duplicates (based on email)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="duplicate-handling" value="update" 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                            <span class="ml-2 text-sm text-gray-700">Update existing contacts</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="duplicate-handling" value="create" 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                            <span class="ml-2 text-sm text-gray-700">Create all (allow duplicates)</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="confirm-import-btn" disabled
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                        Import Contacts
                    </button>
                    <button type="button" id="cancel-import-btn"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Contacts Modal -->
    <div id="export-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity modal-overlay" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Export Contacts
                            </h3>
                            <div class="mt-4">
                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-2">Export Options</h4>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="export-scope" value="all" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                            <span class="ml-2 text-sm text-gray-700">All contacts (<span id="export-all-count">0</span>)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="export-scope" value="filtered" 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                            <span class="ml-2 text-sm text-gray-700">Filtered contacts (<span id="export-filtered-count">0</span>)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="export-scope" value="selected" 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                            <span class="ml-2 text-sm text-gray-700">Selected contacts (<span id="export-selected-count">0</span>)</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <h4 class="text-sm font-medium text-gray-900 mb-2">Include Fields</h4>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-name" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Name</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-email" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Email</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-company" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Company</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-title" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Title</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-industry" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Industry</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-status" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Status</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-priority" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Priority</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-assignee" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Assignee</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-phone" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Phone</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-linkedin" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">LinkedIn</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-score" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Score</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-notes" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Notes</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-followup" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Next Follow-up</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-lastcontacted" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Last Contacted</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-dateadded" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Date Added</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-field-type" checked 
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <span class="ml-2">Type</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="export-include-activities" 
                                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-700">Include activity summary</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="confirm-export-btn"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Export CSV
                    </button>
                    <button type="button" id="cancel-export-btn"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help and Documentation Modal -->
    <div id="help-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity modal-overlay" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div class="inline-block align-bottom bg-white text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full max-h-screen overflow-y-auto rounded-lg">
                <div class="bg-white">
                    <!-- Modal Header -->
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Help & Documentation
                            </h3>
                            <button type="button" onclick="closeHelpModal()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Help Content -->
                    <div class="px-6 py-4">
                        <!-- Help Navigation Tabs -->
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-8">
                                <button onclick="switchHelpTab('overview')" 
                                    class="help-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-blue-500 text-blue-600" 
                                    data-tab="overview">
                                    Overview
                                </button>
                                <button onclick="switchHelpTab('shortcuts')" 
                                    class="help-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                                    data-tab="shortcuts">
                                    Keyboard Shortcuts
                                </button>
                                <button onclick="switchHelpTab('features')" 
                                    class="help-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                                    data-tab="features">
                                    Features Guide
                                </button>
                                <button onclick="switchHelpTab('troubleshooting')" 
                                    class="help-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                                    data-tab="troubleshooting">
                                    Troubleshooting
                                </button>
                                <button onclick="switchHelpTab('performance')" 
                                    class="help-tab-btn py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" 
                                    data-tab="performance">
                                    Performance
                                </button>
                            </nav>
                        </div>

                        <!-- Help Tab Contents -->
                        <div id="help-content">
                            <!-- Overview Tab -->
                            <div id="help-overview" class="help-tab-content">
                                <div class="prose max-w-none">
                                    <h2 class="text-xl font-semibold text-gray-900 mb-4">GSG Contact Manager Overview</h2>
                                    
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                        <h3 class="text-lg font-medium text-blue-900 mb-2">Welcome to GSG Contact Manager!</h3>
                                        <p class="text-blue-800">
                                            This is a comprehensive contact management system designed specifically for the GSG Palestine team 
                                            to manage business leader contacts from the "Business Leaders for Peace" initiative.
                                        </p>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <h4 class="font-semibold text-gray-900 mb-2">🎯 Key Features</h4>
                                            <ul class="text-sm text-gray-600 space-y-1">
                                                <li>• Complete contact management (CRUD operations)</li>
                                                <li>• Intelligent scoring and prioritization</li>
                                                <li>• Activity tracking and timeline</li>
                                                <li>• Advanced search and filtering</li>
                                                <li>• Analytics and insights dashboard</li>
                                                <li>• Google Sheets synchronization</li>
                                                <li>• Bulk operations and email templates</li>
                                                <li>• Import/Export functionality</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <h4 class="font-semibold text-gray-900 mb-2">⚡ Performance Features</h4>
                                            <ul class="text-sm text-gray-600 space-y-1">
                                                <li>• Optimized for 1000+ contacts</li>
                                                <li>• Smart pagination and virtual scrolling</li>
                                                <li>• Debounced search and filtering</li>
                                                <li>• Local storage with offline support</li>
                                                <li>• Keyboard shortcuts for power users</li>
                                                <li>• Data validation and integrity checks</li>
                                                <li>• Mobile-responsive design</li>
                                                <li>• Real-time performance monitoring</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                        <h4 class="font-semibold text-yellow-900 mb-2">🚀 Getting Started</h4>
                                        <ol class="text-sm text-yellow-800 space-y-1">
                                            <li>1. Click the "Setup" button to configure your Google Apps Script URL</li>
                                            <li>2. Follow the setup instructions to deploy your Google Apps Script</li>
                                            <li>3. Test the connection to ensure everything is working</li>
                                            <li>4. Start adding contacts or import from CSV</li>
                                            <li>5. Use Ctrl+F1 to access this help anytime</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            <!-- Keyboard Shortcuts Tab -->
                            <div id="help-shortcuts" class="help-tab-content hidden">
                                <div class="prose max-w-none">
                                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Keyboard Shortcuts</h2>
                                    
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                        <p class="text-green-800">
                                            <strong>Tip:</strong> Press <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs">Ctrl + /</kbd> 
                                            to toggle keyboard shortcuts on/off. Current status: 
                                            <span id="shortcuts-status" class="font-semibold">Enabled</span>
                                        </p>
                                    </div>

                                    <div id="shortcuts-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Shortcuts will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Features Guide Tab -->
                            <div id="help-features" class="help-tab-content hidden">
                                <div class="prose max-w-none">
                                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Features Guide</h2>
                                    
                                    <div class="space-y-6">
                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <h3 class="font-semibold text-gray-900 mb-3">📊 Intelligent Scoring System</h3>
                                            <p class="text-gray-600 mb-3">
                                                Contacts are automatically scored based on multiple factors to help you prioritize your outreach efforts.
                                            </p>
                                            <div class="bg-gray-50 rounded p-3">
                                                <h4 class="font-medium text-gray-800 mb-2">Scoring Factors:</h4>
                                                <ul class="text-sm text-gray-600 space-y-1">
                                                    <li>• <strong>Title Score (0-40 points):</strong> CEO/Founder (40), Director/VP (30), Manager (20), etc.</li>
                                                    <li>• <strong>Industry Score (0-30 points):</strong> Sustainability (30), Tech/Finance (25), etc.</li>
                                                    <li>• <strong>Company Type (0-20 points):</strong> Established Company (20), Individual (10)</li>
                                                    <li>• <strong>Engagement (0-10 points):</strong> Recent activity (10), Some activity (5)</li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <h3 class="font-semibold text-gray-900 mb-3">🔍 Advanced Search & Filtering</h3>
                                            <p class="text-gray-600 mb-3">
                                                Use powerful search and filtering capabilities to find exactly the contacts you need.
                                            </p>
                                            <div class="bg-gray-50 rounded p-3">
                                                <h4 class="font-medium text-gray-800 mb-2">Search Features:</h4>
                                                <ul class="text-sm text-gray-600 space-y-1">
                                                    <li>• Multi-field search across name, company, title, industry</li>
                                                    <li>• Advanced filters by status, priority, assignee, industry</li>
                                                    <li>• Date range filtering for follow-ups and activities</li>
                                                    <li>• Score-based filtering for high-value contacts</li>
                                                    <li>• Save and reuse common search combinations</li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <h3 class="font-semibold text-gray-900 mb-3">📈 Analytics Dashboard</h3>
                                            <p class="text-gray-600 mb-3">
                                                Get insights into your contact management performance and identify opportunities.
                                            </p>
                                            <div class="bg-gray-50 rounded p-3">
                                                <h4 class="font-medium text-gray-800 mb-2">Available Metrics:</h4>
                                                <ul class="text-sm text-gray-600 space-y-1">
                                                    <li>• Contact distribution by status, industry, and priority</li>
                                                    <li>• Team performance and individual statistics</li>
                                                    <li>• Conversion rates and engagement trends</li>
                                                    <li>• Industry insights and opportunity identification</li>
                                                    <li>• Follow-up tracking and overdue alerts</li>
                                                </ul>
                                            </div>
                                        </div>

                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <h3 class="font-semibold text-gray-900 mb-3">⚡ Bulk Operations</h3>
                                            <p class="text-gray-600 mb-3">
                                                Efficiently manage multiple contacts at once with powerful bulk operations.
                                            </p>
                                            <div class="bg-gray-50 rounded p-3">
                                                <h4 class="font-medium text-gray-800 mb-2">Bulk Actions:</h4>
                                                <ul class="text-sm text-gray-600 space-y-1">
                                                    <li>• Update status, priority, or assignee for multiple contacts</li>
                                                    <li>• Generate email templates with personalized contact information</li>
                                                    <li>• Delete multiple contacts with confirmation</li>
                                                    <li>• Export selected contacts to CSV</li>
                                                    <li>• Set follow-up dates for multiple contacts</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Troubleshooting Tab -->
                            <div id="help-troubleshooting" class="help-tab-content hidden">
                                <div class="prose max-w-none">
                                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Troubleshooting Guide</h2>
                                    
                                    <div class="space-y-6">
                                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                            <h3 class="font-semibold text-red-900 mb-3">🔧 Common Issues</h3>
                                            
                                            <div class="space-y-4">
                                                <div>
                                                    <h4 class="font-medium text-red-800 mb-2">Connection Issues</h4>
                                                    <div class="text-sm text-red-700 space-y-1">
                                                        <p><strong>Problem:</strong> "Connection failed" or sync errors</p>
                                                        <p><strong>Solutions:</strong></p>
                                                        <ul class="ml-4 space-y-1">
                                                            <li>• Check your Google Apps Script URL in the Setup modal</li>
                                                            <li>• Ensure the Google Apps Script is deployed as a web app</li>
                                                            <li>• Verify the script has "Anyone" access permissions</li>
                                                            <li>• Check browser console for detailed error messages</li>
                                                        </ul>
                                                    </div>
                                                </div>

                                                <div>
                                                    <h4 class="font-medium text-red-800 mb-2">Performance Issues</h4>
                                                    <div class="text-sm text-red-700 space-y-1">
                                                        <p><strong>Problem:</strong> Slow loading or unresponsive interface</p>
                                                        <p><strong>Solutions:</strong></p>
                                                        <ul class="ml-4 space-y-1">
                                                            <li>• Large dataset optimizations are automatically enabled for 1000+ contacts</li>
                                                            <li>• Clear browser cache and local storage if needed</li>
                                                            <li>• Use pagination and filters to reduce displayed data</li>
                                                            <li>• Check the Performance tab in this help for more details</li>
                                                        </ul>
                                                    </div>
                                                </div>

                                                <div>
                                                    <h4 class="font-medium text-red-800 mb-2">Data Issues</h4>
                                                    <div class="text-sm text-red-700 space-y-1">
                                                        <p><strong>Problem:</strong> Missing or corrupted contact data</p>
                                                        <p><strong>Solutions:</strong></p>
                                                        <ul class="ml-4 space-y-1">
                                                            <li>• Run data integrity checks from the Performance tab</li>
                                                            <li>• Use the auto-fix feature for common data issues</li>
                                                            <li>• Export data as backup before making major changes</li>
                                                            <li>• Re-sync with Google Sheets to restore from backup</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                            <h3 class="font-semibold text-blue-900 mb-3">🛠️ Advanced Troubleshooting</h3>
                                            
                                            <div class="space-y-3">
                                                <div>
                                                    <h4 class="font-medium text-blue-800 mb-2">Browser Console</h4>
                                                    <p class="text-sm text-blue-700">
                                                        Press F12 to open developer tools and check the Console tab for detailed error messages.
                                                        Look for red error messages that can help identify the specific issue.
                                                    </p>
                                                </div>

                                                <div>
                                                    <h4 class="font-medium text-blue-800 mb-2">Local Storage</h4>
                                                    <p class="text-sm text-blue-700">
                                                        The app stores data locally in your browser. If you experience issues, you can clear local storage
                                                        from the browser settings or developer tools (Application > Local Storage).
                                                    </p>
                                                </div>

                                                <div>
                                                    <h4 class="font-medium text-blue-800 mb-2">Google Apps Script Logs</h4>
                                                    <p class="text-sm text-blue-700">
                                                        Check the Google Apps Script editor's execution log for server-side errors.
                                                        Go to script.google.com, open your project, and check the execution history.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Tab -->
                            <div id="help-performance" class="help-tab-content hidden">
                                <div class="prose max-w-none">
                                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Performance & Data Integrity</h2>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                        <!-- Performance Metrics -->
                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <h3 class="font-semibold text-gray-900 mb-3">📊 Performance Metrics</h3>
                                            <div id="performance-metrics" class="space-y-2 text-sm">
                                                <!-- Metrics will be populated here -->
                                            </div>
                                            <button onclick="updatePerformanceMetrics()" 
                                                class="mt-3 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                                Refresh Metrics
                                            </button>
                                        </div>

                                        <!-- Data Integrity -->
                                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                                            <h3 class="font-semibold text-gray-900 mb-3">🔍 Data Integrity</h3>
                                            <div id="integrity-status" class="space-y-2 text-sm mb-3">
                                                <p class="text-gray-600">Click "Run Integrity Check" to scan for data issues.</p>
                                            </div>
                                            <div class="space-x-2">
                                                <button onclick="runIntegrityCheck()" 
                                                    class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                                    Run Integrity Check
                                                </button>
                                                <button onclick="autoFixDataIssues()" 
                                                    class="px-3 py-1 bg-orange-600 text-white text-xs rounded hover:bg-orange-700">
                                                    Auto-Fix Issues
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                        <h3 class="font-semibold text-gray-900 mb-3">⚡ Performance Optimizations</h3>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <h4 class="font-medium text-gray-800 mb-2">Automatic Optimizations</h4>
                                                <ul class="text-sm text-gray-600 space-y-1">
                                                    <li>• Large dataset detection (1000+ contacts)</li>
                                                    <li>• Dynamic pagination sizing</li>
                                                    <li>• Search and render debouncing</li>
                                                    <li>• Virtual scrolling on mobile</li>
                                                    <li>• Memory usage monitoring</li>
                                                </ul>
                                            </div>
                                            
                                            <div>
                                                <h4 class="font-medium text-gray-800 mb-2">Manual Optimizations</h4>
                                                <ul class="text-sm text-gray-600 space-y-1">
                                                    <li>• Use filters to reduce displayed data</li>
                                                    <li>• Regular data integrity checks</li>
                                                    <li>• Clear browser cache periodically</li>
                                                    <li>• Export/import for data cleanup</li>
                                                    <li>• Keyboard shortcuts for efficiency</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-500">
                                GSG Contact Manager v1.0.0 | Press F1 for quick access
                            </div>
                            <button type="button" onclick="closeHelpModal()"
                                class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Search Modal -->
    <div id="save-search-modal" class="fixed inset-0 z-50 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Save Search & Filters
                            </h3>
                            <div class="mt-4">
                                <label for="search-preset-name" class="block text-sm font-medium text-gray-700 mb-2">
                                    Search Name
                                </label>
                                <input type="text" id="search-preset-name" 
                                    class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    placeholder="Enter a name for this search...">
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Current Search & Filters Summary
                                    </label>
                                    <div id="search-summary" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-md max-h-32 overflow-y-auto">
                                        <!-- Summary will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="confirm-save-search-btn"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Save Search
                    </button>
                    <button type="button" id="cancel-save-search-btn"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript embedded inline -->
    <script>
        // ============================================
        // APPLICATION STATE
        // ============================================
        let contacts = [];
        let activities = [];
        let filteredContacts = [];
        let currentSort = { field: 'name', direction: 'asc' };
        let selectedContacts = new Set();
        let isEditMode = false;
        let currentEditId = null;

        // Pagination variables
        let currentPage = 1;
        
        // Advanced search state
        let savedSearches = [];
        let searchRelevanceScores = new Map();
        
        /**
         * Highlight search terms in text
         * Requirements: 4.5
         */
        function highlightSearchTerms(text, searchTerms) {
            if (!text || !searchTerms || searchTerms.length === 0) {
                return text;
            }
            
            let highlightedText = text;
            searchTerms.forEach(term => {
                if (term && term.length > 0) {
                    const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
                }
            });
            
            return highlightedText;
        }
        
        /**
         * Get all active search terms for highlighting
         * Requirements: 4.5
         */
        function getActiveSearchTerms() {
            const terms = [];
            
            // Basic search
            const searchTerm = document.getElementById('search-input').value.trim();
            if (searchTerm) {
                terms.push(searchTerm);
            }
            
            // Multi-field searches
            const searchName = document.getElementById('search-name')?.value.trim();
            const searchCompany = document.getElementById('search-company')?.value.trim();
            const searchTitle = document.getElementById('search-title')?.value.trim();
            const searchEmail = document.getElementById('search-email')?.value.trim();
            const searchIndustry = document.getElementById('search-industry')?.value.trim();
            const searchNotes = document.getElementById('search-notes')?.value.trim();
            
            if (searchName) terms.push(searchName);
            if (searchCompany) terms.push(searchCompany);
            if (searchTitle) terms.push(searchTitle);
            if (searchEmail) terms.push(searchEmail);
            if (searchIndustry) terms.push(searchIndustry);
            if (searchNotes) terms.push(searchNotes);
            
            return terms.filter(term => term.length > 0);
        }
        let itemsPerPage = 25;
        let totalPages = 1;
        
        // Performance optimization variables
        let isLargeDataset = false;
        let virtualScrollEnabled = false;
        let searchDebounceTimer = null;
        let renderDebounceTimer = null;
        
        // Keyboard shortcuts state
        let keyboardShortcutsEnabled = true;
        let helpModalVisible = false;

        // ============================================
        // PERFORMANCE OPTIMIZATION ENGINE
        // ============================================
        
        /**
         * Performance optimization for large datasets
         * Requirements: All requirements integration testing
         */
        class PerformanceOptimizer {
            constructor() {
                this.performanceMetrics = {
                    renderTime: 0,
                    searchTime: 0,
                    memoryUsage: 0
                };
            }
            
            /**
             * Check if dataset is large and enable optimizations
             */
            checkDatasetSize() {
                const contactCount = contacts.length;
                isLargeDataset = contactCount >= 1000;
                
                if (isLargeDataset) {
                    this.enableLargeDatasetOptimizations();
                    showNotification(`Large dataset detected (${contactCount} contacts). Performance optimizations enabled.`, 'info');
                } else {
                    this.disableLargeDatasetOptimizations();
                }
                
                this.updateStorageUsageIndicator();
            }
            
            /**
             * Enable optimizations for large datasets
             */
            enableLargeDatasetOptimizations() {
                // Increase pagination size for better performance
                itemsPerPage = Math.min(50, Math.max(25, Math.ceil(contacts.length / 20)));
                
                // Enable virtual scrolling for mobile
                virtualScrollEnabled = true;
                
                // Reduce search debounce time
                this.searchDebounceTime = 500;
                
                // Enable render debouncing
                this.renderDebounceTime = 100;
                
                console.log('Large dataset optimizations enabled:', {
                    itemsPerPage,
                    virtualScrollEnabled,
                    searchDebounceTime: this.searchDebounceTime,
                    renderDebounceTime: this.renderDebounceTime
                });
            }
            
            /**
             * Disable optimizations for smaller datasets
             */
            disableLargeDatasetOptimizations() {
                itemsPerPage = 25;
                virtualScrollEnabled = false;
                this.searchDebounceTime = 300;
                this.renderDebounceTime = 50;
            }
            
            /**
             * Debounced search function
             */
            debouncedSearch(callback, delay = null) {
                const debounceTime = delay || this.searchDebounceTime || 300;
                
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => {
                    const startTime = performance.now();
                    callback();
                    this.performanceMetrics.searchTime = performance.now() - startTime;
                }, debounceTime);
            }
            
            /**
             * Debounced render function
             */
            debouncedRender(callback, delay = null) {
                const debounceTime = delay || this.renderDebounceTime || 50;
                
                clearTimeout(renderDebounceTimer);
                renderDebounceTimer = setTimeout(() => {
                    const startTime = performance.now();
                    callback();
                    this.performanceMetrics.renderTime = performance.now() - startTime;
                }, debounceTime);
            }
            
            /**
             * Update storage usage indicator
             */
            updateStorageUsageIndicator() {
                try {
                    const used = JSON.stringify(localStorage).length;
                    const quota = 5 * 1024 * 1024; // 5MB typical quota
                    const percentage = Math.round((used / quota) * 100);
                    
                    const indicator = document.getElementById('storage-usage-indicator');
                    if (indicator) {
                        indicator.textContent = `Storage: ${percentage}%`;
                        indicator.title = `Local storage usage: ${(used / 1024).toFixed(1)}KB / ${(quota / 1024).toFixed(0)}KB`;
                        
                        // Color code based on usage
                        indicator.className = 'ml-2 text-xs';
                        if (percentage > 80) {
                            indicator.className += ' text-red-500';
                        } else if (percentage > 60) {
                            indicator.className += ' text-yellow-500';
                        } else {
                            indicator.className += ' text-gray-500';
                        }
                    }
                    
                    this.performanceMetrics.memoryUsage = used;
                } catch (error) {
                    console.warn('Could not calculate storage usage:', error);
                }
            }
            
            /**
             * Get performance metrics
             */
            getPerformanceMetrics() {
                return {
                    ...this.performanceMetrics,
                    contactCount: contacts.length,
                    isLargeDataset,
                    virtualScrollEnabled,
                    itemsPerPage
                };
            }
            
            /**
             * Optimize contact rendering for large datasets
             */
            optimizeContactRendering(contactsToRender) {
                if (!isLargeDataset) {
                    return contactsToRender;
                }
                
                // For large datasets, only render visible items plus buffer
                const bufferSize = 10;
                const startIndex = Math.max(0, (currentPage - 1) * itemsPerPage - bufferSize);
                const endIndex = Math.min(contactsToRender.length, currentPage * itemsPerPage + bufferSize);
                
                return contactsToRender.slice(startIndex, endIndex);
            }
        }
        
        // Initialize performance optimizer
        const performanceOptimizer = new PerformanceOptimizer();

        // ============================================
        // KEYBOARD SHORTCUTS SYSTEM
        // ============================================
        
        /**
         * Keyboard shortcuts for power users
         * Requirements: All requirements integration testing
         */
        class KeyboardShortcutManager {
            constructor() {
                this.shortcuts = new Map();
                this.setupDefaultShortcuts();
                this.bindEventListeners();
            }
            
            /**
             * Setup default keyboard shortcuts
             */
            setupDefaultShortcuts() {
                // Contact management shortcuts
                this.shortcuts.set('ctrl+n', { action: 'addContact', description: 'Add new contact' });
                this.shortcuts.set('ctrl+f', { action: 'focusSearch', description: 'Focus search box' });
                this.shortcuts.set('ctrl+e', { action: 'exportContacts', description: 'Export contacts' });
                this.shortcuts.set('ctrl+i', { action: 'importContacts', description: 'Import contacts' });
                this.shortcuts.set('ctrl+s', { action: 'syncContacts', description: 'Sync with Google Sheets' });
                
                // Navigation shortcuts
                this.shortcuts.set('ctrl+1', { action: 'switchToContacts', description: 'Switch to Contacts tab' });
                this.shortcuts.set('ctrl+2', { action: 'switchToAnalytics', description: 'Switch to Analytics tab' });
                this.shortcuts.set('ctrl+3', { action: 'switchToDashboard', description: 'Switch to Dashboard tab' });
                
                // Table navigation
                this.shortcuts.set('ctrl+arrowleft', { action: 'previousPage', description: 'Previous page' });
                this.shortcuts.set('ctrl+arrowright', { action: 'nextPage', description: 'Next page' });
                this.shortcuts.set('ctrl+home', { action: 'firstPage', description: 'First page' });
                this.shortcuts.set('ctrl+end', { action: 'lastPage', description: 'Last page' });
                
                // Selection shortcuts
                this.shortcuts.set('ctrl+a', { action: 'selectAll', description: 'Select all visible contacts' });
                this.shortcuts.set('ctrl+d', { action: 'deselectAll', description: 'Deselect all contacts' });
                this.shortcuts.set('delete', { action: 'deleteSelected', description: 'Delete selected contacts' });
                
                // Filter shortcuts
                this.shortcuts.set('ctrl+h', { action: 'showHighPriority', description: 'Show high-priority contacts' });
                this.shortcuts.set('ctrl+shift+h', { action: 'showHighScore', description: 'Show high-scoring contacts (80-100)' });
                this.shortcuts.set('ctrl+r', { action: 'clearFilters', description: 'Clear all filters' });
                
                // Utility shortcuts
                this.shortcuts.set('f1', { action: 'showHelp', description: 'Show help and shortcuts' });
                this.shortcuts.set('escape', { action: 'closeModal', description: 'Close modal or cancel action' });
                this.shortcuts.set('ctrl+/', { action: 'toggleShortcuts', description: 'Toggle keyboard shortcuts' });
            }
            
            /**
             * Bind keyboard event listeners
             */
            bindEventListeners() {
                document.addEventListener('keydown', (event) => {
                    if (!keyboardShortcutsEnabled) return;
                    
                    // Don't trigger shortcuts when typing in inputs
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.contentEditable === 'true') {
                        // Allow escape to work in inputs
                        if (event.key === 'Escape') {
                            this.executeShortcut('escape');
                        }
                        return;
                    }
                    
                    const shortcutKey = this.getShortcutKey(event);
                    if (this.shortcuts.has(shortcutKey)) {
                        event.preventDefault();
                        this.executeShortcut(shortcutKey);
                    }
                });
            }
            
            /**
             * Get shortcut key string from event
             */
            getShortcutKey(event) {
                const parts = [];
                
                if (event.ctrlKey) parts.push('ctrl');
                if (event.altKey) parts.push('alt');
                if (event.shiftKey) parts.push('shift');
                
                const key = event.key.toLowerCase();
                if (key.startsWith('arrow')) {
                    parts.push(key);
                } else if (key === ' ') {
                    parts.push('space');
                } else {
                    parts.push(key);
                }
                
                return parts.join('+');
            }
            
            /**
             * Execute shortcut action
             */
            executeShortcut(shortcutKey) {
                const shortcut = this.shortcuts.get(shortcutKey);
                if (!shortcut) return;
                
                try {
                    switch (shortcut.action) {
                        case 'addContact':
                            document.getElementById('add-contact-btn').click();
                            break;
                        case 'focusSearch':
                            document.getElementById('search-input').focus();
                            break;
                        case 'exportContacts':
                            document.getElementById('export-contacts-btn').click();
                            break;
                        case 'importContacts':
                            document.getElementById('import-contacts-btn').click();
                            break;
                        case 'syncContacts':
                            document.getElementById('sync-btn').click();
                            break;
                        case 'switchToContacts':
                            switchMainTab('contacts');
                            break;
                        case 'switchToAnalytics':
                            switchMainTab('analytics');
                            break;
                        case 'switchToDashboard':
                            switchMainTab('dashboard');
                            break;
                        case 'previousPage':
                            if (currentPage > 1) {
                                currentPage--;
                                renderContactsTable();
                            }
                            break;
                        case 'nextPage':
                            if (currentPage < totalPages) {
                                currentPage++;
                                renderContactsTable();
                            }
                            break;
                        case 'firstPage':
                            currentPage = 1;
                            renderContactsTable();
                            break;
                        case 'lastPage':
                            currentPage = totalPages;
                            renderContactsTable();
                            break;
                        case 'selectAll':
                            this.selectAllVisible();
                            break;
                        case 'deselectAll':
                            selectedContacts.clear();
                            updateCheckboxStates();
                            updateBulkActionsVisibility();
                            break;
                        case 'deleteSelected':
                            if (selectedContacts.size > 0) {
                                bulkDeleteContacts();
                            }
                            break;
                        case 'showHelp':
                            showHelpModal();
                            break;
                        case 'closeModal':
                            this.closeActiveModal();
                            break;
                        case 'toggleShortcuts':
                            this.toggleShortcuts();
                            break;
                        case 'showHighPriority':
                            showHighPriorityContacts();
                            break;
                        case 'showHighScore':
                            showHighScoreContacts();
                            break;
                        case 'clearFilters':
                            clearAllFilters();
                            break;
                    }
                } catch (error) {
                    console.error('Error executing shortcut:', shortcut.action, error);
                }
            }
            
            /**
             * Select all visible contacts
             */
            selectAllVisible() {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, filteredContacts.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    selectedContacts.add(filteredContacts[i].id);
                }
                
                updateCheckboxStates();
                updateBulkActionsVisibility();
            }
            
            /**
             * Close active modal
             */
            closeActiveModal() {
                // Close contact modal
                const contactModal = document.getElementById('contact-modal');
                if (contactModal && !contactModal.classList.contains('hidden')) {
                    closeContactModal();
                    return;
                }
                
                // Close setup modal
                const setupModal = document.getElementById('setup-modal');
                if (setupModal && !setupModal.classList.contains('hidden')) {
                    closeSetupModal();
                    return;
                }
                
                // Close help modal
                const helpModal = document.getElementById('help-modal');
                if (helpModal && !helpModal.classList.contains('hidden')) {
                    closeHelpModal();
                    return;
                }
                
                // Close import modal
                const importModal = document.getElementById('import-modal');
                if (importModal && !importModal.classList.contains('hidden')) {
                    closeImportModal();
                    return;
                }
            }
            
            /**
             * Toggle keyboard shortcuts on/off
             */
            toggleShortcuts() {
                keyboardShortcutsEnabled = !keyboardShortcutsEnabled;
                showNotification(
                    `Keyboard shortcuts ${keyboardShortcutsEnabled ? 'enabled' : 'disabled'}`,
                    keyboardShortcutsEnabled ? 'success' : 'info'
                );
            }
            
            /**
             * Get all shortcuts for help display
             */
            getAllShortcuts() {
                return Array.from(this.shortcuts.entries()).map(([key, shortcut]) => ({
                    key: key.replace(/ctrl/g, 'Ctrl').replace(/alt/g, 'Alt').replace(/shift/g, 'Shift').replace(/arrow/g, 'Arrow '),
                    description: shortcut.description
                }));
            }
        }
        
        // Initialize keyboard shortcuts
        const keyboardManager = new KeyboardShortcutManager();

        // ============================================
        // DATA VALIDATION AND INTEGRITY SYSTEM
        // ============================================
        
        /**
         * Enhanced data validation and integrity checks
         * Requirements: All requirements integration testing
         */
        class DataIntegrityManager {
            constructor() {
                this.validationRules = this.setupValidationRules();
                this.integrityChecks = [];
            }
            
            /**
             * Setup comprehensive validation rules
             */
            setupValidationRules() {
                return {
                    contact: {
                        name: {
                            required: true,
                            minLength: 2,
                            maxLength: 100,
                            pattern: /^[a-zA-Z\s\-'\.]+$/,
                            message: 'Name must be 2-100 characters and contain only letters, spaces, hyphens, apostrophes, and periods'
                        },
                        email: {
                            required: true,
                            pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                            message: 'Please enter a valid email address'
                        },
                        phone: {
                            required: false,
                            pattern: /^[\+]?[1-9][\d]{0,15}$/,
                            message: 'Please enter a valid phone number'
                        },
                        linkedin: {
                            required: false,
                            pattern: /^https?:\/\/(www\.)?linkedin\.com\/in\/[a-zA-Z0-9\-]+\/?$/,
                            message: 'Please enter a valid LinkedIn profile URL'
                        },
                        company: {
                            required: false,
                            maxLength: 200,
                            message: 'Company name must be less than 200 characters'
                        },
                        title: {
                            required: false,
                            maxLength: 150,
                            message: 'Title must be less than 150 characters'
                        },
                        industry: {
                            required: false,
                            maxLength: 100,
                            message: 'Industry must be less than 100 characters'
                        }
                    },
                    activity: {
                        type: {
                            required: true,
                            enum: CONFIG.ACTIVITY_TYPES,
                            message: 'Please select a valid activity type'
                        },
                        notes: {
                            required: true,
                            minLength: 5,
                            maxLength: 1000,
                            message: 'Notes must be 5-1000 characters'
                        },
                        date: {
                            required: true,
                            type: 'date',
                            message: 'Please enter a valid date'
                        }
                    }
                };
            }
            
            /**
             * Validate contact data with enhanced rules
             */
            validateContact(contactData) {
                const errors = [];
                const rules = this.validationRules.contact;
                
                for (const [field, rule] of Object.entries(rules)) {
                    const value = contactData[field];
                    
                    // Check required fields
                    if (rule.required && (!value || value.toString().trim() === '')) {
                        errors.push(`${field.charAt(0).toUpperCase() + field.slice(1)} is required`);
                        continue;
                    }
                    
                    // Skip validation if field is empty and not required
                    if (!value || value.toString().trim() === '') continue;
                    
                    const stringValue = value.toString().trim();
                    
                    // Check length constraints
                    if (rule.minLength && stringValue.length < rule.minLength) {
                        errors.push(`${field.charAt(0).toUpperCase() + field.slice(1)} must be at least ${rule.minLength} characters`);
                    }
                    
                    if (rule.maxLength && stringValue.length > rule.maxLength) {
                        errors.push(`${field.charAt(0).toUpperCase() + field.slice(1)} must be less than ${rule.maxLength} characters`);
                    }
                    
                    // Check pattern matching
                    if (rule.pattern && !rule.pattern.test(stringValue)) {
                        errors.push(rule.message || `${field.charAt(0).toUpperCase() + field.slice(1)} format is invalid`);
                    }
                    
                    // Check enum values
                    if (rule.enum && !rule.enum.includes(stringValue)) {
                        errors.push(`${field.charAt(0).toUpperCase() + field.slice(1)} must be one of: ${rule.enum.join(', ')}`);
                    }
                }
                
                // Additional business logic validations
                this.validateBusinessRules(contactData, errors);
                
                return {
                    isValid: errors.length === 0,
                    errors,
                    sanitizedData: this.sanitizeContactData(contactData)
                };
            }
            
            /**
             * Validate business rules
             */
            validateBusinessRules(contactData, errors) {
                // Check for duplicate emails
                const existingContact = contacts.find(c => 
                    c.id !== contactData.id && 
                    c.email && 
                    contactData.email && 
                    c.email.toLowerCase() === contactData.email.toLowerCase()
                );
                
                if (existingContact) {
                    errors.push(`A contact with email "${contactData.email}" already exists`);
                }
                
                // Validate follow-up date is in the future (if provided)
                if (contactData.nextFollowUp) {
                    const followUpDate = new Date(contactData.nextFollowUp);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (followUpDate < today) {
                        errors.push('Follow-up date should be in the future');
                    }
                }
                
                // Validate score is within range
                if (contactData.score !== undefined && (contactData.score < 0 || contactData.score > 100)) {
                    errors.push('Score must be between 0 and 100');
                }
            }
            
            /**
             * Sanitize contact data
             */
            sanitizeContactData(contactData) {
                const sanitized = { ...contactData };
                
                // Trim string fields
                const stringFields = ['name', 'email', 'phone', 'linkedin', 'company', 'title', 'industry', 'notes'];
                stringFields.forEach(field => {
                    if (sanitized[field] && typeof sanitized[field] === 'string') {
                        sanitized[field] = sanitized[field].trim();
                    }
                });
                
                // Normalize email
                if (sanitized.email) {
                    sanitized.email = sanitized.email.toLowerCase();
                }
                
                // Normalize LinkedIn URL
                if (sanitized.linkedin && !sanitized.linkedin.startsWith('http')) {
                    sanitized.linkedin = 'https://' + sanitized.linkedin;
                }
                
                // Ensure dates are properly formatted
                if (sanitized.nextFollowUp) {
                    sanitized.nextFollowUp = new Date(sanitized.nextFollowUp).toISOString().split('T')[0];
                }
                
                return sanitized;
            }
            
            /**
             * Run comprehensive data integrity checks
             */
            runIntegrityChecks() {
                const issues = [];
                
                // Check for duplicate contacts
                const duplicates = this.findDuplicateContacts();
                if (duplicates.length > 0) {
                    issues.push({
                        type: 'duplicates',
                        severity: 'warning',
                        message: `Found ${duplicates.length} potential duplicate contacts`,
                        data: duplicates
                    });
                }
                
                // Check for invalid data
                const invalidContacts = this.findInvalidContacts();
                if (invalidContacts.length > 0) {
                    issues.push({
                        type: 'invalid_data',
                        severity: 'error',
                        message: `Found ${invalidContacts.length} contacts with invalid data`,
                        data: invalidContacts
                    });
                }
                
                // Check for orphaned activities
                const orphanedActivities = this.findOrphanedActivities();
                if (orphanedActivities.length > 0) {
                    issues.push({
                        type: 'orphaned_activities',
                        severity: 'warning',
                        message: `Found ${orphanedActivities.length} activities without valid contacts`,
                        data: orphanedActivities
                    });
                }
                
                // Check data consistency
                const consistencyIssues = this.checkDataConsistency();
                if (consistencyIssues.length > 0) {
                    issues.push(...consistencyIssues);
                }
                
                return issues;
            }
            
            /**
             * Find duplicate contacts
             */
            findDuplicateContacts() {
                const duplicates = [];
                const emailMap = new Map();
                
                contacts.forEach(contact => {
                    if (contact.email) {
                        const email = contact.email.toLowerCase();
                        if (emailMap.has(email)) {
                            duplicates.push({
                                original: emailMap.get(email),
                                duplicate: contact,
                                reason: 'Same email address'
                            });
                        } else {
                            emailMap.set(email, contact);
                        }
                    }
                });
                
                return duplicates;
            }
            
            /**
             * Find contacts with invalid data
             */
            findInvalidContacts() {
                const invalid = [];
                
                contacts.forEach(contact => {
                    const validation = this.validateContact(contact);
                    if (!validation.isValid) {
                        invalid.push({
                            contact,
                            errors: validation.errors
                        });
                    }
                });
                
                return invalid;
            }
            
            /**
             * Find orphaned activities
             */
            findOrphanedActivities() {
                const orphaned = [];
                const contactIds = new Set(contacts.map(c => c.id));
                
                activities.forEach(activity => {
                    if (!contactIds.has(activity.contactId)) {
                        orphaned.push(activity);
                    }
                });
                
                return orphaned;
            }
            
            /**
             * Check data consistency
             */
            checkDataConsistency() {
                const issues = [];
                
                // Check for contacts without required fields
                const missingRequired = contacts.filter(c => !c.name || !c.email);
                if (missingRequired.length > 0) {
                    issues.push({
                        type: 'missing_required',
                        severity: 'error',
                        message: `${missingRequired.length} contacts missing required fields`,
                        data: missingRequired
                    });
                }
                
                // Check for future dates in the past
                const outdatedFollowUps = contacts.filter(c => {
                    if (!c.nextFollowUp) return false;
                    const followUpDate = new Date(c.nextFollowUp);
                    const today = new Date();
                    return followUpDate < today;
                });
                
                if (outdatedFollowUps.length > 0) {
                    issues.push({
                        type: 'outdated_followups',
                        severity: 'info',
                        message: `${outdatedFollowUps.length} contacts have overdue follow-ups`,
                        data: outdatedFollowUps
                    });
                }
                
                return issues;
            }
            
            /**
             * Auto-fix common data issues
             */
            autoFixIssues(issues) {
                let fixedCount = 0;
                
                issues.forEach(issue => {
                    switch (issue.type) {
                        case 'orphaned_activities':
                            // Remove orphaned activities
                            issue.data.forEach(activity => {
                                const index = activities.findIndex(a => a.id === activity.id);
                                if (index !== -1) {
                                    activities.splice(index, 1);
                                    fixedCount++;
                                }
                            });
                            break;
                            
                        case 'invalid_data':
                            // Try to sanitize invalid data
                            issue.data.forEach(({ contact }) => {
                                const validation = this.validateContact(contact);
                                if (validation.sanitizedData) {
                                    Object.assign(contact, validation.sanitizedData);
                                    fixedCount++;
                                }
                            });
                            break;
                    }
                });
                
                if (fixedCount > 0) {
                    saveContactsToLocalStorage();
                    showNotification(`Auto-fixed ${fixedCount} data issues`, 'success');
                }
                
                return fixedCount;
            }
        }
        
        // Initialize data integrity manager
        const dataIntegrityManager = new DataIntegrityManager();

        // ============================================
        // ANALYTICS ENGINE
        // ============================================
        class AnalyticsEngine {
            constructor() {
                this.metrics = {};
            }

            /**
             * Generate comprehensive dashboard metrics
             * Requirements: 10.1, 10.2, 10.3, 10.4, 10.5
             */
            generateDashboardMetrics() {
                const totalContacts = contacts.length;
                if (totalContacts === 0) {
                    return this.getEmptyMetrics();
                }

                // Basic metrics
                const conversionRate = this.calculateConversionRate();
                const averageScore = this.calculateAverageScore();
                const avgDaysToContact = this.calculateAverageDaysToContact();
                const activeTeamMembers = this.getActiveTeamMembers();

                // Distribution metrics
                const statusDistribution = this.getStatusDistribution();
                const priorityDistribution = this.getPriorityDistribution();
                const industryInsights = this.getIndustryInsights();
                const teamPerformance = this.getTeamPerformance();
                const trendAnalysis = this.getTrendAnalysis();
                const actionableInsights = this.generateActionableInsights();

                return {
                    conversionRate,
                    averageScore,
                    avgDaysToContact,
                    activeTeamMembers,
                    statusDistribution,
                    priorityDistribution,
                    industryInsights,
                    teamPerformance,
                    trendAnalysis,
                    actionableInsights
                };
            }

            /**
             * Calculate conversion rate from new to converted contacts
             */
            calculateConversionRate() {
                const newContacts = contacts.filter(c => c.status === 'New').length;
                const convertedContacts = contacts.filter(c => c.status === 'Converted').length;
                const totalProcessed = newContacts + convertedContacts + 
                    contacts.filter(c => ['Contacted', 'Qualified', 'Inactive'].includes(c.status)).length;
                
                return totalProcessed > 0 ? Math.round((convertedContacts / totalProcessed) * 100) : 0;
            }

            /**
             * Calculate average contact score
             */
            calculateAverageScore() {
                if (contacts.length === 0) return 0;
                const totalScore = contacts.reduce((sum, contact) => sum + (contact.score || 0), 0);
                return Math.round(totalScore / contacts.length);
            }

            /**
             * Calculate average days from contact creation to first contact
             */
            calculateAverageDaysToContact() {
                const contactedContacts = contacts.filter(c => c.lastContacted && c.dateAdded);
                if (contactedContacts.length === 0) return 0;

                const totalDays = contactedContacts.reduce((sum, contact) => {
                    const added = new Date(contact.dateAdded);
                    const contacted = new Date(contact.lastContacted);
                    const days = Math.max(0, Math.floor((contacted - added) / (1000 * 60 * 60 * 24)));
                    return sum + days;
                }, 0);

                return Math.round(totalDays / contactedContacts.length);
            }

            /**
             * Get count of active team members
             */
            getActiveTeamMembers() {
                const assignees = new Set(contacts.filter(c => c.assignee).map(c => c.assignee));
                return assignees.size;
            }

            /**
             * Get status distribution with percentages
             */
            getStatusDistribution() {
                const statusCounts = {};
                CONFIG.CONTACT_STATUSES.forEach(status => {
                    statusCounts[status] = contacts.filter(c => c.status === status).length;
                });

                const total = contacts.length;
                return Object.entries(statusCounts).map(([status, count]) => ({
                    status,
                    count,
                    percentage: total > 0 ? Math.round((count / total) * 100) : 0
                }));
            }

            /**
             * Get priority distribution with percentages
             */
            getPriorityDistribution() {
                const priorityCounts = {};
                CONFIG.PRIORITY_LEVELS.forEach(priority => {
                    priorityCounts[priority] = contacts.filter(c => c.priority === priority).length;
                });

                const total = contacts.length;
                return Object.entries(priorityCounts).map(([priority, count]) => ({
                    priority,
                    count,
                    percentage: total > 0 ? Math.round((count / total) * 100) : 0
                }));
            }

            /**
             * Get industry insights with conversion rates
             */
            getIndustryInsights() {
                const industryData = {};
                
                contacts.forEach(contact => {
                    const industry = contact.industry || 'Unknown';
                    if (!industryData[industry]) {
                        industryData[industry] = {
                            total: 0,
                            converted: 0,
                            avgScore: 0,
                            totalScore: 0
                        };
                    }
                    
                    industryData[industry].total++;
                    industryData[industry].totalScore += contact.score || 0;
                    
                    if (contact.status === 'Converted') {
                        industryData[industry].converted++;
                    }
                });

                return Object.entries(industryData)
                    .map(([industry, data]) => ({
                        industry,
                        total: data.total,
                        converted: data.converted,
                        conversionRate: data.total > 0 ? Math.round((data.converted / data.total) * 100) : 0,
                        avgScore: data.total > 0 ? Math.round(data.totalScore / data.total) : 0
                    }))
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 10); // Top 10 industries
            }

            /**
             * Get team performance statistics
             */
            getTeamPerformance() {
                const teamData = {};
                
                CONFIG.TEAM_MEMBERS.forEach(member => {
                    teamData[member] = {
                        assigned: 0,
                        converted: 0,
                        avgScore: 0,
                        totalScore: 0,
                        recentActivity: 0
                    };
                });

                contacts.forEach(contact => {
                    const assignee = contact.assignee || 'Unassigned';
                    if (teamData[assignee]) {
                        teamData[assignee].assigned++;
                        teamData[assignee].totalScore += contact.score || 0;
                        
                        if (contact.status === 'Converted') {
                            teamData[assignee].converted++;
                        }

                        // Check for recent activity (last 30 days)
                        if (contact.lastContacted) {
                            const daysSinceContact = Math.floor((new Date() - new Date(contact.lastContacted)) / (1000 * 60 * 60 * 24));
                            if (daysSinceContact <= 30) {
                                teamData[assignee].recentActivity++;
                            }
                        }
                    }
                });

                return Object.entries(teamData)
                    .map(([member, data]) => ({
                        member,
                        assigned: data.assigned,
                        converted: data.converted,
                        conversionRate: data.assigned > 0 ? Math.round((data.converted / data.assigned) * 100) : 0,
                        avgScore: data.assigned > 0 ? Math.round(data.totalScore / data.assigned) : 0,
                        recentActivity: data.recentActivity
                    }))
                    .filter(member => member.assigned > 0)
                    .sort((a, b) => b.conversionRate - a.conversionRate);
            }

            /**
             * Get trend analysis for contact acquisition and engagement
             */
            getTrendAnalysis() {
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                const sixtyDaysAgo = new Date(now.getTime() - (60 * 24 * 60 * 60 * 1000));

                // Recent contacts (last 30 days)
                const recentContacts = contacts.filter(c => 
                    c.dateAdded && new Date(c.dateAdded) >= thirtyDaysAgo
                ).length;

                // Previous period contacts (30-60 days ago)
                const previousContacts = contacts.filter(c => 
                    c.dateAdded && 
                    new Date(c.dateAdded) >= sixtyDaysAgo && 
                    new Date(c.dateAdded) < thirtyDaysAgo
                ).length;

                // Recent activity
                const recentActivity = contacts.filter(c => 
                    c.lastContacted && new Date(c.lastContacted) >= thirtyDaysAgo
                ).length;

                // Calculate trends
                const contactTrend = previousContacts > 0 ? 
                    Math.round(((recentContacts - previousContacts) / previousContacts) * 100) : 0;

                return {
                    recentContacts,
                    previousContacts,
                    contactTrend,
                    recentActivity,
                    trendDirection: contactTrend > 0 ? 'up' : contactTrend < 0 ? 'down' : 'neutral'
                };
            }

            /**
             * Generate actionable insights based on data analysis
             */
            generateActionableInsights() {
                const insights = [];
                const metrics = this.generateDashboardMetrics();

                // High-priority contacts without follow-up
                const highPriorityNoFollowup = contacts.filter(c => 
                    c.priority === 'High' && !c.nextFollowUp
                ).length;

                if (highPriorityNoFollowup > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'High-Priority Contacts Need Follow-up',
                        message: `${highPriorityNoFollowup} high-priority contacts don't have follow-up dates set.`,
                        action: 'Set follow-up dates for high-priority contacts',
                        priority: 'high'
                    });
                }

                // Low conversion rate
                if (metrics.conversionRate < 10 && contacts.length > 10) {
                    insights.push({
                        type: 'danger',
                        title: 'Low Conversion Rate',
                        message: `Current conversion rate is ${metrics.conversionRate}%. Consider reviewing qualification criteria.`,
                        action: 'Review and improve qualification process',
                        priority: 'high'
                    });
                }

                // Unassigned contacts
                const unassignedContacts = contacts.filter(c => !c.assignee).length;
                if (unassignedContacts > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Unassigned Contacts',
                        message: `${unassignedContacts} contacts are not assigned to team members.`,
                        action: 'Assign contacts to team members for better accountability',
                        priority: 'medium'
                    });
                }

                // Top performing industry
                const topIndustry = metrics.industryInsights[0];
                if (topIndustry && topIndustry.conversionRate > 20) {
                    insights.push({
                        type: 'success',
                        title: 'High-Performing Industry',
                        message: `${topIndustry.industry} has a ${topIndustry.conversionRate}% conversion rate.`,
                        action: 'Focus more outreach efforts on this industry',
                        priority: 'low'
                    });
                }

                // Stale contacts (no activity in 60+ days)
                const staleContacts = contacts.filter(c => {
                    if (!c.lastContacted) return true;
                    const daysSinceContact = Math.floor((new Date() - new Date(c.lastContacted)) / (1000 * 60 * 60 * 24));
                    return daysSinceContact > 60;
                }).length;

                if (staleContacts > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Stale Contacts Need Attention',
                        message: `${staleContacts} contacts haven't been contacted in over 60 days.`,
                        action: 'Review and re-engage with stale contacts',
                        priority: 'medium'
                    });
                }

                return insights.sort((a, b) => {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                });
            }

            /**
             * Get empty metrics for when no data is available
             */
            getEmptyMetrics() {
                return {
                    conversionRate: 0,
                    averageScore: 0,
                    avgDaysToContact: 0,
                    activeTeamMembers: 0,
                    statusDistribution: CONFIG.CONTACT_STATUSES.map(status => ({ status, count: 0, percentage: 0 })),
                    priorityDistribution: CONFIG.PRIORITY_LEVELS.map(priority => ({ priority, count: 0, percentage: 0 })),
                    industryInsights: [],
                    teamPerformance: [],
                    trendAnalysis: { recentContacts: 0, previousContacts: 0, contactTrend: 0, recentActivity: 0, trendDirection: 'neutral' },
                    actionableInsights: []
                };
            }
        }

        // Initialize analytics engine
        const analyticsEngine = new AnalyticsEngine();

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });

        async function initializeApp() {
            console.log('Initializing GSG Contact Manager...');

            try {
                // Initialize offline support first
                initializeOfflineSupport();

                // Populate dropdown options
                populateDropdowns();

                // Set up event listeners
                setupEventListeners();

                // Initialize empty state
                contacts = [];
                activities = [];
                filteredContacts = [];
                selectedContacts = new Set();

                // Load activities from local storage
                loadActivitiesFromLocalStorage();
                
                // Load saved searches from local storage
                loadSavedSearches();

                // Update local storage status indicators
                updateLocalStorageStatus();
                
                // Initialize performance optimizations
                performanceOptimizer.updateStorageUsageIndicator();

                // Initialize activity form date to current time
                const activityDateInput = document.getElementById('activity-date');
                if (activityDateInput) {
                    const now = new Date();
                    activityDateInput.value = now.toISOString().slice(0, 16);
                }

                // Check configuration and validate connection
                const configValid = checkConfiguration();

                if (configValid) {
                    // Validate connection and load data if successful
                    const connectionValid = await validateConnection();

                    if (connectionValid) {
                        // Load initial data
                        await loadContacts();
                    } else {
                        // Load from local storage as fallback
                        loadContactsFromLocalStorage();
                        applyFilters();
                        updateDashboardStats();
                        showSetupModal();
                    }
                } else {
                    // Load from local storage as fallback
                    loadContactsFromLocalStorage();
                    applyFilters();
                    updateDashboardStats();
                }

                // Initialize main tabs (default to dashboard)
                switchMainTab('dashboard');

                console.log('App initialized successfully with', contacts.length, 'contacts');

            } catch (error) {
                console.error('Error during app initialization:', error);

                // Fallback initialization
                contacts = [];
                filteredContacts = [];
                selectedContacts = new Set();
                updateDashboardStats();
                renderContactsTable();

                showNotification('App initialized with limited functionality. Check your configuration.', 'warning');
            }
        }

        function populateDropdowns() {
            // Populate status options
            const statusSelects = document.querySelectorAll('#status-filter, #contact-status');
            statusSelects.forEach(select => {
                if (select.id === 'status-filter') {
                    select.innerHTML = '<option value="">All Statuses</option>';
                } else {
                    select.innerHTML = '';
                }
                CONFIG.CONTACT_STATUSES.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === 'New' && select.id === 'contact-status') {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });

            // Populate priority options
            const prioritySelects = document.querySelectorAll('#priority-filter, #contact-priority');
            prioritySelects.forEach(select => {
                if (select.id === 'priority-filter') {
                    select.innerHTML = '<option value="">All Priorities</option>';
                } else {
                    select.innerHTML = '';
                }
                CONFIG.PRIORITY_LEVELS.forEach(priority => {
                    const option = document.createElement('option');
                    option.value = priority;
                    option.textContent = priority;
                    if (priority === 'Medium' && select.id === 'contact-priority') {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });

            // Populate assignee options
            const assigneeSelects = document.querySelectorAll('#assignee-filter, #contact-assignee, #bulk-assignee-update');
            assigneeSelects.forEach(select => {
                if (select.id === 'assignee-filter') {
                    select.innerHTML = '<option value="">All Assignees</option>';
                } else if (select.id === 'contact-assignee') {
                    select.innerHTML = '<option value="">Unassigned</option>';
                } else if (select.id === 'bulk-assignee-update') {
                    select.innerHTML = '<option value="">Assign to...</option><option value="">Unassigned</option>';
                }
                CONFIG.TEAM_MEMBERS.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    select.appendChild(option);
                });
            });

            // Populate activity type options
            const activityTypeSelect = document.getElementById('activity-type');
            if (activityTypeSelect) {
                activityTypeSelect.innerHTML = '';
                CONFIG.ACTIVITY_TYPES.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    activityTypeSelect.appendChild(option);
                });
                // Set default to first option
                if (CONFIG.ACTIVITY_TYPES.length > 0) {
                    activityTypeSelect.value = CONFIG.ACTIVITY_TYPES[0];
                }
            }
        }

        function setupEventListeners() {
            // Modal controls
            document.getElementById('add-contact-btn').addEventListener('click', openAddContactModal);
            document.getElementById('import-contacts-btn').addEventListener('click', openImportModal);
            document.getElementById('export-contacts-btn').addEventListener('click', openExportModal);
            document.getElementById('cancel-modal').addEventListener('click', closeContactModal);
            document.getElementById('close-setup-modal').addEventListener('click', closeSetupModal);
            document.getElementById('close-bulk-email-modal').addEventListener('click', closeBulkEmailModal);
            document.getElementById('help-btn').addEventListener('click', showHelpModal);
            
            // Import/Export modal controls
            document.getElementById('cancel-import-btn').addEventListener('click', closeImportModal);
            document.getElementById('cancel-export-btn').addEventListener('click', closeExportModal);
            document.getElementById('import-file-input').addEventListener('change', handleFileSelect);
            document.getElementById('confirm-import-btn').addEventListener('click', handleImportConfirm);
            document.getElementById('confirm-export-btn').addEventListener('click', handleExportConfirm);

            // Form submission
            document.getElementById('contact-form').addEventListener('submit', handleContactSubmit);

            // Score management listeners
            setupScoreManagementListeners();

            // Search and filters
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.getElementById('status-filter').addEventListener('change', handleFilter);
            document.getElementById('assignee-filter').addEventListener('change', handleFilter);
            document.getElementById('priority-filter').addEventListener('change', handleFilter);
            document.getElementById('type-filter').addEventListener('change', handleFilter);
            document.getElementById('industry-filter').addEventListener('change', handleFilter);

            // Score filter (if exists)
            const scoreFilter = document.getElementById('score-filter');
            if (scoreFilter) {
                scoreFilter.addEventListener('change', handleFilter);
            }

            // Advanced filters
            document.getElementById('date-added-from').addEventListener('change', handleFilter);
            document.getElementById('date-added-to').addEventListener('change', handleFilter);
            document.getElementById('last-contacted-from').addEventListener('change', handleFilter);
            document.getElementById('last-contacted-to').addEventListener('change', handleFilter);
            document.getElementById('followup-filter').addEventListener('change', handleFilter);
            document.getElementById('linkedin-filter').addEventListener('change', handleFilter);
            document.getElementById('phone-filter').addEventListener('change', handleFilter);
            document.getElementById('score-min').addEventListener('input', handleFilter);
            document.getElementById('score-max').addEventListener('input', handleFilter);

            // Table sorting
            document.querySelectorAll('[data-sort]').forEach(header => {
                header.addEventListener('click', (e) => {
                    const field = e.currentTarget.dataset.sort;
                    handleSort(field);
                });
            });

            // Sync button
            document.getElementById('sync-btn').addEventListener('click', syncData);

            // Select all checkbox
            document.getElementById('select-all').addEventListener('change', handleSelectAll);

            // Close modals when clicking outside
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('modal-overlay')) {
                    closeContactModal();
                    closeSetupModal();
                    closeBulkEmailModal();
                    closeImportModal();
                    closeExportModal();
                }
            });
        }

        function checkConfiguration() {
            const statusElement = document.getElementById('connection-status');

            if (!CONFIG.GOOGLE_SCRIPT_URL || CONFIG.GOOGLE_SCRIPT_URL.trim() === '' || CONFIG.GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                statusElement.textContent = 'Not configured';
                statusElement.className = 'ml-4 px-2 py-1 text-xs rounded-full bg-red-100 text-red-800';

                // Show a non-blocking notification instead of a modal
                showNotification('Google Apps Script URL is not configured. Using local storage mode.', 'warning', {
                    persistent: true,
                    actions: [{
                        label: 'Setup Now',
                        handler: `showSetupModal()`,
                        primary: true
                    }]
                });

                return false;
            }

            statusElement.textContent = 'Connecting...';
            statusElement.className = 'ml-4 px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800';

            // Test connection (will be implemented in later tasks)
            setTimeout(() => {
                statusElement.textContent = 'Connected';
                statusElement.className = 'ml-4 px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
            }, 1000);

            return true;
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function openAddContactModal() {
            isEditMode = false;
            currentEditId = null;
            document.getElementById('modal-title').textContent = 'Add New Contact';
            document.getElementById('contact-form').reset();

            // Hide activities tab and add activity button for new contacts
            document.getElementById('contact-activities-tab').style.display = 'none';
            document.getElementById('add-activity-btn').style.display = 'none';

            // Set default values
            document.getElementById('contact-status').value = 'New';
            document.getElementById('contact-priority').value = 'Medium';

            // Switch to details tab
            switchContactTab('details');

            showModal('contact-modal');
        }

        function openEditContactModal(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;

            isEditMode = true;
            currentEditId = contactId;
            document.getElementById('modal-title').textContent = 'Edit Contact';

            // Show activities tab and add activity button for existing contacts
            document.getElementById('contact-activities-tab').style.display = 'block';
            document.getElementById('add-activity-btn').style.display = 'inline-flex';

            // Populate form with contact data
            Object.keys(contact).forEach(key => {
                const element = document.getElementById(`contact-${key}`);
                if (element) {
                    element.value = contact[key] || '';
                }
            });
            
            // Handle follow-up date specifically
            const followupDateElement = document.getElementById('contact-followup-date');
            if (followupDateElement && contact.nextFollowUp) {
                // Convert ISO date to YYYY-MM-DD format for date input
                const followupDate = new Date(contact.nextFollowUp);
                if (!isNaN(followupDate.getTime())) {
                    followupDateElement.value = followupDate.toISOString().split('T')[0];
                }
            }
            
            // Show assignment history if available
            displayAssignmentHistory(contact.assignmentHistory || []);

            // Populate score fields
            const autoScore = scoringEngine.calculateScore(contact);
            const manualScore = contact.manualScore;
            
            // Set manual score input
            const manualScoreInput = document.getElementById('contact-manual-score');
            if (manualScoreInput) {
                manualScoreInput.value = manualScore || '';
            }
            
            // Update score displays
            updateScoreDisplays(autoScore, manualScore);

            // Switch to details tab by default
            switchContactTab('details');

            // Set current date/time for activity form
            const now = new Date();
            const activityDateInput = document.getElementById('activity-date');
            if (activityDateInput) {
                activityDateInput.value = now.toISOString().slice(0, 16);
            }

            showModal('contact-modal');
        }

        function closeContactModal() {
            hideModal('contact-modal');
            document.getElementById('contact-form').reset();
            document.getElementById('activity-form').reset();
            isEditMode = false;
            currentEditId = null;
            
            // Hide assignment history section
            document.getElementById('assignment-history-section').style.display = 'none';
        }

        // ============================================
        // IMPORT/EXPORT MODAL FUNCTIONS
        // ============================================
        
        function openImportModal() {
            showModal('import-modal');
            // Reset import state
            document.getElementById('import-file-input').value = '';
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('import-options').classList.add('hidden');
            document.getElementById('confirm-import-btn').disabled = true;
        }

        function closeImportModal() {
            hideModal('import-modal');
            // Reset import state
            document.getElementById('import-file-input').value = '';
            document.getElementById('import-preview').classList.add('hidden');
            document.getElementById('import-options').classList.add('hidden');
            document.getElementById('confirm-import-btn').disabled = true;
        }

        function openExportModal() {
            showModal('export-modal');
            // Update counts
            document.getElementById('export-all-count').textContent = contacts.length;
            document.getElementById('export-filtered-count').textContent = filteredContacts.length;
            document.getElementById('export-selected-count').textContent = selectedContacts.size;
            
            // Disable selected option if no contacts selected
            const selectedRadio = document.querySelector('input[name="export-scope"][value="selected"]');
            selectedRadio.disabled = selectedContacts.size === 0;
            if (selectedContacts.size === 0 && selectedRadio.checked) {
                document.querySelector('input[name="export-scope"][value="all"]').checked = true;
            }
        }

        function closeExportModal() {
            hideModal('export-modal');
        }

        // ============================================
        // IMPORT/EXPORT CORE FUNCTIONS
        // ============================================

        /**
         * Handle file selection for import
         * Requirements: 7.2, 7.4
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('import-preview').classList.add('hidden');
                document.getElementById('import-options').classList.add('hidden');
                document.getElementById('confirm-import-btn').disabled = true;
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('Please select a CSV file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = parseCSV(e.target.result);
                    previewImportData(csvData);
                } catch (error) {
                    showNotification('Error reading CSV file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        /**
         * Parse CSV content into structured data
         * Requirements: 7.2, 7.4
         */
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSV file must have at least a header row and one data row');
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === 0) continue; // Skip empty lines
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }

            return { headers, data };
        }

        /**
         * Parse a single CSV line handling quoted values
         */
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        /**
         * Preview import data and validate
         * Requirements: 7.2, 7.3, 7.4
         */
        function previewImportData(csvData) {
            const { headers, data } = csvData;
            
            // Map CSV headers to our contact fields
            const fieldMapping = mapCSVHeaders(headers);
            const validContacts = [];
            const invalidContacts = [];
            const duplicates = [];

            // Validate and process each row
            data.forEach((row, index) => {
                const contact = mapRowToContact(row, fieldMapping);
                const validation = validateImportContact(contact);
                
                if (validation.isValid) {
                    // Check for duplicates
                    const existingContact = contacts.find(c => 
                        c.email && contact.email && c.email.toLowerCase() === contact.email.toLowerCase()
                    );
                    
                    if (existingContact) {
                        duplicates.push({ contact, existing: existingContact, rowIndex: index + 2 });
                    } else {
                        validContacts.push({ contact, rowIndex: index + 2 });
                    }
                } else {
                    invalidContacts.push({ contact, errors: validation.errors, rowIndex: index + 2 });
                }
            });

            // Store for later use
            window.importData = { validContacts, invalidContacts, duplicates, fieldMapping };

            // Update preview UI
            displayImportPreview(csvData, validContacts, invalidContacts, duplicates);
            
            // Show options and enable import if we have valid data
            if (validContacts.length > 0 || duplicates.length > 0) {
                document.getElementById('import-options').classList.remove('hidden');
                document.getElementById('confirm-import-btn').disabled = false;
            }
        }

        /**
         * Map CSV headers to contact fields
         */
        function mapCSVHeaders(headers) {
            const mapping = {};
            const headerMap = {
                'name': ['name', 'full name', 'contact name'],
                'email': ['email', 'email address', 'e-mail'],
                'company': ['company', 'organization', 'org'],
                'title': ['title', 'job title', 'position'],
                'industry': ['industry', 'sector'],
                'status': ['status', 'contact status'],
                'priority': ['priority', 'priority level'],
                'assignee': ['assignee', 'assigned to', 'owner'],
                'phone': ['phone', 'phone number', 'mobile', 'telephone'],
                'linkedin': ['linkedin', 'linkedin url', 'linkedin profile'],
                'notes': ['notes', 'comments', 'description'],
                'type': ['type', 'contact type'],
                'nextFollowUp': ['next follow-up', 'follow up', 'followup', 'next followup'],
                'lastContacted': ['last contacted', 'last contact', 'last contact date']
            };

            headers.forEach(header => {
                const normalizedHeader = header.toLowerCase().trim();
                for (const [field, variations] of Object.entries(headerMap)) {
                    if (variations.includes(normalizedHeader)) {
                        mapping[header] = field;
                        break;
                    }
                }
                // If no mapping found, use the header as-is (for custom fields)
                if (!mapping[header]) {
                    mapping[header] = normalizedHeader.replace(/\s+/g, '');
                }
            });

            return mapping;
        }

        /**
         * Map CSV row to contact object
         */
        function mapRowToContact(row, fieldMapping) {
            const contact = {
                id: generateId(),
                type: 'Individual',
                name: '',
                email: '',
                company: '',
                title: '',
                industry: '',
                status: 'New',
                priority: 'None',
                assignee: '',
                phone: '',
                linkedin: '',
                notes: '',
                nextFollowUp: '',
                lastContacted: '',
                dateAdded: new Date().toISOString().split('T')[0],
                lastModified: new Date().toISOString(),
                score: 0
            };

            // Map CSV data to contact fields
            Object.entries(row).forEach(([csvHeader, value]) => {
                const field = fieldMapping[csvHeader];
                if (field && value) {
                    contact[field] = value.trim();
                }
            });

            // Validate and normalize specific fields
            if (contact.type && !['Individual', 'Company'].includes(contact.type)) {
                contact.type = 'Individual';
            }
            if (contact.status && !CONFIG.CONTACT_STATUSES.includes(contact.status)) {
                contact.status = 'New';
            }
            if (contact.priority && !CONFIG.PRIORITY_LEVELS.includes(contact.priority)) {
                contact.priority = 'None';
            }
            if (contact.assignee && !CONFIG.TEAM_MEMBERS.includes(contact.assignee)) {
                contact.assignee = '';
            }

            // Calculate score
            contact.score = calculateContactScore(contact);

            return contact;
        }

        /**
         * Validate import contact data
         * Requirements: 7.4
         */
        function validateImportContact(contact) {
            const errors = [];
            
            if (!contact.name || contact.name.trim().length === 0) {
                errors.push('Name is required');
            }
            
            if (!contact.email || contact.email.trim().length === 0) {
                errors.push('Email is required');
            } else if (!isValidEmail(contact.email)) {
                errors.push('Invalid email format');
            }

            return {
                isValid: errors.length === 0,
                errors
            };
        }

        /**
         * Display import preview in the modal
         */
        function displayImportPreview(csvData, validContacts, invalidContacts, duplicates) {
            const previewDiv = document.getElementById('import-preview');
            const headersDiv = document.getElementById('import-preview-headers');
            const bodyDiv = document.getElementById('import-preview-body');

            // Show headers
            headersDiv.innerHTML = csvData.headers.map(h => `<th class="px-2 py-1 text-left">${h}</th>`).join('');

            // Show first 5 rows as preview
            const previewRows = csvData.data.slice(0, 5);
            bodyDiv.innerHTML = previewRows.map(row => 
                `<tr class="border-t">${csvData.headers.map(h => `<td class="px-2 py-1 text-xs">${row[h] || ''}</td>`).join('')}</tr>`
            ).join('');

            // Update counts
            document.getElementById('import-total-count').textContent = csvData.data.length;
            document.getElementById('import-valid-count').textContent = validContacts.length;
            document.getElementById('import-duplicate-count').textContent = duplicates.length;

            previewDiv.classList.remove('hidden');

            // Show validation errors if any
            if (invalidContacts.length > 0) {
                const errorMessage = `${invalidContacts.length} rows have validation errors and will be skipped.`;
                showNotification(errorMessage, 'warning');
            }
        }

        /**
         * Handle import confirmation
         * Requirements: 7.1, 7.2, 7.3
         */
        async function handleImportConfirm() {
            if (!window.importData) {
                showNotification('No import data available', 'error');
                return;
            }

            const duplicateHandling = document.querySelector('input[name="duplicate-handling"]:checked').value;
            const { validContacts, duplicates } = window.importData;

            let importedCount = 0;
            let updatedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;

            // Show progress loading
            const totalContacts = validContacts.length + duplicates.length;
            const progressId = loadingManager.showGlobalLoading('Importing contacts...', true);

            try {
                let processed = 0;

                // Process valid contacts
                for (const { contact } of validContacts) {
                    try {
                        contacts.push(contact);
                        
                        // Save to backend if configured
                        if (CONFIG.GOOGLE_SCRIPT_URL && CONFIG.GOOGLE_SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                            try {
                                await saveContactToBackend(new Contact(contact));
                            } catch (error) {
                                console.warn('Failed to save to backend, saved locally:', error);
                                // Add to offline queue for later sync
                                offlineQueue.addToQueue({
                                    type: 'save',
                                    data: contact
                                });
                            }
                        }
                        importedCount++;
                    } catch (error) {
                        console.error('Error processing contact:', contact.name, error);
                        errorCount++;
                    }

                    processed++;
                    const progress = Math.round((processed / totalContacts) * 100);
                    loadingManager.updateGlobalProgress(progress, `Processing contact ${processed} of ${totalContacts}...`);
                }

                // Process duplicates based on handling option
                for (const { contact, existing } of duplicates) {
                    try {
                        if (duplicateHandling === 'skip') {
                            skippedCount++;
                        } else if (duplicateHandling === 'update') {
                            // Update existing contact
                            Object.assign(existing, contact, { 
                                id: existing.id, // Keep original ID
                                dateAdded: existing.dateAdded // Keep original date added
                            });
                            
                            // Save to backend if configured
                            if (CONFIG.GOOGLE_SCRIPT_URL && CONFIG.GOOGLE_SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                                try {
                                    await saveContactToBackend(new Contact(existing));
                                } catch (error) {
                                    console.warn('Failed to save to backend, saved locally:', error);
                                    offlineQueue.addToQueue({
                                        type: 'update',
                                        data: existing
                                    });
                                }
                            }
                            updatedCount++;
                        } else if (duplicateHandling === 'create') {
                            // Create new contact even if duplicate
                            contacts.push(contact);
                            
                            // Save to backend if configured
                            if (CONFIG.GOOGLE_SCRIPT_URL && CONFIG.GOOGLE_SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                                try {
                                    await saveContactToBackend(new Contact(contact));
                                } catch (error) {
                                    console.warn('Failed to save to backend, saved locally:', error);
                                    offlineQueue.addToQueue({
                                        type: 'save',
                                        data: contact
                                    });
                                }
                            }
                            importedCount++;
                        }
                    } catch (error) {
                        console.error('Error processing duplicate contact:', contact.name, error);
                        errorCount++;
                    }

                    processed++;
                    const progress = Math.round((processed / totalContacts) * 100);
                    loadingManager.updateGlobalProgress(progress, `Processing contact ${processed} of ${totalContacts}...`);
                }

                // Save to local storage
                saveContactsToLocalStorage();
                
                // Update UI
                applyFilters();
                updateDashboardStats();
                closeImportModal();

                // Show success message with detailed results
                const messages = [];
                if (importedCount > 0) messages.push(`${importedCount} contacts imported`);
                if (updatedCount > 0) messages.push(`${updatedCount} contacts updated`);
                if (skippedCount > 0) messages.push(`${skippedCount} duplicates skipped`);
                if (errorCount > 0) messages.push(`${errorCount} contacts failed`);
                
                const actions = [];
                if (errorCount > 0) {
                    actions.push({
                        label: 'View Errors',
                        handler: 'showImportErrors()',
                        primary: false
                    });
                }

                showSuccessNotification(messages.join(', '), actions);

            } catch (error) {
                handleError(error, 'Contact import operation', {
                    userFriendly: true,
                    retryHandler: () => handleImportConfirm(),
                    fallbackHandler: () => {
                        // Save what we can locally
                        try {
                            saveContactsToLocalStorage();
                            applyFilters();
                            updateDashboardStats();
                            closeImportModal();
                            showNotification('Partial import completed. Some contacts saved locally.', 'warning');
                        } catch (fallbackError) {
                            showNotification('Import failed completely. Please try again.', 'error');
                        }
                    }
                });
            } finally {
                loadingManager.hideGlobalLoading();
            }
        }

        /**
         * Handle export confirmation
         * Requirements: 7.1, 7.5
         */
        function handleExportConfirm() {
            const exportScope = document.querySelector('input[name="export-scope"]:checked').value;
            const includeActivities = document.getElementById('export-include-activities').checked;

            // Get contacts to export
            let contactsToExport = [];
            switch (exportScope) {
                case 'all':
                    contactsToExport = contacts;
                    break;
                case 'filtered':
                    contactsToExport = filteredContacts;
                    break;
                case 'selected':
                    contactsToExport = contacts.filter(c => selectedContacts.has(c.id));
                    break;
            }

            if (contactsToExport.length === 0) {
                showNotification('No contacts to export', 'warning');
                return;
            }

            // Get selected fields
            const selectedFields = getSelectedExportFields();
            
            // Generate CSV
            const csvContent = generateCSV(contactsToExport, selectedFields, includeActivities);
            
            // Download file
            downloadCSV(csvContent, `contacts-export-${new Date().toISOString().split('T')[0]}.csv`);
            
            closeExportModal();
            showNotification(`Exported ${contactsToExport.length} contacts`, 'success');
        }

        /**
         * Get selected export fields
         */
        function getSelectedExportFields() {
            const fields = [];
            const fieldCheckboxes = document.querySelectorAll('[id^="export-field-"]:checked');
            
            fieldCheckboxes.forEach(checkbox => {
                const field = checkbox.id.replace('export-field-', '');
                fields.push(field);
            });

            return fields;
        }

        /**
         * Generate CSV content from contacts
         * Requirements: 7.1, 7.5
         */
        function generateCSV(contactsToExport, selectedFields, includeActivities) {
            const fieldMap = {
                'name': 'Name',
                'email': 'Email',
                'company': 'Company',
                'title': 'Title',
                'industry': 'Industry',
                'status': 'Status',
                'priority': 'Priority',
                'assignee': 'Assignee',
                'phone': 'Phone',
                'linkedin': 'LinkedIn',
                'score': 'Score',
                'notes': 'Notes',
                'followup': 'Next Follow-up',
                'lastcontacted': 'Last Contacted',
                'dateadded': 'Date Added',
                'type': 'Type'
            };

            // Build headers
            const headers = selectedFields.map(field => fieldMap[field] || field);
            if (includeActivities) {
                headers.push('Activity Count', 'Last Activity', 'Activity Summary');
            }

            // Build rows
            const rows = contactsToExport.map(contact => {
                const row = selectedFields.map(field => {
                    let value = '';
                    switch (field) {
                        case 'followup':
                            value = contact.nextFollowUp || '';
                            break;
                        case 'lastcontacted':
                            value = contact.lastContacted || '';
                            break;
                        case 'dateadded':
                            value = contact.dateAdded || '';
                            break;
                        default:
                            value = contact[field] || '';
                    }
                    return `"${String(value).replace(/"/g, '""')}"`;
                });

                if (includeActivities) {
                    const contactActivities = activities.filter(a => a.contactId === contact.id);
                    const activityCount = contactActivities.length;
                    const lastActivity = contactActivities.length > 0 ? 
                        contactActivities.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date : '';
                    const activitySummary = contactActivities
                        .map(a => `${a.type}: ${a.notes}`)
                        .join('; ');
                    
                    row.push(`"${activityCount}"`, `"${lastActivity}"`, `"${activitySummary.replace(/"/g, '""')}"`);
                }

                return row.join(',');
            });

            return [headers.join(','), ...rows].join('\n');
        }

        /**
         * Download CSV file
         */
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        /**
         * Get CSS class for follow-up row highlighting
         */
        function getFollowUpRowClass(nextFollowUp) {
            if (!nextFollowUp) return '';
            
            const followupDate = new Date(nextFollowUp);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            followupDate.setHours(0, 0, 0, 0);
            
            const diffTime = followupDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                // Overdue - red border
                return 'border-l-4 border-red-500 bg-red-50';
            } else if (diffDays === 0) {
                // Due today - orange border
                return 'border-l-4 border-orange-500 bg-orange-50';
            }
            
            return '';
        }

        /**
         * Get follow-up display with overdue highlighting
         */
        function getFollowUpDisplay(nextFollowUp) {
            if (!nextFollowUp) {
                return '<span class="text-gray-400">Not set</span>';
            }
            
            const followupDate = new Date(nextFollowUp);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            followupDate.setHours(0, 0, 0, 0);
            
            const diffTime = followupDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let className = 'text-gray-900';
            let label = followupDate.toLocaleDateString();
            
            if (diffDays < 0) {
                // Overdue
                className = 'text-red-600 font-medium';
                label = `${followupDate.toLocaleDateString()} (${Math.abs(diffDays)} days overdue)`;
            } else if (diffDays === 0) {
                // Due today
                className = 'text-orange-600 font-medium';
                label = `${followupDate.toLocaleDateString()} (Due today)`;
            } else if (diffDays <= 7) {
                // Due this week
                className = 'text-yellow-600 font-medium';
                label = `${followupDate.toLocaleDateString()} (${diffDays} days)`;
            }
            
            return `<span class="${className}" title="Follow-up date">${label}</span>`;
        }

        /**
         * Display assignment history for a contact
         */
        function displayAssignmentHistory(assignmentHistory) {
            const historySection = document.getElementById('assignment-history-section');
            const historyList = document.getElementById('assignment-history-list');
            
            if (!assignmentHistory || assignmentHistory.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            historySection.style.display = 'block';
            historyList.innerHTML = '';
            
            // Sort by date (newest first)
            const sortedHistory = [...assignmentHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedHistory.forEach(entry => {
                const historyItem = document.createElement('div');
                historyItem.className = 'flex items-center justify-between p-2 bg-gray-50 rounded text-sm';
                
                const date = new Date(entry.date).toLocaleDateString();
                const time = new Date(entry.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                historyItem.innerHTML = `
                    <div class="flex-1">
                        <span class="font-medium">${entry.fromAssignee}</span>
                        <svg class="w-4 h-4 inline mx-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                        </svg>
                        <span class="font-medium">${entry.toAssignee}</span>
                    </div>
                    <div class="text-xs text-gray-500">
                        ${date} ${time}
                        ${entry.changedBy ? `by ${entry.changedBy}` : ''}
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }

        /**
         * Save contact from modal
         */
        function saveContact() {
            const form = document.getElementById('contact-form');
            const formData = new FormData(form);
            const contactData = Object.fromEntries(formData.entries());

            // Create a synthetic event to reuse existing form submission logic
            const syntheticEvent = {
                preventDefault: () => { },
                target: form
            };

            handleContactFormSubmit(syntheticEvent);
        }

        function showSetupModal() {
            showModal('setup-modal');
        }

        function closeSetupModal() {
            hideModal('setup-modal');
        }

        // ============================================
        // HELP MODAL FUNCTIONS
        // ============================================

        /**
         * Show help modal
         */
        function showHelpModal() {
            helpModalVisible = true;
            showModal('help-modal');
            
            // Update shortcuts status
            updateShortcutsStatus();
            
            // Populate shortcuts list
            populateShortcutsList();
            
            // Update performance metrics
            updatePerformanceMetrics();
        }

        /**
         * Close help modal
         */
        function closeHelpModal() {
            helpModalVisible = false;
            hideModal('help-modal');
        }

        /**
         * Switch help tab
         */
        function switchHelpTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.help-tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-blue-500', 'text-blue-600');
            
            // Update tab content
            document.querySelectorAll('.help-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`help-${tabName}`).classList.remove('hidden');
            
            // Load tab-specific content
            if (tabName === 'shortcuts') {
                populateShortcutsList();
            } else if (tabName === 'performance') {
                updatePerformanceMetrics();
            }
        }

        /**
         * Update shortcuts status display
         */
        function updateShortcutsStatus() {
            const statusElement = document.getElementById('shortcuts-status');
            if (statusElement) {
                statusElement.textContent = keyboardShortcutsEnabled ? 'Enabled' : 'Disabled';
                statusElement.className = keyboardShortcutsEnabled ? 'font-semibold text-green-600' : 'font-semibold text-red-600';
            }
        }

        /**
         * Populate shortcuts list
         */
        function populateShortcutsList() {
            const container = document.getElementById('shortcuts-list');
            if (!container) return;
            
            const shortcuts = keyboardManager.getAllShortcuts();
            const categories = {
                'Contact Management': shortcuts.filter(s => s.key.includes('Ctrl+N') || s.key.includes('Ctrl+E') || s.key.includes('Ctrl+I') || s.key.includes('Ctrl+S')),
                'Navigation': shortcuts.filter(s => s.key.includes('Ctrl+1') || s.key.includes('Ctrl+2') || s.key.includes('Ctrl+3') || s.key.includes('Arrow')),
                'Table Operations': shortcuts.filter(s => s.key.includes('Ctrl+A') || s.key.includes('Ctrl+D') || s.key.includes('Delete')),
                'Utility': shortcuts.filter(s => s.key.includes('F1') || s.key.includes('Escape') || s.key.includes('Ctrl+/') || s.key.includes('Ctrl+F'))
            };
            
            container.innerHTML = Object.entries(categories).map(([category, categoryShortcuts]) => `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 mb-3">${category}</h4>
                    <div class="space-y-2">
                        ${categoryShortcuts.map(shortcut => `
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">${shortcut.description}</span>
                                <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs font-mono">${shortcut.key}</kbd>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update performance metrics display
         */
        function updatePerformanceMetrics() {
            const container = document.getElementById('performance-metrics');
            if (!container) return;
            
            const metrics = performanceOptimizer.getPerformanceMetrics();
            
            container.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Contact Count:</span>
                        <span class="font-medium">${metrics.contactCount}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Large Dataset Mode:</span>
                        <span class="font-medium ${metrics.isLargeDataset ? 'text-orange-600' : 'text-green-600'}">
                            ${metrics.isLargeDataset ? 'Enabled' : 'Disabled'}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Items Per Page:</span>
                        <span class="font-medium">${metrics.itemsPerPage}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Virtual Scrolling:</span>
                        <span class="font-medium ${metrics.virtualScrollEnabled ? 'text-blue-600' : 'text-gray-600'}">
                            ${metrics.virtualScrollEnabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Last Render Time:</span>
                        <span class="font-medium">${metrics.renderTime.toFixed(2)}ms</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Last Search Time:</span>
                        <span class="font-medium">${metrics.searchTime.toFixed(2)}ms</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Memory Usage:</span>
                        <span class="font-medium">${(metrics.memoryUsage / 1024).toFixed(1)}KB</span>
                    </div>
                </div>
            `;
        }

        /**
         * Run data integrity check
         */
        function runIntegrityCheck() {
            const container = document.getElementById('integrity-status');
            if (!container) return;
            
            container.innerHTML = '<p class="text-blue-600">Running integrity check...</p>';
            
            setTimeout(() => {
                const issues = dataIntegrityManager.runIntegrityChecks();
                
                if (issues.length === 0) {
                    container.innerHTML = '<p class="text-green-600 font-medium">✓ No data integrity issues found</p>';
                } else {
                    const issuesList = issues.map(issue => `
                        <div class="p-2 rounded ${issue.severity === 'error' ? 'bg-red-50 text-red-800' : issue.severity === 'warning' ? 'bg-yellow-50 text-yellow-800' : 'bg-blue-50 text-blue-800'}">
                            <div class="font-medium">${issue.message}</div>
                            <div class="text-xs mt-1">Type: ${issue.type}</div>
                        </div>
                    `).join('');
                    
                    container.innerHTML = `
                        <div class="space-y-2">
                            <p class="text-orange-600 font-medium">Found ${issues.length} issue(s):</p>
                            ${issuesList}
                        </div>
                    `;
                }
            }, 500);
        }

        /**
         * Auto-fix data issues
         */
        function autoFixDataIssues() {
            const issues = dataIntegrityManager.runIntegrityChecks();
            const fixedCount = dataIntegrityManager.autoFixIssues(issues);
            
            if (fixedCount > 0) {
                // Refresh the integrity check display
                setTimeout(() => runIntegrityCheck(), 1000);
            } else {
                showNotification('No auto-fixable issues found', 'info');
            }
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            modal.classList.add('fade-in');
            document.body.style.overflow = 'hidden';
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hidden');
            modal.classList.remove('fade-in');
            document.body.style.overflow = 'auto';
        }

        /**
         * Generate unique ID for contacts
         */
        function generateId() {
            return 'contact_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ============================================
        // CONTACT DATA MODEL AND VALIDATION
        // ============================================

        /**
         * Contact class for data validation and sanitization
         * Requirements: 2.3, 7.4
         */
        class Contact {
            constructor(data = {}) {
                this.id = data.id || this.generateId();
                this.type = data.type || 'Individual';
                this.name = this.sanitizeString(data.name) || '';
                this.title = this.sanitizeString(data.title) || '';
                this.company = this.sanitizeString(data.company) || '';
                this.industry = this.sanitizeString(data.industry) || '';
                this.email = this.sanitizeEmail(data.email) || '';
                this.linkedin = this.sanitizeUrl(data.linkedin) || '';
                this.phone = this.sanitizeString(data.phone) || '';
                this.status = data.status || 'New';
                this.priority = data.priority || 'None';
                this.assignee = data.assignee || '';
                this.nextFollowUp = data.nextFollowUp || null;
                this.notes = this.sanitizeString(data.notes) || '';
                this.score = data.score || 0;
                this.scoreBreakdown = data.scoreBreakdown || {};
                this.manualScore = data.manualScore || null; // Manual score override
                this.tags = Array.isArray(data.tags) ? data.tags : [];
                this.dateAdded = data.dateAdded || new Date().toISOString();
                this.lastModified = new Date().toISOString();
                this.lastContacted = data.lastContacted || null;
                this.assignmentHistory = Array.isArray(data.assignmentHistory) ? data.assignmentHistory : [];

                // Validate required fields
                this.validate();
            }

            generateId() {
                return 'contact_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            sanitizeString(str) {
                if (typeof str !== 'string') return '';
                return str.trim().replace(/[<>]/g, '');
            }

            sanitizeEmail(email) {
                if (typeof email !== 'string') return '';
                return email.trim().toLowerCase();
            }

            sanitizeUrl(url) {
                if (typeof url !== 'string') return '';
                url = url.trim();
                if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                return url;
            }

            validate() {
                const errors = [];

                if (!this.name) {
                    errors.push('Name is required');
                }

                if (!this.email) {
                    errors.push('Email is required');
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.email)) {
                    errors.push('Invalid email format');
                }

                if (this.linkedin && !/^https?:\/\/(www\.)?linkedin\.com\/(in|company)\/[a-zA-Z0-9\-]+\/?$/.test(this.linkedin)) {
                    errors.push('Invalid LinkedIn URL format');
                }

                if (!CONFIG.CONTACT_STATUSES.includes(this.status)) {
                    this.status = 'New';
                }

                if (!CONFIG.PRIORITY_LEVELS.includes(this.priority)) {
                    this.priority = 'None';
                }

                if (this.assignee && !CONFIG.TEAM_MEMBERS.includes(this.assignee)) {
                    this.assignee = '';
                }

                if (errors.length > 0) {
                    throw new ValidationError('Contact validation failed', errors);
                }
            }

            toJSON() {
                return {
                    id: this.id,
                    type: this.type,
                    name: this.name,
                    title: this.title,
                    company: this.company,
                    industry: this.industry,
                    email: this.email,
                    linkedin: this.linkedin,
                    phone: this.phone,
                    status: this.status,
                    priority: this.priority,
                    assignee: this.assignee,
                    nextFollowUp: this.nextFollowUp,
                    notes: this.notes,
                    score: this.score,
                    scoreBreakdown: this.scoreBreakdown,
                    tags: this.tags,
                    dateAdded: this.dateAdded,
                    lastModified: this.lastModified,
                    lastContacted: this.lastContacted,
                    assignmentHistory: this.assignmentHistory
                };
            }

            /**
             * Track assignment changes
             */
            updateAssignment(newAssignee, user = 'System') {
                const oldAssignee = this.assignee;
                if (oldAssignee !== newAssignee) {
                    this.assignmentHistory.push({
                        id: 'assignment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        fromAssignee: oldAssignee || 'Unassigned',
                        toAssignee: newAssignee || 'Unassigned',
                        changedBy: user,
                        date: new Date().toISOString(),
                        reason: 'Manual assignment change'
                    });
                    this.assignee = newAssignee;
                    this.lastModified = new Date().toISOString();
                }
            }
        }

        /**
         * Activity class for tracking contact interactions
         * Requirements: 5.1, 5.2, 5.3, 5.4, 5.5
         */
        class Activity {
            constructor(data = {}) {
                this.id = data.id || this.generateId();
                this.contactId = data.contactId || '';
                this.type = data.type || 'Note Added';
                this.notes = this.sanitizeString(data.notes) || '';
                this.date = data.date || new Date().toISOString();
                this.user = data.user || 'Current User';
                this.metadata = data.metadata || {};
            }

            generateId() {
                return 'activity_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            sanitizeString(str) {
                if (typeof str !== 'string') return '';
                return str.trim().replace(/[<>]/g, '');
            }

            validate() {
                const errors = [];

                if (!this.contactId) {
                    errors.push('Contact ID is required');
                }

                if (!this.type) {
                    errors.push('Activity type is required');
                }

                if (!CONFIG.ACTIVITY_TYPES.includes(this.type)) {
                    errors.push('Invalid activity type');
                }

                if (errors.length > 0) {
                    throw new ValidationError('Activity validation failed', errors);
                }
            }

            toJSON() {
                return {
                    id: this.id,
                    contactId: this.contactId,
                    type: this.type,
                    notes: this.notes,
                    date: this.date,
                    user: this.user,
                    metadata: this.metadata
                };
            }
        }

        /**
         * Custom error class for validation errors
         */
        class ValidationError extends Error {
            constructor(message, errors = []) {
                super(message);
                this.name = 'ValidationError';
                this.errors = errors;
            }
        }

        /**
         * Duplicate detection utility
         * Requirements: 2.4
         */
        class DuplicateDetector {
            static findDuplicates(newContact, existingContacts) {
                const duplicates = [];

                for (const existing of existingContacts) {
                    if (existing.id === newContact.id) continue;

                    const similarity = this.calculateSimilarity(newContact, existing);
                    if (similarity.isDuplicate) {
                        duplicates.push({
                            contact: existing,
                            similarity: similarity
                        });
                    }
                }

                return duplicates;
            }

            static calculateSimilarity(contact1, contact2) {
                let score = 0;
                let reasons = [];

                // Exact email match (highest priority)
                if (contact1.email && contact2.email &&
                    contact1.email.toLowerCase() === contact2.email.toLowerCase()) {
                    score += 100;
                    reasons.push('Same email address');
                }

                // Exact name match
                if (contact1.name && contact2.name &&
                    contact1.name.toLowerCase() === contact2.name.toLowerCase()) {
                    score += 80;
                    reasons.push('Same name');
                }

                // Same company and similar name
                if (contact1.company && contact2.company &&
                    contact1.company.toLowerCase() === contact2.company.toLowerCase()) {
                    score += 30;
                    reasons.push('Same company');

                    if (this.isSimilarName(contact1.name, contact2.name)) {
                        score += 40;
                        reasons.push('Similar name in same company');
                    }
                }

                // LinkedIn profile match
                if (contact1.linkedin && contact2.linkedin &&
                    contact1.linkedin.toLowerCase() === contact2.linkedin.toLowerCase()) {
                    score += 90;
                    reasons.push('Same LinkedIn profile');
                }

                // Phone number match
                if (contact1.phone && contact2.phone &&
                    this.normalizePhone(contact1.phone) === this.normalizePhone(contact2.phone)) {
                    score += 70;
                    reasons.push('Same phone number');
                }

                return {
                    isDuplicate: score >= 80,
                    score: score,
                    reasons: reasons
                };
            }

            static isSimilarName(name1, name2) {
                if (!name1 || !name2) return false;

                const normalize = (name) => name.toLowerCase().replace(/[^a-z\s]/g, '').trim();
                const n1 = normalize(name1);
                const n2 = normalize(name2);

                // Check if names are very similar (allowing for minor differences)
                const words1 = n1.split(/\s+/);
                const words2 = n2.split(/\s+/);

                let matchingWords = 0;
                for (const word1 of words1) {
                    for (const word2 of words2) {
                        if (word1 === word2 || this.levenshteinDistance(word1, word2) <= 1) {
                            matchingWords++;
                            break;
                        }
                    }
                }

                return matchingWords >= Math.min(words1.length, words2.length);
            }

            static normalizePhone(phone) {
                return phone.replace(/[^\d]/g, '');
            }

            static levenshteinDistance(str1, str2) {
                const matrix = [];

                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }

                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }

                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }

                return matrix[str2.length][str1.length];
            }
        }

        // ============================================
        // CORE CONTACT MANAGEMENT FUNCTIONS
        // ============================================

        /**
         * Handle contact form submission
         * Requirements: 2.1, 2.2, 2.3
         */
        async function handleContactFormSubmit(e) {
            e.preventDefault();

            let loadingId = null;
            try {
                // Show loading state
                const submitBtn = e.target.querySelector('button[type="submit"]');
                loadingId = loadingManager.showButtonLoading(submitBtn, 'Saving...');

                // Get form data
                const formData = new FormData(e.target);
                const contactData = Object.fromEntries(formData.entries());

                // Create or update contact
                if (isEditMode) {
                    await updateContact(currentEditId, contactData);
                    showSuccessNotification('Contact updated successfully!', [
                        {
                            label: 'View Contact',
                            handler: `viewContactDetails('${currentEditId}')`,
                            primary: false
                        }
                    ]);
                } else {
                    const newContact = await addContact(contactData);
                    showSuccessNotification('Contact added successfully!', [
                        {
                            label: 'Add Another',
                            handler: 'showContactModal()',
                            primary: false
                        },
                        {
                            label: 'View Contact',
                            handler: `viewContactDetails('${newContact.id}')`,
                            primary: false
                        }
                    ]);
                }

                closeContactModal();

            } catch (error) {
                if (error instanceof ValidationError) {
                    handleError(error, 'Contact validation', {
                        userFriendly: true,
                        retryHandler: () => {
                            // Focus on first invalid field
                            const firstError = error.errors[0];
                            if (firstError && firstError.field) {
                                const field = e.target.querySelector(`[name="${firstError.field}"]`);
                                if (field) field.focus();
                            }
                        }
                    });
                } else {
                    handleError(error, 'Contact save operation', {
                        userFriendly: true,
                        retryHandler: () => e.target.dispatchEvent(new Event('submit')),
                        fallbackHandler: () => {
                            // Save to local storage as fallback
                            try {
                                const formData = new FormData(e.target);
                                const contactData = Object.fromEntries(formData.entries());
                                const contact = new Contact(contactData);
                                contacts.push(contact);
                                saveContactsToLocalStorage();
                                renderContactsTable();
                                updateDashboardStats();
                                closeContactModal();
                                showNotification('Contact saved offline. Will sync when connection is restored.', 'info');
                            } catch (fallbackError) {
                                showNotification('Failed to save contact even offline. Please try again.', 'error');
                            }
                        }
                    });
                }
            } finally {
                if (loadingId) {
                    loadingManager.hideButtonLoading(loadingId);
                }
            }
        }

        /**
         * Add new contact with validation and duplicate detection
         * Requirements: 2.1, 2.4
         */
        async function addContact(contactData) {
            try {
                // Enhanced data validation using DataIntegrityManager
                const validation = dataIntegrityManager.validateContact(contactData);
                if (!validation.isValid) {
                    throw new ValidationError('Contact validation failed', validation.errors);
                }
                
                // Use sanitized data
                const sanitizedData = validation.sanitizedData;
                
                // Create and validate contact
                const contact = new Contact(sanitizedData);

                // Check for duplicates
                const duplicates = DuplicateDetector.findDuplicates(contact, contacts);

                if (duplicates.length > 0) {
                    const proceed = await showDuplicateDialog(contact, duplicates);
                    if (!proceed) {
                        return; // User cancelled
                    }
                }

                // Calculate score - use manual score if provided, otherwise automatic
                const autoScore = scoringEngine.calculateScore(contact);
                contact.scoreBreakdown = scoringEngine.getScoreBreakdown(contact);
                
                if (contact.manualScore !== null && contact.manualScore !== undefined && contact.manualScore !== '') {
                    contact.score = parseInt(contact.manualScore);
                } else {
                    contact.score = autoScore;
                }

                // Save to backend if configured
                if (CONFIG.GOOGLE_SCRIPT_URL && CONFIG.GOOGLE_SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    await saveContactToBackend(contact);
                }

                // Add to local storage
                contacts.push(contact.toJSON());
                saveContactsToLocalStorage();
                
                // Check if we need to enable performance optimizations
                performanceOptimizer.checkDatasetSize();
                
                applyFilters();
                updateDashboardStats();

                console.log('Contact added successfully:', contact.name);

            } catch (error) {
                console.error('Error adding contact:', error);
                throw error;
            }
        }

        /**
         * Update existing contact
         * Requirements: 2.2, 2.3
         */
        async function updateContact(contactId, contactData) {
            try {
                const existingIndex = contacts.findIndex(c => c.id === contactId);
                if (existingIndex === -1) {
                    throw new Error('Contact not found');
                }

                // Preserve original ID and creation date
                contactData.id = contactId;
                contactData.dateAdded = contacts[existingIndex].dateAdded;
                
                // Preserve assignment history
                contactData.assignmentHistory = contacts[existingIndex].assignmentHistory || [];

                // Create and validate updated contact
                const contact = new Contact(contactData);
                
                // Track assignment changes
                const oldAssignee = contacts[existingIndex].assignee;
                if (oldAssignee !== contact.assignee) {
                    contact.updateAssignment(contact.assignee, 'User');
                }

                // Check for duplicates (excluding current contact)
                const otherContacts = contacts.filter(c => c.id !== contactId);
                const duplicates = DuplicateDetector.findDuplicates(contact, otherContacts);

                if (duplicates.length > 0) {
                    const proceed = await showDuplicateDialog(contact, duplicates);
                    if (!proceed) {
                        return; // User cancelled
                    }
                }

                // Calculate score - use manual score if provided, otherwise automatic
                const autoScore = scoringEngine.calculateScore(contact);
                contact.scoreBreakdown = scoringEngine.getScoreBreakdown(contact);
                
                if (contact.manualScore !== null && contact.manualScore !== undefined && contact.manualScore !== '') {
                    contact.score = parseInt(contact.manualScore);
                } else {
                    contact.score = autoScore;
                }

                // Save to backend if configured
                if (CONFIG.GOOGLE_SCRIPT_URL && CONFIG.GOOGLE_SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    await saveContactToBackend(contact);
                }

                // Update local storage
                contacts[existingIndex] = contact.toJSON();
                saveContactsToLocalStorage();
                applyFilters();
                updateDashboardStats();

                console.log('Contact updated successfully:', contact.name);

            } catch (error) {
                console.error('Error updating contact:', error);
                throw error;
            }
        }

        /**
         * Delete contact with confirmation
         * Requirements: 2.5
         */
        async function deleteContact(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) {
                showNotification('Contact not found', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${contact.name}"? This action cannot be undone.`)) {
                return;
            }

            try {
                // Delete from backend if configured
                if (CONFIG.GOOGLE_SCRIPT_URL && CONFIG.GOOGLE_SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    await deleteContactFromBackend(contactId);
                }

                // Remove from local storage
                contacts = contacts.filter(c => c.id !== contactId);
                selectedContacts.delete(contactId);
                saveContactsToLocalStorage();
                applyFilters();
                updateDashboardStats();

                showNotification('Contact deleted successfully!', 'success');
                console.log('Contact deleted successfully:', contact.name);

            } catch (error) {
                console.error('Error deleting contact:', error);
                showNotification('Failed to delete contact: ' + error.message, 'error');
            }
        }

        /**
         * Load contacts from backend or local storage
         * Requirements: 2.1
         */
        async function loadContacts() {
            try {
                updateConnectionStatus('loading', 'Loading contacts...');

                // Try to load from backend if configured
                if (CONFIG.GOOGLE_SCRIPT_URL && CONFIG.GOOGLE_SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                    await loadContactsFromBackend();
                } else {
                    // Load from local storage as fallback
                    loadContactsFromLocalStorage();
                }

                // Apply initial filters and update UI
                applyFilters();
                updateDashboardStats();
                updateConnectionStatus('connected', 'Connected');

                console.log('Loaded', contacts.length, 'contacts');

            } catch (error) {
                console.error('Error loading contacts:', error);
                updateConnectionStatus('error', 'Load failed');

                // Fallback to local storage
                loadContactsFromLocalStorage();
                applyFilters();
                updateDashboardStats();

                showNotification('Failed to load from server, using local data', 'warning');
            }
        }

        /**
         * Load contacts from local storage
         */
        function loadContactsFromLocalStorage() {
            try {
                const storedContacts = localStorageManager.loadData(localStorageManager.storageKeys.contacts);
                if (storedContacts && Array.isArray(storedContacts)) {
                    contacts = storedContacts.map(data => {
                        try {
                            const contact = new Contact(data);
                            // Recalculate score to ensure it's current
                            contact.score = scoringEngine.calculateScore(contact);
                            contact.scoreBreakdown = scoringEngine.getScoreBreakdown(contact);
                            return contact.toJSON();
                        } catch (error) {
                            console.warn('Invalid contact data in local storage:', error, data);
                            return data; // Use raw data as fallback
                        }
                    });
                    console.log('Loaded', contacts.length, 'contacts from local storage');
                    
                    // Check dataset size and enable optimizations if needed
                    performanceOptimizer.checkDatasetSize();
                } else {
                    contacts = [];
                    console.log('No contacts found in local storage, starting with empty array');
                }
                updateLocalStorageStatus();
            } catch (error) {
                console.error('Error loading contacts from local storage:', error);
                contacts = [];
                showNotification('Failed to load contacts from local storage. Starting fresh.', 'warning');
            }
        }

        /**
         * Enhanced save contacts to local storage with integrity checks
         * Requirements: 13.4, 13.5
         */
        function saveContactsToLocalStorage() {
            try {
                const success = localStorageManager.saveData(localStorageManager.storageKeys.contacts, contacts);
                if (success) {
                    updateLocalStorageStatus();
                    console.log('Contacts saved to local storage successfully');
                } else {
                    throw new Error('Failed to save contacts');
                }
            } catch (error) {
                console.error('Error saving contacts to local storage:', error);
                showNotification('Failed to save contacts locally. Storage may be full.', 'error');
            }
        }

        /**
         * Sync data with backend
         */
        async function syncData() {
            const syncBtn = document.getElementById('sync-btn');
            const originalContent = syncBtn.innerHTML;

            try {
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<div class="loading-spinner mr-2"></div>Syncing...';

                await loadContacts();
                showNotification('Data synchronized successfully!', 'success');

            } catch (error) {
                console.error('Sync failed:', error);
                showNotification('Sync failed: ' + error.message, 'error');
            } finally {
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalContent;
            }
        }

        // ============================================
        // UI UPDATE FUNCTIONS
        // ============================================
        function updateDashboardStats() {
            const totalContacts = contacts.length;
            const companies = contacts.filter(c => c.type === 'Company').length;
            const individuals = contacts.filter(c => c.type === 'Individual').length;
            
            // Calculate follow-ups due (overdue + due today)
            const today = new Date();
            today.setHours(23, 59, 59, 999); // End of today
            const followupsDue = contacts.filter(c => {
                if (!c.nextFollowUp) return false;
                const followupDate = new Date(c.nextFollowUp);
                return followupDate <= today;
            }).length;

            document.getElementById('total-contacts').textContent = totalContacts;
            document.getElementById('total-companies').textContent = companies;
            document.getElementById('total-individuals').textContent = individuals;
            document.getElementById('followups-due').textContent = followupsDue;

            // Update dashboard content if dashboard tab is active
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection && !dashboardSection.classList.contains('hidden')) {
                updateDashboardContent();
            }

            // Update analytics if analytics tab is active
            const analyticsSection = document.getElementById('analytics-section');
            if (analyticsSection && !analyticsSection.classList.contains('hidden')) {
                updateAnalyticsDashboard();
            }
        }

        /**
         * Switch between main tabs (Dashboard, Contacts and Analytics)
         */
        function switchMainTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.main-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // Update tab content
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Activate selected tab
            const activeBtn = document.getElementById(`${tabName}-main-tab`);
            const activeContent = document.getElementById(`${tabName}-section`);

            if (activeBtn && activeContent) {
                activeBtn.classList.add('active', 'border-blue-500', 'text-blue-600');
                activeBtn.classList.remove('border-transparent', 'text-gray-500');
                activeContent.classList.remove('hidden');

                // Update content based on tab
                if (tabName === 'dashboard') {
                    updateDashboardContent();
                } else if (tabName === 'analytics') {
                    updateAnalyticsDashboard();
                }
            }
        }

        /**
         * Update analytics dashboard with latest data
         * Requirements: 10.1, 10.2, 10.3, 10.4, 10.5
         */
        function updateAnalyticsDashboard() {
            const metrics = analyticsEngine.generateDashboardMetrics();

            // Update key metrics cards
            document.getElementById('conversion-rate').textContent = `${metrics.conversionRate}%`;
            document.getElementById('average-score').textContent = metrics.averageScore;
            document.getElementById('avg-days-to-contact').textContent = metrics.avgDaysToContact;
            document.getElementById('active-team-members').textContent = metrics.activeTeamMembers;

            // Update status distribution
            updateStatusDistribution(metrics.statusDistribution);

            // Update priority distribution
            updatePriorityDistribution(metrics.priorityDistribution);
            
            // Update score distribution
            updateScoreDistribution();

            // Update industry insights
            updateIndustryInsights(metrics.industryInsights);

            // Update team performance
            updateTeamPerformance(metrics.teamPerformance);

            // Update trend analysis
            updateTrendAnalysis(metrics.trendAnalysis);

            // Update actionable insights
            updateActionableInsights(metrics.actionableInsights);
        }

        /**
         * Update status distribution chart
         */
        function updateStatusDistribution(statusData) {
            const container = document.getElementById('status-distribution');
            container.innerHTML = statusData.map(item => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3 flex-1">
                        <span class="text-sm font-medium text-gray-700 w-20">${item.status}</span>
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="progress-fill bg-blue-500 h-2 rounded-full" style="width: ${item.percentage}%"></div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-3">
                        <span class="text-sm text-gray-600">${item.count}</span>
                        <span class="text-xs text-gray-500">(${item.percentage}%)</span>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update priority distribution chart
         */
        function updatePriorityDistribution(priorityData) {
            const container = document.getElementById('priority-distribution');
            const priorityColors = {
                'High': 'bg-red-500',
                'Medium': 'bg-yellow-500',
                'Low': 'bg-green-500',
                'None': 'bg-gray-400'
            };

            container.innerHTML = priorityData.map(item => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3 flex-1">
                        <span class="text-sm font-medium text-gray-700 w-20">${item.priority}</span>
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="progress-fill ${priorityColors[item.priority]} h-2 rounded-full" style="width: ${item.percentage}%"></div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-3">
                        <span class="text-sm text-gray-600">${item.count}</span>
                        <span class="text-xs text-gray-500">(${item.percentage}%)</span>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update score distribution chart (Requirements 14.5, 14.8)
         */
        function updateScoreDistribution() {
            const container = document.getElementById('score-distribution');
            
            // Define score ranges
            const scoreRanges = [
                { label: 'High Priority (80-100)', min: 80, max: 100, color: 'bg-green-500' },
                { label: 'Medium Priority (60-79)', min: 60, max: 79, color: 'bg-yellow-500' },
                { label: 'Low Priority (40-59)', min: 40, max: 59, color: 'bg-blue-500' },
                { label: 'Very Low (0-39)', min: 0, max: 39, color: 'bg-gray-500' }
            ];
            
            // Calculate distribution
            const totalContacts = contacts.length;
            const scoreData = scoreRanges.map(range => {
                const count = contacts.filter(contact => {
                    const score = contact.score || 0;
                    return score >= range.min && score <= range.max;
                }).length;
                
                const percentage = totalContacts > 0 ? Math.round((count / totalContacts) * 100) : 0;
                
                return {
                    label: range.label,
                    count: count,
                    percentage: percentage,
                    color: range.color
                };
            });

            container.innerHTML = scoreData.map(item => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3 flex-1">
                        <span class="text-sm font-medium text-gray-700 w-32">${item.label}</span>
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="progress-fill ${item.color} h-2 rounded-full transition-all duration-300" style="width: ${item.percentage}%"></div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-3">
                        <span class="text-sm text-gray-600">${item.count}</span>
                        <span class="text-xs text-gray-500">(${item.percentage}%)</span>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update industry insights
         */
        function updateIndustryInsights(industryData) {
            const container = document.getElementById('industry-insights');
            
            if (industryData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No industry data available yet.</p>';
                return;
            }

            container.innerHTML = industryData.map(item => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-900">${item.industry}</span>
                            <span class="text-xs text-gray-500">${item.total} contacts</span>
                        </div>
                        <div class="flex items-center space-x-4 text-xs text-gray-600">
                            <span>Conversion: ${item.conversionRate}%</span>
                            <span>Avg Score: ${item.avgScore}</span>
                        </div>
                    </div>
                    <div class="ml-3">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${item.conversionRate > 20 ? 'bg-green-100 text-green-600' : item.conversionRate > 10 ? 'bg-yellow-100 text-yellow-600' : 'bg-red-100 text-red-600'}">
                            <span class="text-xs font-bold">${item.conversionRate}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update team performance
         */
        function updateTeamPerformance(teamData) {
            const container = document.getElementById('team-performance');
            
            if (teamData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No team performance data available yet.</p>';
                return;
            }

            container.innerHTML = teamData.map(member => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm font-medium text-gray-900">${member.member}</span>
                            <span class="text-xs text-gray-500">${member.assigned} assigned</span>
                        </div>
                        <div class="flex items-center space-x-4 text-xs text-gray-600">
                            <span>Converted: ${member.converted}</span>
                            <span>Rate: ${member.conversionRate}%</span>
                            <span>Avg Score: ${member.avgScore}</span>
                            <span>Recent Activity: ${member.recentActivity}</span>
                        </div>
                    </div>
                    <div class="ml-3">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${member.conversionRate > 20 ? 'bg-green-100 text-green-600' : member.conversionRate > 10 ? 'bg-yellow-100 text-yellow-600' : 'bg-red-100 text-red-600'}">
                            <span class="text-xs font-bold">${member.conversionRate}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update trend analysis
         */
        function updateTrendAnalysis(trendData) {
            const container = document.getElementById('trend-analysis');
            const trendIcon = trendData.trendDirection === 'up' ? '↗️' : trendData.trendDirection === 'down' ? '↘️' : '➡️';
            const trendColor = trendData.trendDirection === 'up' ? 'text-green-600' : trendData.trendDirection === 'down' ? 'text-red-600' : 'text-gray-600';

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="text-sm font-medium text-gray-900">Contact Acquisition</div>
                            <div class="text-xs text-gray-600">Last 30 days vs previous 30 days</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold ${trendColor}">${trendData.recentContacts} ${trendIcon}</div>
                            <div class="text-xs text-gray-500">${trendData.contactTrend > 0 ? '+' : ''}${trendData.contactTrend}%</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="text-sm font-medium text-gray-900">Recent Activity</div>
                            <div class="text-xs text-gray-600">Contacts engaged in last 30 days</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-blue-600">${trendData.recentActivity}</div>
                            <div class="text-xs text-gray-500">contacts</div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Update actionable insights
         */
        function updateActionableInsights(insights) {
            const container = document.getElementById('actionable-insights');
            
            if (insights.length === 0) {
                container.innerHTML = `
                    <div class="insight-card success p-4 rounded-lg">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-green-500 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h4 class="text-sm font-medium text-gray-900">All Good!</h4>
                                <p class="text-sm text-gray-600 mt-1">No immediate action items. Your contact management is on track.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = insights.map(insight => `
                <div class="insight-card ${insight.type} p-4 rounded-lg">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 ${insight.type === 'success' ? 'text-green-500' : insight.type === 'warning' ? 'text-yellow-500' : 'text-red-500'} mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            ${insight.type === 'success' ? 
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' :
                                insight.type === 'warning' ?
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>' :
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                            }
                        </svg>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900">${insight.title}</h4>
                            <p class="text-sm text-gray-600 mt-1">${insight.message}</p>
                            <p class="text-xs text-gray-500 mt-2 font-medium">💡 ${insight.action}</p>
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${insight.priority === 'high' ? 'bg-red-100 text-red-800' : insight.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                            ${insight.priority}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Render contacts table with enhanced functionality including pagination
         * Requirements: 1.1, 1.2, 4.1, 4.2, 4.3, 4.5, 9.1, 9.5
         */
        function renderContactsTable() {
            // Use performance optimizer for debounced rendering
            performanceOptimizer.debouncedRender(() => {
                renderContactsTableImmediate();
            });
        }
        
        /**
         * Immediate render function for contacts table
         */
        function renderContactsTableImmediate() {
            const tbody = document.getElementById('contacts-table-body');
            const mobileContainer = document.getElementById('mobile-contacts-list');
            const emptyState = document.getElementById('empty-state');

            if (filteredContacts.length === 0) {
                tbody.innerHTML = '';
                if (mobileContainer) mobileContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                document.getElementById('pagination-controls').classList.add('hidden');
                document.getElementById('mobile-pagination-controls').classList.add('hidden');
                document.getElementById('bulk-actions-bar').classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            document.getElementById('pagination-controls').classList.remove('hidden');
            document.getElementById('mobile-pagination-controls').classList.remove('hidden');

            // Calculate pagination
            totalPages = Math.ceil(filteredContacts.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredContacts.length);
            let pageContacts = filteredContacts.slice(startIndex, endIndex);
            
            // Apply performance optimizations for large datasets
            pageContacts = performanceOptimizer.optimizeContactRendering(pageContacts);

            tbody.innerHTML = pageContacts.map(contact => `
                <tr class="hover:bg-gray-50 ${getPriorityClass(contact.priority)} ${getFollowUpRowClass(contact.nextFollowUp)} transition-colors duration-150">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" 
                               class="contact-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" 
                               data-id="${contact.id}"
                               onchange="handleContactSelection('${contact.id}', this.checked)">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                    <span class="text-sm font-medium text-gray-700">
                                        ${(contact.name || '').charAt(0).toUpperCase()}
                                    </span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900" title="${contact.name || ''}">
                                    ${highlightSearchTerms(truncateText(contact.name || '', 25), getActiveSearchTerms())}
                                </div>
                                <div class="text-sm text-gray-500" title="${contact.title || ''}">
                                    ${highlightSearchTerms(truncateText(contact.title || '', 30), getActiveSearchTerms())}
                                </div>
                                ${contact.email ? `<div class="text-xs text-blue-600" title="${contact.email}">
                                    ${highlightSearchTerms(truncateText(contact.email, 25), getActiveSearchTerms())}
                                </div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900" title="${contact.company || ''}">
                            ${highlightSearchTerms(truncateText(contact.company || '', 20), getActiveSearchTerms())}
                        </div>
                        ${contact.industry ? `<div class="text-xs text-gray-500" title="${contact.industry}">
                            ${highlightSearchTerms(truncateText(contact.industry, 20), getActiveSearchTerms())}
                        </div>` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(contact.status)}">
                            ${contact.status || 'New'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${getPriorityBadgeClass(contact.priority)}">
                            ${getPriorityIcon(contact.priority)}
                            ${contact.priority || 'None'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center cursor-pointer group" onclick="showScoreBreakdown('${contact.id}')" 
                             title="Score: ${contact.score || 0}/100 - ${getScoreLabel(contact.score || 0)}${contact.manualScore ? ' (Manual Override)' : ' (Auto-calculated)'}\nClick for detailed breakdown">
                            <div class="text-sm font-medium ${getScoreColor(contact.score || 0)} group-hover:text-opacity-80">
                                ${contact.score || 0}
                                ${contact.manualScore ? '<span class="text-xs text-orange-600 ml-1">M</span>' : ''}
                            </div>
                            <div class="ml-2 w-16 bg-gray-200 rounded-full h-2 group-hover:bg-gray-300 transition-colors">
                                <div class="${getScoreBarColor(contact.score || 0)} h-2 rounded-full transition-all duration-300 group-hover:opacity-80" 
                                     style="width: ${Math.min((contact.score || 0), 100)}%"></div>
                            </div>
                            <div class="ml-1 text-xs ${getScoreColor(contact.score || 0)} group-hover:text-opacity-80">
                                ${getScoreLabel(contact.score || 0)}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap relevance-column" style="display: none;">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-blue-600">
                                ${(searchRelevanceScores.get(contact.id) || 0).toFixed(1)}
                            </div>
                            <div class="ml-2 w-12 bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${Math.min((searchRelevanceScores.get(contact.id) || 0) * 10, 100)}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${contact.assignee || 'Unassigned'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${getFollowUpDisplay(contact.nextFollowUp)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-end space-x-2">
                            ${contact.linkedin ? `
                                <a href="${contact.linkedin}" target="_blank" 
                                   class="text-blue-600 hover:text-blue-900" 
                                   title="View LinkedIn Profile">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                    </svg>
                                </a>
                            ` : ''}
                            <button onclick="openEditContactModal('${contact.id}')" 
                                    class="text-blue-600 hover:text-blue-900 font-medium"
                                    title="Edit Contact">
                                Edit
                            </button>
                            <button onclick="deleteContact('${contact.id}')" 
                                    class="text-red-600 hover:text-red-900 font-medium"
                                    title="Delete Contact">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Render mobile cards
            if (mobileContainer) {
                mobileContainer.innerHTML = pageContacts.map(contact => `
                    <div class="mobile-contact-card ${selectedContacts.has(contact.id) ? 'selected' : ''}" data-contact-id="${contact.id}">
                        <input type="checkbox" 
                               class="mobile-checkbox contact-checkbox" 
                               data-id="${contact.id}"
                               onchange="handleContactSelection('${contact.id}', this.checked)">
                        
                        <div class="mobile-card-header">
                            <div class="flex items-center flex-1">
                                <div class="mobile-card-avatar">
                                    ${(contact.name || '').charAt(0).toUpperCase()}
                                </div>
                                <div class="mobile-card-info">
                                    <div class="mobile-card-name">
                                        ${highlightSearchTerms(contact.name || '', getActiveSearchTerms())}
                                    </div>
                                    <div class="mobile-card-title">
                                        ${highlightSearchTerms(contact.title || '', getActiveSearchTerms())}
                                    </div>
                                    <div class="mobile-card-company">
                                        ${highlightSearchTerms(contact.company || '', getActiveSearchTerms())}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mobile-card-badges">
                            <span class="mobile-badge ${getStatusClass(contact.status)}">
                                ${contact.status || 'New'}
                            </span>
                            <span class="mobile-badge inline-flex items-center ${getPriorityBadgeClass(contact.priority)}">
                                ${getPriorityIcon(contact.priority)}
                                ${contact.priority || 'None'}
                            </span>
                        </div>

                        <div class="mobile-score-container" onclick="showScoreBreakdown('${contact.id}')">
                            <div class="mobile-score-value ${getScoreColor(contact.score || 0)}">
                                ${contact.score || 0}
                                ${contact.manualScore ? '<span class="text-xs text-orange-600 ml-1">M</span>' : ''}
                            </div>
                            <div class="mobile-score-bar">
                                <div class="mobile-score-fill ${getScoreBarColor(contact.score || 0)}" 
                                     style="width: ${Math.min((contact.score || 0), 100)}%"></div>
                            </div>
                            <div class="mobile-score-label ${getScoreColor(contact.score || 0)}">
                                ${getScoreLabel(contact.score || 0)}
                                ${contact.manualScore ? ' (Manual)' : ''}
                            </div>
                        </div>

                        <div class="mobile-card-details">
                            <div class="mobile-detail-item">
                                <div class="mobile-detail-label">Assignee</div>
                                <div class="mobile-detail-value">${contact.assignee || 'Unassigned'}</div>
                            </div>
                            <div class="mobile-detail-item">
                                <div class="mobile-detail-label">Follow-up</div>
                                <div class="mobile-detail-value">${getFollowUpDisplay(contact.nextFollowUp)}</div>
                            </div>
                            ${contact.email ? `
                                <div class="mobile-detail-item">
                                    <div class="mobile-detail-label">Email</div>
                                    <div class="mobile-detail-value text-blue-600">${truncateText(contact.email, 25)}</div>
                                </div>
                            ` : ''}
                            ${contact.industry ? `
                                <div class="mobile-detail-item">
                                    <div class="mobile-detail-label">Industry</div>
                                    <div class="mobile-detail-value">${contact.industry}</div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="mobile-card-actions">
                            <div class="mobile-action-buttons">
                                ${contact.linkedin ? `
                                    <a href="${contact.linkedin}" target="_blank" 
                                       class="mobile-action-btn" 
                                       title="View LinkedIn Profile">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                        </svg>
                                    </a>
                                ` : ''}
                                <button onclick="openEditContactModal('${contact.id}')" 
                                        class="mobile-action-btn primary">
                                    Edit
                                </button>
                                <button onclick="deleteContact('${contact.id}')" 
                                        class="mobile-action-btn danger">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Update checkbox states based on selected contacts
            updateCheckboxStates();

            // Update pagination controls
            updatePaginationControls();

            // Update bulk actions visibility
            updateBulkActionButtons();
        }

        /**
         * Update checkbox states after table render
         */
        function updateCheckboxStates() {
            document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
                checkbox.checked = selectedContacts.has(checkbox.dataset.id);
            });
        }

        /**
         * Truncate text to specified length
         */
        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength - 3) + '...';
        }

        function getPriorityClass(priority) {
            switch (priority) {
                case 'High': return 'priority-high';
                case 'Medium': return 'priority-medium';
                case 'Low': return 'priority-low';
                default: return 'priority-none';
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'New': return 'status-new';
                case 'Contacted': return 'status-contacted';
                case 'Qualified': return 'status-qualified';
                case 'Converted': return 'status-converted';
                case 'Inactive': return 'status-inactive';
                default: return 'status-new';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch (priority) {
                case 'High': return 'bg-red-100 text-red-800 border border-red-200';
                case 'Medium': return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                case 'Low': return 'bg-green-100 text-green-800 border border-green-200';
                default: return 'bg-gray-100 text-gray-800 border border-gray-200';
            }
        }

        function getPriorityIcon(priority) {
            switch (priority) {
                case 'High': 
                    return '<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path></svg>';
                case 'Medium': 
                    return '<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>';
                case 'Low': 
                    return '<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-10.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 7.414V11a1 1 0 102 0V7.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path></svg>';
                default: 
                    return '<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm0-2a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd"></path></svg>';
            }
        }

        // ============================================
        // ENHANCED SCORE DISPLAY FUNCTIONS
        // ============================================

        function getScoreColor(score) {
            const displayInfo = scoringEngine.getScoreDisplayInfo(score);
            return displayInfo.color;
        }

        function getScoreBarColor(score) {
            const displayInfo = scoringEngine.getScoreDisplayInfo(score);
            return displayInfo.barColor;
        }

        function getScoreLabel(score) {
            const displayInfo = scoringEngine.getScoreDisplayInfo(score);
            return displayInfo.label;
        }

        function showScoreBreakdown(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;

            // Recalculate score and breakdown to ensure it's current
            const score = scoringEngine.calculateScore(contact);
            const breakdown = scoringEngine.getScoreBreakdown(contact);

            // Create breakdown modal content
            const breakdownHtml = `
                <div class="fixed inset-0 z-50 overflow-y-auto">
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div class="fixed inset-0 transition-opacity modal-overlay" onclick="closeScoreBreakdown()"></div>
                        
                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
                        
                        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="flex items-center mb-4">
                                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full ${scoringEngine.getScoreDisplayInfo(score).bgColor} sm:mx-0 sm:h-10 sm:w-10">
                                        <span class="text-lg font-bold ${scoringEngine.getScoreDisplayInfo(score).color}">${score}</span>
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-lg leading-6 font-medium text-gray-900">Score Breakdown</h3>
                                        <p class="text-sm text-gray-500">${contact.name} - ${scoringEngine.getScoreDisplayInfo(score).label}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">Title Seniority</div>
                                            <div class="text-xs text-gray-500">${contact.title || 'Not specified'}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-bold text-gray-900">${breakdown.title}/40</div>
                                            <div class="w-16 bg-gray-200 rounded-full h-2 mt-1">
                                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${(breakdown.title / 40) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">Industry Relevance</div>
                                            <div class="text-xs text-gray-500">${contact.industry || 'Not specified'}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-bold text-gray-900">${breakdown.industry}/30</div>
                                            <div class="w-16 bg-gray-200 rounded-full h-2 mt-1">
                                                <div class="bg-green-500 h-2 rounded-full" style="width: ${(breakdown.industry / 30) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">Company Type</div>
                                            <div class="text-xs text-gray-500">${contact.type || 'Individual'}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-bold text-gray-900">${breakdown.companyType}/20</div>
                                            <div class="w-16 bg-gray-200 rounded-full h-2 mt-1">
                                                <div class="bg-purple-500 h-2 rounded-full" style="width: ${(breakdown.companyType / 20) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">Engagement Level</div>
                                            <div class="text-xs text-gray-500">${contact.status || 'New'}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-bold text-gray-900">${breakdown.engagement}/10</div>
                                            <div class="w-16 bg-gray-200 rounded-full h-2 mt-1">
                                                <div class="bg-yellow-500 h-2 rounded-full" style="width: ${(breakdown.engagement / 10) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="border-t pt-4">
                                        <div class="flex justify-between items-center">
                                            <div class="text-lg font-medium text-gray-900">Total Score</div>
                                            <div class="text-lg font-bold ${scoringEngine.getScoreDisplayInfo(score).color}">${score}/100</div>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-3 mt-2">
                                            <div class="${scoringEngine.getScoreDisplayInfo(score).barColor} h-3 rounded-full transition-all duration-500" style="width: ${score}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="button" onclick="closeScoreBreakdown()" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:w-auto sm:text-sm">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            const modalContainer = document.createElement('div');
            modalContainer.id = 'score-breakdown-modal';
            modalContainer.innerHTML = breakdownHtml;
            document.body.appendChild(modalContainer);

            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeScoreBreakdown() {
            const modal = document.getElementById('score-breakdown-modal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = 'auto';
        }

        // ============================================
        // MANUAL SCORE ADJUSTMENT FUNCTIONS
        // ============================================

        /**
         * Recalculate the automatic score for the contact being edited
         */
        function recalculateContactScore() {
            // Get current form data
            const formData = {
                name: document.getElementById('contact-name').value,
                title: document.getElementById('contact-title').value,
                company: document.getElementById('contact-company').value,
                industry: document.getElementById('contact-industry').value,
                type: document.getElementById('contact-type').value,
                status: document.getElementById('contact-status').value,
                lastContacted: currentEditId ? (contacts.find(c => c.id === currentEditId)?.lastContacted || null) : null
            };

            // Calculate automatic score
            const autoScore = scoringEngine.calculateScore(formData);
            
            // Update the automatic score display
            updateScoreDisplays(autoScore, null);
            
            showNotification('Automatic score recalculated based on current form data', 'success');
        }

        /**
         * Update all score displays in the contact form
         * @param {number} autoScore - The automatic calculated score
         * @param {number|null} manualScore - The manual override score (null if not set)
         */
        function updateScoreDisplays(autoScore, manualScore) {
            // Update automatic score display
            document.getElementById('contact-auto-score').value = autoScore;
            const autoScoreBar = document.getElementById('auto-score-bar');
            const autoScoreLabel = document.getElementById('auto-score-label');
            const autoDisplayInfo = scoringEngine.getScoreDisplayInfo(autoScore);
            
            autoScoreBar.style.width = `${autoScore}%`;
            autoScoreBar.className = `h-2 rounded-full transition-all duration-300 ${autoDisplayInfo.barColor}`;
            autoScoreLabel.textContent = autoDisplayInfo.label;
            autoScoreLabel.className = `text-xs ${autoDisplayInfo.color}`;

            // Update manual score display
            const manualScoreInput = document.getElementById('contact-manual-score');
            const manualScoreBar = document.getElementById('manual-score-bar');
            const manualScoreLabel = document.getElementById('manual-score-label');
            
            if (manualScore !== null && manualScore !== undefined && manualScore !== '') {
                const manualDisplayInfo = scoringEngine.getScoreDisplayInfo(manualScore);
                manualScoreBar.style.width = `${manualScore}%`;
                manualScoreBar.className = `h-2 rounded-full transition-all duration-300 ${manualDisplayInfo.barColor}`;
                manualScoreLabel.textContent = manualDisplayInfo.label;
                manualScoreLabel.className = `text-xs ${manualDisplayInfo.color}`;
            } else {
                manualScoreBar.style.width = '0%';
                manualScoreBar.className = 'h-2 rounded-full transition-all duration-300 bg-gray-300';
                manualScoreLabel.textContent = 'Auto';
                manualScoreLabel.className = 'text-xs text-gray-600';
            }

            // Update final score display
            const finalScore = (manualScore !== null && manualScore !== undefined && manualScore !== '') ? manualScore : autoScore;
            const finalDisplayInfo = scoringEngine.getScoreDisplayInfo(finalScore);
            
            document.getElementById('final-score-value').textContent = finalScore;
            document.getElementById('final-score-value').className = `text-lg font-bold ${finalDisplayInfo.color}`;
            
            const finalScoreSource = document.getElementById('final-score-source');
            finalScoreSource.textContent = (manualScore !== null && manualScore !== undefined && manualScore !== '') ? '(manual override)' : '(automatic)';
            finalScoreSource.className = (manualScore !== null && manualScore !== undefined && manualScore !== '') ? 'text-xs text-orange-600' : 'text-xs text-gray-500';
            
            const finalScoreBar = document.getElementById('final-score-bar');
            finalScoreBar.style.width = `${finalScore}%`;
            finalScoreBar.className = `h-3 rounded-full transition-all duration-300 ${finalDisplayInfo.barColor}`;
        }

        /**
         * Quick filter for high-priority contacts (Requirements 8.5)
         */
        function showHighPriorityContacts() {
            // Clear all filters first
            clearAllFilters();
            
            // Set priority filter to High
            document.getElementById('priority-filter').value = 'High';
            
            // Apply filters
            applyFilters();
            
            // Show notification
            showNotification('Showing high-priority contacts only', 'info');
        }

        /**
         * Quick filter for high-scoring contacts (Requirements 14.5, 14.8)
         */
        function showHighScoreContacts() {
            // Clear all filters first
            clearAllFilters();
            
            // Set score filter to high range
            document.getElementById('score-filter').value = '80-100';
            
            // Apply filters
            applyFilters();
            
            // Show notification
            showNotification('Showing high-scoring contacts (80-100 points)', 'info');
        }

        /**
         * Setup event listeners for score management
         */
        function setupScoreManagementListeners() {
            // Listen for changes in form fields that affect automatic scoring
            const scoringFields = ['contact-title', 'contact-industry', 'contact-type', 'contact-status'];
            scoringFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', () => {
                        // Recalculate automatic score when relevant fields change
                        const formData = {
                            name: document.getElementById('contact-name').value,
                            title: document.getElementById('contact-title').value,
                            company: document.getElementById('contact-company').value,
                            industry: document.getElementById('contact-industry').value,
                            type: document.getElementById('contact-type').value,
                            status: document.getElementById('contact-status').value,
                            lastContacted: currentEditId ? (contacts.find(c => c.id === currentEditId)?.lastContacted || null) : null
                        };
                        
                        const autoScore = scoringEngine.calculateScore(formData);
                        const manualScore = document.getElementById('contact-manual-score').value;
                        updateScoreDisplays(autoScore, manualScore || null);
                    });
                }
            });

            // Listen for manual score changes
            const manualScoreInput = document.getElementById('contact-manual-score');
            if (manualScoreInput) {
                manualScoreInput.addEventListener('input', (e) => {
                    const autoScore = parseInt(document.getElementById('contact-auto-score').value) || 0;
                    const manualScore = e.target.value ? parseInt(e.target.value) : null;
                    updateScoreDisplays(autoScore, manualScore);
                });
            }
        }

        /**
         * Recalculate scores for all contacts (Requirements 14.1)
         * This ensures all contacts have current scores based on the latest algorithm
         */
        function recalculateAllContactScores() {
            console.log('Recalculating scores for all contacts...');

            contacts = contacts.map(contact => {
                const score = calculateContactScore(contact);
                const scoreBreakdown = getScoreBreakdown(contact);

                return {
                    ...contact,
                    score: score,
                    scoreBreakdown: scoreBreakdown
                };
            });

            // Update filtered contacts as well
            applyFilters();
            updateDashboardStats();

            console.log('Score recalculation complete for', contacts.length, 'contacts');
        }

        /**
         * Test function to verify scoring engine functionality
         * This can be called from browser console for testing
         */
        function testScoringEngine() {
            console.log('Testing Scoring Engine...');

            // Test contact data
            const testContacts = [
                {
                    name: 'John Smith',
                    title: 'CEO',
                    company: 'Green Tech Solutions',
                    industry: 'Sustainability',
                    type: 'Company',
                    status: 'Qualified',
                    email: 'john@greentech.com'
                },
                {
                    name: 'Jane Doe',
                    title: 'Manager',
                    company: 'Finance Corp',
                    industry: 'Finance',
                    type: 'Individual',
                    status: 'New',
                    email: 'jane@finance.com'
                },
                {
                    name: 'Bob Wilson',
                    title: 'Specialist',
                    company: 'Media Company',
                    industry: 'Media',
                    type: 'Company',
                    status: 'Contacted',
                    email: 'bob@media.com'
                }
            ];

            testContacts.forEach(contact => {
                const score = scoringEngine.calculateScore(contact);
                const breakdown = scoringEngine.getScoreBreakdown(contact);
                const displayInfo = scoringEngine.getScoreDisplayInfo(score);

                console.log(`\n${contact.name} (${contact.title} at ${contact.company}):`);
                console.log(`  Total Score: ${score}/100 (${displayInfo.label})`);
                console.log(`  Breakdown:`, breakdown);
                console.log(`  Title: ${breakdown.title}/40, Industry: ${breakdown.industry}/30, Type: ${breakdown.companyType}/20, Engagement: ${breakdown.engagement}/10`);
            });

            console.log('\nScoring Engine test completed successfully!');
        }

        // ============================================
        // SEARCH AND FILTER FUNCTIONS
        // ============================================

        /**
         * Handle search input with debouncing
         * Requirements: 4.1, 4.2
         */
        function handleSearch() {
            // Use performance optimizer for debounced search
            performanceOptimizer.debouncedSearch(() => {
                applyFilters();
            });
        }

        /**
         * Handle filter changes
         * Requirements: 4.2, 4.3
         */
        function handleFilter() {
            applyFilters();
            updateFilterCount();
        }

        /**
         * Apply all active filters and search criteria with advanced features
         * Requirements: 4.1, 4.2, 4.3, 4.4, 4.5
         */
        function applyFilters() {
            // Clear previous relevance scores
            searchRelevanceScores.clear();

            // Get search logic (AND/OR)
            const searchLogic = document.querySelector('input[name="search-logic"]:checked')?.value || 'and';
            
            // Basic search
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            // Multi-field search
            const searchName = document.getElementById('search-name')?.value.toLowerCase().trim() || '';
            const searchCompany = document.getElementById('search-company')?.value.toLowerCase().trim() || '';
            const searchTitle = document.getElementById('search-title')?.value.toLowerCase().trim() || '';
            const searchEmail = document.getElementById('search-email')?.value.toLowerCase().trim() || '';
            const searchIndustry = document.getElementById('search-industry')?.value.toLowerCase().trim() || '';
            const searchNotes = document.getElementById('search-notes')?.value.toLowerCase().trim() || '';
            
            // Basic filters
            const statusFilter = document.getElementById('status-filter').value;
            const assigneeFilter = document.getElementById('assignee-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;
            const scoreFilter = document.getElementById('score-filter') ? document.getElementById('score-filter').value : '';
            const typeFilter = document.getElementById('type-filter').value;
            const industryFilter = document.getElementById('industry-filter').value;

            // Advanced filters
            const dateAddedFrom = document.getElementById('date-added-from').value;
            const dateAddedTo = document.getElementById('date-added-to').value;
            const lastContactedFrom = document.getElementById('last-contacted-from').value;
            const lastContactedTo = document.getElementById('last-contacted-to').value;
            const followupFilter = document.getElementById('followup-filter').value;
            const linkedinFilter = document.getElementById('linkedin-filter').value;
            const phoneFilter = document.getElementById('phone-filter').value;
            const scoreMin = document.getElementById('score-min').value;
            const scoreMax = document.getElementById('score-max').value;

            filteredContacts = contacts.filter(contact => {
                let relevanceScore = 0;
                let searchMatches = [];

                // Multi-field search with relevance scoring (Requirements 4.1, 4.5)
                if (searchTerm) {
                    const fields = [
                        { field: contact.name, weight: 3 },
                        { field: contact.company, weight: 2.5 },
                        { field: contact.title, weight: 2 },
                        { field: contact.email, weight: 1.5 },
                        { field: contact.industry, weight: 1 },
                        { field: contact.notes, weight: 0.5 }
                    ];
                    
                    fields.forEach(({ field, weight }) => {
                        if (field && field.toLowerCase().includes(searchTerm)) {
                            relevanceScore += weight;
                            searchMatches.push(true);
                        } else {
                            searchMatches.push(false);
                        }
                    });
                }

                // Individual field searches with relevance scoring
                const fieldSearches = [
                    { value: searchName, field: contact.name, weight: 3 },
                    { value: searchCompany, field: contact.company, weight: 2.5 },
                    { value: searchTitle, field: contact.title, weight: 2 },
                    { value: searchEmail, field: contact.email, weight: 1.5 },
                    { value: searchIndustry, field: contact.industry, weight: 1 },
                    { value: searchNotes, field: contact.notes, weight: 0.5 }
                ];

                let fieldMatches = [];
                fieldSearches.forEach(({ value, field, weight }) => {
                    if (value) {
                        if (field && field.toLowerCase().includes(value)) {
                            relevanceScore += weight;
                            fieldMatches.push(true);
                        } else {
                            fieldMatches.push(false);
                        }
                    }
                });

                // Determine if search criteria match based on logic
                let matchesSearch = true;
                const hasSearchTerms = searchTerm || searchName || searchCompany || searchTitle || searchEmail || searchIndustry || searchNotes;
                
                if (hasSearchTerms) {
                    const allMatches = [...searchMatches, ...fieldMatches];
                    if (searchLogic === 'and') {
                        matchesSearch = allMatches.every(match => match);
                    } else {
                        matchesSearch = allMatches.some(match => match);
                    }
                }

                // Store relevance score for sorting
                if (relevanceScore > 0) {
                    searchRelevanceScores.set(contact.id, relevanceScore);
                }

                // Basic filters (Requirements 4.2)
                const matchesStatus = !statusFilter || contact.status === statusFilter;
                const matchesAssignee = !assigneeFilter || contact.assignee === assigneeFilter;
                const matchesPriority = !priorityFilter || contact.priority === priorityFilter;
                const matchesType = !typeFilter || contact.type === typeFilter;
                const matchesIndustry = !industryFilter || contact.industry === industryFilter;

                // Score range filter (Requirements 4.2)
                let matchesScore = true;
                if (scoreFilter) {
                    const score = contact.score || 0;
                    const [minScore, maxScore] = scoreFilter.split('-').map(Number);
                    matchesScore = score >= minScore && score <= maxScore;
                }

                // Advanced score range filter
                let matchesAdvancedScore = true;
                if (scoreMin || scoreMax) {
                    const score = contact.score || 0;
                    const min = scoreMin ? parseInt(scoreMin) : 0;
                    const max = scoreMax ? parseInt(scoreMax) : 100;
                    matchesAdvancedScore = score >= min && score <= max;
                }

                // Date filters
                let matchesDateAdded = true;
                if (dateAddedFrom || dateAddedTo) {
                    const contactDate = new Date(contact.dateAdded);
                    if (dateAddedFrom) {
                        matchesDateAdded = matchesDateAdded && contactDate >= new Date(dateAddedFrom);
                    }
                    if (dateAddedTo) {
                        matchesDateAdded = matchesDateAdded && contactDate <= new Date(dateAddedTo + 'T23:59:59');
                    }
                }

                let matchesLastContacted = true;
                if (lastContactedFrom || lastContactedTo) {
                    if (!contact.lastContacted) {
                        matchesLastContacted = false;
                    } else {
                        const contactDate = new Date(contact.lastContacted);
                        if (lastContactedFrom) {
                            matchesLastContacted = matchesLastContacted && contactDate >= new Date(lastContactedFrom);
                        }
                        if (lastContactedTo) {
                            matchesLastContacted = matchesLastContacted && contactDate <= new Date(lastContactedTo + 'T23:59:59');
                        }
                    }
                }

                // Follow-up filter
                let matchesFollowup = true;
                if (followupFilter) {
                    const today = new Date();
                    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

                    switch (followupFilter) {
                        case 'overdue':
                            matchesFollowup = contact.nextFollowUp && new Date(contact.nextFollowUp) < today;
                            break;
                        case 'due-today':
                            matchesFollowup = contact.nextFollowUp &&
                                new Date(contact.nextFollowUp).toDateString() === today.toDateString();
                            break;
                        case 'due-this-week':
                            matchesFollowup = contact.nextFollowUp &&
                                new Date(contact.nextFollowUp) >= today &&
                                new Date(contact.nextFollowUp) <= nextWeek;
                            break;
                        case 'no-followup':
                            matchesFollowup = !contact.nextFollowUp;
                            break;
                    }
                }

                // LinkedIn filter
                let matchesLinkedIn = true;
                if (linkedinFilter) {
                    matchesLinkedIn = linkedinFilter === 'yes' ?
                        (contact.linkedin && contact.linkedin.trim()) :
                        (!contact.linkedin || !contact.linkedin.trim());
                }

                // Phone filter
                let matchesPhone = true;
                if (phoneFilter) {
                    matchesPhone = phoneFilter === 'yes' ?
                        (contact.phone && contact.phone.trim()) :
                        (!contact.phone || !contact.phone.trim());
                }

                // Apply filter logic (Requirements 4.3)
                if (searchLogic === 'and') {
                    return matchesSearch && matchesStatus && matchesAssignee && matchesPriority &&
                        matchesType && matchesIndustry && matchesScore && matchesAdvancedScore &&
                        matchesDateAdded && matchesLastContacted && matchesFollowup &&
                        matchesLinkedIn && matchesPhone;
                } else {
                    // OR logic - at least one criteria must match
                    return matchesSearch || matchesStatus || matchesAssignee || matchesPriority ||
                        matchesType || matchesIndustry || matchesScore || matchesAdvancedScore ||
                        matchesDateAdded || matchesLastContacted || matchesFollowup ||
                        matchesLinkedIn || matchesPhone;
                }
            });

            // Apply current sort with relevance scoring
            applySorting();

            // Reset to first page when filters change (except when called from pagination)
            if (currentPage > 1 && filteredContacts.length <= (currentPage - 1) * itemsPerPage) {
                currentPage = 1;
            }

            // Show/hide relevance column based on search activity
            const hasSearchTerms = searchTerm || searchName || searchCompany || searchTitle || searchEmail || searchIndustry || searchNotes;
            const relevanceHeader = document.getElementById('relevance-header');
            const relevanceColumns = document.querySelectorAll('.relevance-column');
            
            if (hasSearchTerms && searchRelevanceScores.size > 0) {
                if (relevanceHeader) relevanceHeader.style.display = '';
                relevanceColumns.forEach(col => col.style.display = '');
            } else {
                if (relevanceHeader) relevanceHeader.style.display = 'none';
                relevanceColumns.forEach(col => col.style.display = 'none');
            }

            // Update UI
            renderContactsTable();
            updateFilterCount();
        }

        /**
         * Update filter count display
         * Requirements: 4.5
         */
        function updateFilterCount() {
            const activeFilters = getActiveFilterCount();
            const searchTerm = document.getElementById('search-input').value.trim();

            // Update contacts table header with filter info
            const tableHeader = document.querySelector('.bg-white.shadow h3');
            if (tableHeader) {
                let headerText = 'Contacts';

                if (activeFilters > 0 || searchTerm) {
                    headerText += ` (${filteredContacts.length} of ${contacts.length}`;
                    if (activeFilters > 0) {
                        headerText += `, ${activeFilters} filter${activeFilters > 1 ? 's' : ''} active`;
                    }
                    if (searchTerm) {
                        headerText += `, searching "${searchTerm}"`;
                    }
                    headerText += ')';
                } else {
                    headerText += ` (${contacts.length})`;
                }

                tableHeader.textContent = headerText;
            }
        }

        /**
         * Get count of active filters
         */
        function getActiveFilterCount() {
            let count = 0;

            // Basic filters
            if (document.getElementById('status-filter').value) count++;
            if (document.getElementById('assignee-filter').value) count++;
            if (document.getElementById('priority-filter').value) count++;
            if (document.getElementById('type-filter').value) count++;
            if (document.getElementById('industry-filter').value) count++;
            if (document.getElementById('score-filter') && document.getElementById('score-filter').value) count++;

            // Advanced filters
            if (document.getElementById('date-added-from').value) count++;
            if (document.getElementById('date-added-to').value) count++;
            if (document.getElementById('last-contacted-from').value) count++;
            if (document.getElementById('last-contacted-to').value) count++;
            if (document.getElementById('followup-filter').value) count++;
            if (document.getElementById('linkedin-filter').value) count++;
            if (document.getElementById('phone-filter').value) count++;
            if (document.getElementById('score-min').value) count++;
            if (document.getElementById('score-max').value) count++;

            return count;
        }

        /**
         * Clear all filters and search
         * Requirements: 4.4
         */
        function clearAllFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('assignee-filter').value = '';
            document.getElementById('priority-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('industry-filter').value = '';
            if (document.getElementById('score-filter')) {
                document.getElementById('score-filter').value = '';
            }

            // Reset search logic to AND
            const andRadio = document.getElementById('search-logic-and');
            if (andRadio) andRadio.checked = true;

            // Clear advanced filters
            clearAdvancedFilters();
        }

        /**
         * Apply sorting to filtered contacts with relevance scoring
         * Requirements: 4.5
         */
        function applySorting() {
            if (!currentSort.field) {
                // If no explicit sort is set and we have search relevance scores, sort by relevance
                if (searchRelevanceScores.size > 0) {
                    filteredContacts.sort((a, b) => {
                        const aRelevance = searchRelevanceScores.get(a.id) || 0;
                        const bRelevance = searchRelevanceScores.get(b.id) || 0;
                        return bRelevance - aRelevance; // Higher relevance first
                    });
                }
                return;
            }

            filteredContacts.sort((a, b) => {
                let aValue = a[currentSort.field] || '';
                let bValue = b[currentSort.field] || '';

                // Handle relevance sorting
                if (currentSort.field === 'relevance') {
                    aValue = searchRelevanceScores.get(a.id) || 0;
                    bValue = searchRelevanceScores.get(b.id) || 0;
                } else if (currentSort.field === 'score') {
                    aValue = Number(aValue) || 0;
                    bValue = Number(bValue) || 0;
                } else if (currentSort.field === 'dateAdded' || currentSort.field === 'lastModified') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                } else {
                    aValue = String(aValue).toLowerCase();
                    bValue = String(bValue).toLowerCase();
                }

                let comparison = 0;
                if (aValue < bValue) comparison = -1;
                if (aValue > bValue) comparison = 1;

                return currentSort.direction === 'desc' ? -comparison : comparison;
            });
        }

        /**
         * Handle table column sorting
         */
        function handleSort(field) {
            if (currentSort.field === field) {
                // Toggle direction if same field
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New field, default to ascending
                currentSort.field = field;
                currentSort.direction = 'asc';
            }

            applyFilters(); // This will apply sorting through applySorting()
            updateSortIndicators();
        }

        /**
         * Update visual sort indicators in table headers
         */
        function updateSortIndicators() {
            // Remove existing sort indicators
            document.querySelectorAll('[data-sort]').forEach(header => {
                const svg = header.querySelector('svg');
                if (svg) {
                    svg.className = 'w-4 h-4 inline ml-1 text-gray-400';
                }
            });

            // Add indicator to current sort field
            const currentHeader = document.querySelector(`[data-sort="${currentSort.field}"]`);
            if (currentHeader) {
                const svg = currentHeader.querySelector('svg');
                if (svg) {
                    svg.className = `w-4 h-4 inline ml-1 ${currentSort.direction === 'asc' ? 'text-blue-600' : 'text-blue-600 transform rotate-180'}`;
                }
            }
        }

        /**
         * Handle select all checkbox
         */
        function handleSelectAll(e) {
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
                if (e.target.checked) {
                    selectedContacts.add(checkbox.dataset.id);
                } else {
                    selectedContacts.delete(checkbox.dataset.id);
                }
            });
            updateBulkActionButtons();
        }

        /**
         * Handle individual contact selection
         */
        function handleContactSelection(contactId, isSelected) {
            if (isSelected) {
                selectedContacts.add(contactId);
            } else {
                selectedContacts.delete(contactId);
            }

            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('select-all');
            const allCheckboxes = document.querySelectorAll('.contact-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.contact-checkbox:checked');

            if (checkedCheckboxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedCheckboxes.length === allCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }

            updateBulkActionButtons();
        }

        /**
         * Update bulk action button visibility
         */
        function updateBulkActionButtons() {
            const selectedCount = selectedContacts.size;
            const bulkActionsBar = document.getElementById('bulk-actions-bar');
            const selectedCountSpan = document.getElementById('selected-count');

            if (selectedCount > 0) {
                bulkActionsBar.classList.remove('hidden');
                selectedCountSpan.textContent = `${selectedCount} contact${selectedCount > 1 ? 's' : ''} selected`;
            } else {
                bulkActionsBar.classList.add('hidden');
            }
        }

        // ============================================
        // PAGINATION FUNCTIONS
        // ============================================

        /**
         * Update pagination controls
         * Requirements: 1.1, 1.2
         */
        function updatePaginationControls() {
            const startItem = filteredContacts.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
            const endItem = Math.min(currentPage * itemsPerPage, filteredContacts.length);

            document.getElementById('showing-start').textContent = startItem;
            document.getElementById('showing-end').textContent = endItem;
            document.getElementById('total-contacts-count').textContent = filteredContacts.length;

            // Update page numbers
            const pageNumbers = document.getElementById('page-numbers');
            pageNumbers.innerHTML = '';

            // Calculate page range to show
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Adjust start page if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // Add first page and ellipsis if needed
            if (startPage > 1) {
                pageNumbers.appendChild(createPageButton(1));
                if (startPage > 2) {
                    pageNumbers.appendChild(createEllipsis());
                }
            }

            // Add visible page numbers
            for (let i = startPage; i <= endPage; i++) {
                pageNumbers.appendChild(createPageButton(i));
            }

            // Add ellipsis and last page if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pageNumbers.appendChild(createEllipsis());
                }
                pageNumbers.appendChild(createPageButton(totalPages));
            }

            // Update prev/next button states
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
        }

        /**
         * Create page button element
         */
        function createPageButton(pageNum) {
            const button = document.createElement('button');
            button.textContent = pageNum;
            button.onclick = () => goToPage(pageNum);
            button.className = `px-3 py-1 border rounded text-sm ${pageNum === currentPage
                    ? 'bg-blue-600 text-white border-blue-600'
                    : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                }`;
            return button;
        }

        /**
         * Create ellipsis element
         */
        function createEllipsis() {
            const span = document.createElement('span');
            span.textContent = '...';
            span.className = 'px-2 py-1 text-gray-500';
            return span;
        }

        /**
         * Go to specific page
         * Requirements: 1.1, 1.2
         */
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderContactsTable();
        }

        /**
         * Change items per page
         * Requirements: 1.1, 1.2
         */
        function changeItemsPerPage(newItemsPerPage) {
            itemsPerPage = parseInt(newItemsPerPage);
            currentPage = 1; // Reset to first page
            renderContactsTable();
        }

        // ============================================
        // ADVANCED FILTERING FUNCTIONS
        // ============================================

        /**
         * Toggle advanced filters panel
         * Requirements: 4.1, 4.2, 4.3
         */
        function toggleAdvancedFilters() {
            const panel = document.getElementById('advanced-filters-panel');
            const button = document.getElementById('advanced-filters-btn');

            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                button.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                    </svg>
                    Hide Advanced
                `;
                populateIndustryFilter();
            } else {
                panel.classList.add('hidden');
                button.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                    </svg>
                    Advanced
                `;
            }
        }

        /**
         * Populate industry filter with unique industries from contacts
         * Requirements: 4.2
         */
        function populateIndustryFilter() {
            const industryFilter = document.getElementById('industry-filter');
            const industries = [...new Set(contacts.map(c => c.industry).filter(i => i && i.trim()))].sort();

            // Clear existing options except the first one
            industryFilter.innerHTML = '<option value="">All Industries</option>';

            industries.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                industryFilter.appendChild(option);
            });
        }

        /**
         * Apply advanced filters
         * Requirements: 4.1, 4.2, 4.3
         */
        function applyAdvancedFilters() {
            currentPage = 1; // Reset to first page when applying filters
            applyFilters();
        }

        /**
         * Clear advanced filters
         * Requirements: 4.4
         */
        function clearAdvancedFilters() {
            document.getElementById('date-added-from').value = '';
            document.getElementById('date-added-to').value = '';
            document.getElementById('last-contacted-from').value = '';
            document.getElementById('last-contacted-to').value = '';
            document.getElementById('followup-filter').value = '';
            document.getElementById('linkedin-filter').value = '';
            document.getElementById('phone-filter').value = '';
            document.getElementById('score-min').value = '';
            document.getElementById('score-max').value = '';
            
            // Clear multi-field searches
            if (document.getElementById('search-name')) document.getElementById('search-name').value = '';
            if (document.getElementById('search-company')) document.getElementById('search-company').value = '';
            if (document.getElementById('search-title')) document.getElementById('search-title').value = '';
            if (document.getElementById('search-email')) document.getElementById('search-email').value = '';
            if (document.getElementById('search-industry')) document.getElementById('search-industry').value = '';
            if (document.getElementById('search-notes')) document.getElementById('search-notes').value = '';

            applyAdvancedFilters();
        }

        // ============================================
        // SAVED SEARCH FUNCTIONS
        // ============================================

        /**
         * Show save search modal
         * Requirements: 4.1, 4.2, 4.3
         */
        function showSaveSearchModal() {
            const modal = document.getElementById('save-search-modal');
            const summary = document.getElementById('search-summary');
            
            // Generate search summary
            const searchSummary = generateSearchSummary();
            summary.innerHTML = searchSummary;
            
            // Clear previous input
            document.getElementById('search-preset-name').value = '';
            
            modal.classList.remove('hidden');
        }

        /**
         * Generate search summary for display
         * Requirements: 4.1, 4.2, 4.3
         */
        function generateSearchSummary() {
            const criteria = [];
            
            // Basic search
            const searchTerm = document.getElementById('search-input').value.trim();
            if (searchTerm) {
                criteria.push(`<strong>General Search:</strong> "${searchTerm}"`);
            }
            
            // Multi-field searches
            const searchName = document.getElementById('search-name')?.value.trim();
            const searchCompany = document.getElementById('search-company')?.value.trim();
            const searchTitle = document.getElementById('search-title')?.value.trim();
            const searchEmail = document.getElementById('search-email')?.value.trim();
            const searchIndustry = document.getElementById('search-industry')?.value.trim();
            const searchNotes = document.getElementById('search-notes')?.value.trim();
            
            if (searchName) criteria.push(`<strong>Name:</strong> "${searchName}"`);
            if (searchCompany) criteria.push(`<strong>Company:</strong> "${searchCompany}"`);
            if (searchTitle) criteria.push(`<strong>Title:</strong> "${searchTitle}"`);
            if (searchEmail) criteria.push(`<strong>Email:</strong> "${searchEmail}"`);
            if (searchIndustry) criteria.push(`<strong>Industry:</strong> "${searchIndustry}"`);
            if (searchNotes) criteria.push(`<strong>Notes:</strong> "${searchNotes}"`);
            
            // Search logic
            const searchLogic = document.querySelector('input[name="search-logic"]:checked')?.value || 'and';
            if (criteria.length > 1) {
                criteria.unshift(`<strong>Logic:</strong> ${searchLogic.toUpperCase()}`);
            }
            
            // Basic filters
            const statusFilter = document.getElementById('status-filter').value;
            const assigneeFilter = document.getElementById('assignee-filter').value;
            const priorityFilter = document.getElementById('priority-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const industryFilter = document.getElementById('industry-filter').value;
            
            if (statusFilter) criteria.push(`<strong>Status:</strong> ${statusFilter}`);
            if (assigneeFilter) criteria.push(`<strong>Assignee:</strong> ${assigneeFilter}`);
            if (priorityFilter) criteria.push(`<strong>Priority:</strong> ${priorityFilter}`);
            if (typeFilter) criteria.push(`<strong>Type:</strong> ${typeFilter}`);
            if (industryFilter) criteria.push(`<strong>Industry Filter:</strong> ${industryFilter}`);
            
            // Advanced filters
            const dateAddedFrom = document.getElementById('date-added-from').value;
            const dateAddedTo = document.getElementById('date-added-to').value;
            const scoreMin = document.getElementById('score-min').value;
            const scoreMax = document.getElementById('score-max').value;
            
            if (dateAddedFrom || dateAddedTo) {
                let dateRange = '<strong>Date Added:</strong> ';
                if (dateAddedFrom && dateAddedTo) {
                    dateRange += `${dateAddedFrom} to ${dateAddedTo}`;
                } else if (dateAddedFrom) {
                    dateRange += `from ${dateAddedFrom}`;
                } else {
                    dateRange += `until ${dateAddedTo}`;
                }
                criteria.push(dateRange);
            }
            
            if (scoreMin || scoreMax) {
                let scoreRange = '<strong>Score Range:</strong> ';
                if (scoreMin && scoreMax) {
                    scoreRange += `${scoreMin} to ${scoreMax}`;
                } else if (scoreMin) {
                    scoreRange += `from ${scoreMin}`;
                } else {
                    scoreRange += `up to ${scoreMax}`;
                }
                criteria.push(scoreRange);
            }
            
            if (criteria.length === 0) {
                return '<em>No search criteria or filters active</em>';
            }
            
            return criteria.join('<br>');
        }

        /**
         * Save current search and filters as preset
         * Requirements: 4.1, 4.2, 4.3
         */
        function saveSearchPreset() {
            const name = document.getElementById('search-preset-name').value.trim();
            if (!name) {
                showNotification('Please enter a name for the search preset', 'warning');
                return;
            }
            
            // Check if name already exists
            if (savedSearches.some(search => search.name === name)) {
                if (!confirm('A search with this name already exists. Do you want to replace it?')) {
                    return;
                }
                // Remove existing search with same name
                savedSearches = savedSearches.filter(search => search.name !== name);
            }
            
            // Collect all current search and filter values
            const searchPreset = {
                id: Date.now().toString(),
                name: name,
                created: new Date().toISOString(),
                criteria: {
                    // Basic search
                    searchTerm: document.getElementById('search-input').value.trim(),
                    
                    // Multi-field searches
                    searchName: document.getElementById('search-name')?.value.trim() || '',
                    searchCompany: document.getElementById('search-company')?.value.trim() || '',
                    searchTitle: document.getElementById('search-title')?.value.trim() || '',
                    searchEmail: document.getElementById('search-email')?.value.trim() || '',
                    searchIndustry: document.getElementById('search-industry')?.value.trim() || '',
                    searchNotes: document.getElementById('search-notes')?.value.trim() || '',
                    
                    // Search logic
                    searchLogic: document.querySelector('input[name="search-logic"]:checked')?.value || 'and',
                    
                    // Basic filters
                    statusFilter: document.getElementById('status-filter').value,
                    assigneeFilter: document.getElementById('assignee-filter').value,
                    priorityFilter: document.getElementById('priority-filter').value,
                    typeFilter: document.getElementById('type-filter').value,
                    industryFilter: document.getElementById('industry-filter').value,
                    scoreFilter: document.getElementById('score-filter')?.value || '',
                    
                    // Advanced filters
                    dateAddedFrom: document.getElementById('date-added-from').value,
                    dateAddedTo: document.getElementById('date-added-to').value,
                    lastContactedFrom: document.getElementById('last-contacted-from').value,
                    lastContactedTo: document.getElementById('last-contacted-to').value,
                    followupFilter: document.getElementById('followup-filter').value,
                    linkedinFilter: document.getElementById('linkedin-filter').value,
                    phoneFilter: document.getElementById('phone-filter').value,
                    scoreMin: document.getElementById('score-min').value,
                    scoreMax: document.getElementById('score-max').value
                }
            };
            
            savedSearches.push(searchPreset);
            
            // Save to localStorage
            localStorage.setItem('gsg-saved-searches', JSON.stringify(savedSearches));
            
            // Update UI
            updateSavedSearchesCount();
            updateSavedSearchesList();
            
            // Close modal
            document.getElementById('save-search-modal').classList.add('hidden');
            
            showNotification(`Search preset "${name}" saved successfully`, 'success');
        }

        /**
         * Load saved search preset
         * Requirements: 4.1, 4.2, 4.3
         */
        function loadSearchPreset(presetId) {
            const preset = savedSearches.find(search => search.id === presetId);
            if (!preset) {
                showNotification('Search preset not found', 'error');
                return;
            }
            
            const criteria = preset.criteria;
            
            // Apply basic search
            document.getElementById('search-input').value = criteria.searchTerm || '';
            
            // Apply multi-field searches
            if (document.getElementById('search-name')) document.getElementById('search-name').value = criteria.searchName || '';
            if (document.getElementById('search-company')) document.getElementById('search-company').value = criteria.searchCompany || '';
            if (document.getElementById('search-title')) document.getElementById('search-title').value = criteria.searchTitle || '';
            if (document.getElementById('search-email')) document.getElementById('search-email').value = criteria.searchEmail || '';
            if (document.getElementById('search-industry')) document.getElementById('search-industry').value = criteria.searchIndustry || '';
            if (document.getElementById('search-notes')) document.getElementById('search-notes').value = criteria.searchNotes || '';
            
            // Apply search logic
            const logicRadio = document.querySelector(`input[name="search-logic"][value="${criteria.searchLogic}"]`);
            if (logicRadio) logicRadio.checked = true;
            
            // Apply basic filters
            document.getElementById('status-filter').value = criteria.statusFilter || '';
            document.getElementById('assignee-filter').value = criteria.assigneeFilter || '';
            document.getElementById('priority-filter').value = criteria.priorityFilter || '';
            document.getElementById('type-filter').value = criteria.typeFilter || '';
            document.getElementById('industry-filter').value = criteria.industryFilter || '';
            if (document.getElementById('score-filter')) {
                document.getElementById('score-filter').value = criteria.scoreFilter || '';
            }
            
            // Apply advanced filters
            document.getElementById('date-added-from').value = criteria.dateAddedFrom || '';
            document.getElementById('date-added-to').value = criteria.dateAddedTo || '';
            document.getElementById('last-contacted-from').value = criteria.lastContactedFrom || '';
            document.getElementById('last-contacted-to').value = criteria.lastContactedTo || '';
            document.getElementById('followup-filter').value = criteria.followupFilter || '';
            document.getElementById('linkedin-filter').value = criteria.linkedinFilter || '';
            document.getElementById('phone-filter').value = criteria.phoneFilter || '';
            document.getElementById('score-min').value = criteria.scoreMin || '';
            document.getElementById('score-max').value = criteria.scoreMax || '';
            
            // Apply filters
            applyFilters();
            
            // Close dropdown
            document.getElementById('saved-searches-dropdown').classList.add('hidden');
            
            showNotification(`Search preset "${preset.name}" loaded`, 'success');
        }

        /**
         * Delete saved search preset
         * Requirements: 4.1, 4.2, 4.3
         */
        function deleteSearchPreset(presetId) {
            const preset = savedSearches.find(search => search.id === presetId);
            if (!preset) return;
            
            if (!confirm(`Are you sure you want to delete the search preset "${preset.name}"?`)) {
                return;
            }
            
            savedSearches = savedSearches.filter(search => search.id !== presetId);
            
            // Save to localStorage
            localStorage.setItem('gsg-saved-searches', JSON.stringify(savedSearches));
            
            // Update UI
            updateSavedSearchesCount();
            updateSavedSearchesList();
            
            showNotification(`Search preset "${preset.name}" deleted`, 'success');
        }

        /**
         * Toggle saved searches dropdown
         * Requirements: 4.1, 4.2, 4.3
         */
        function toggleSavedSearches() {
            const dropdown = document.getElementById('saved-searches-dropdown');
            if (dropdown.classList.contains('hidden')) {
                updateSavedSearchesList();
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        /**
         * Update saved searches count display
         * Requirements: 4.1, 4.2, 4.3
         */
        function updateSavedSearchesCount() {
            const countElement = document.getElementById('saved-searches-count');
            if (countElement) {
                countElement.textContent = savedSearches.length;
            }
        }

        /**
         * Update saved searches dropdown list
         * Requirements: 4.1, 4.2, 4.3
         */
        function updateSavedSearchesList() {
            const listElement = document.getElementById('saved-searches-list');
            if (!listElement) return;
            
            if (savedSearches.length === 0) {
                listElement.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500 text-center">No saved searches</div>';
                return;
            }
            
            listElement.innerHTML = savedSearches.map(search => `
                <div class="flex items-center justify-between px-4 py-2 hover:bg-gray-50 border-b border-gray-100 last:border-b-0">
                    <div class="flex-1 min-w-0">
                        <button onclick="loadSearchPreset('${search.id}')" 
                            class="text-left w-full text-sm font-medium text-gray-900 hover:text-blue-600 truncate">
                            ${search.name}
                        </button>
                        <div class="text-xs text-gray-500">
                            ${new Date(search.created).toLocaleDateString()}
                        </div>
                    </div>
                    <button onclick="deleteSearchPreset('${search.id}')" 
                        class="ml-2 text-red-400 hover:text-red-600 flex-shrink-0"
                        title="Delete search preset">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        /**
         * Load saved searches from localStorage
         * Requirements: 4.1, 4.2, 4.3
         */
        function loadSavedSearches() {
            try {
                const saved = localStorage.getItem('gsg-saved-searches');
                if (saved) {
                    savedSearches = JSON.parse(saved);
                    updateSavedSearchesCount();
                }
            } catch (error) {
                console.error('Error loading saved searches:', error);
                savedSearches = [];
            }
        }

        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================

        /**
         * Update dashboard content with latest data
         * Requirements: 1.4, 8.5
         */
        function updateDashboardContent() {
            updateDashboardMetrics();
            updatePriorityContactsList();
            updateFollowupRemindersList();
            updateRecentActivityFeed();
            updateDashboardTimestamp();
        }

        /**
         * Update dashboard metrics cards
         * Requirements: 1.4
         */
        function updateDashboardMetrics() {
            const totalContacts = contacts.length;
            const activeContacts = contacts.filter(c => c.status !== 'Inactive').length;
            const highPriorityContacts = contacts.filter(c => c.priority === 'High').length;
            
            // Calculate follow-ups due
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const followupsDue = contacts.filter(c => {
                if (!c.nextFollowUp) return false;
                const followupDate = new Date(c.nextFollowUp);
                followupDate.setHours(0, 0, 0, 0);
                return followupDate <= today;
            }).length;

            const overdueFollowups = contacts.filter(c => {
                if (!c.nextFollowUp) return false;
                const followupDate = new Date(c.nextFollowUp);
                followupDate.setHours(0, 0, 0, 0);
                return followupDate < today;
            }).length;

            // Calculate recent activity
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const recentActivities = activities.filter(a => new Date(a.date) >= oneWeekAgo).length;
            
            const todayActivities = activities.filter(a => {
                const activityDate = new Date(a.date);
                activityDate.setHours(0, 0, 0, 0);
                return activityDate.getTime() === today.getTime();
            }).length;

            // Update dashboard metrics
            document.getElementById('dashboard-total-contacts').textContent = totalContacts;
            document.getElementById('dashboard-active-contacts').textContent = activeContacts;
            document.getElementById('dashboard-high-priority').textContent = highPriorityContacts;
            document.getElementById('dashboard-followups-due').textContent = followupsDue;
            document.getElementById('dashboard-overdue-followups').textContent = overdueFollowups;
            document.getElementById('dashboard-recent-activities').textContent = recentActivities;
            document.getElementById('dashboard-today-activities').textContent = todayActivities;

            // Update trend indicators (simplified for now)
            const contactsTrend = document.getElementById('dashboard-contacts-trend');
            if (contactsTrend) {
                contactsTrend.textContent = `+${Math.max(0, totalContacts - activeContacts)}`;
            }
        }

        /**
         * Update priority contacts list
         * Requirements: 8.5
         */
        function updatePriorityContactsList() {
            const priorityContacts = contacts
                .filter(c => c.priority === 'High' && c.status !== 'Inactive')
                .sort((a, b) => (b.score || 0) - (a.score || 0))
                .slice(0, 5);

            const container = document.getElementById('priority-contacts-list');
            
            if (priorityContacts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <p class="mt-2 text-sm">No high-priority contacts found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = priorityContacts.map(contact => `
                <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition-colors duration-200">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                    <span class="text-xs font-medium text-red-600">${contact.score || 0}</span>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate">${contact.name}</p>
                                <p class="text-xs text-gray-500 truncate">${contact.company || 'No company'} • ${contact.title || 'No title'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            High Priority
                        </span>
                        <button onclick="editContact('${contact.id}')" class="text-blue-600 hover:text-blue-800">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update follow-up reminders list
         * Requirements: 1.4
         */
        function updateFollowupRemindersList() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const followupContacts = contacts
                .filter(c => c.nextFollowUp)
                .map(c => ({
                    ...c,
                    followupDate: new Date(c.nextFollowUp),
                    isOverdue: new Date(c.nextFollowUp) < today,
                    isDueToday: new Date(c.nextFollowUp).getTime() === today.getTime()
                }))
                .sort((a, b) => a.followupDate - b.followupDate)
                .slice(0, 5);

            const container = document.getElementById('followup-reminders-list');
            
            if (followupContacts.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="mt-2 text-sm">No follow-ups due</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = followupContacts.map(contact => {
                const statusClass = contact.isOverdue ? 'bg-red-50 border-red-200' : 
                                  contact.isDueToday ? 'bg-orange-50 border-orange-200' : 
                                  'bg-yellow-50 border-yellow-200';
                const statusText = contact.isOverdue ? 'Overdue' : 
                                 contact.isDueToday ? 'Due Today' : 
                                 'Upcoming';
                const statusColor = contact.isOverdue ? 'bg-red-100 text-red-800' : 
                                  contact.isDueToday ? 'bg-orange-100 text-orange-800' : 
                                  'bg-yellow-100 text-yellow-800';

                return `
                    <div class="flex items-center justify-between p-3 ${statusClass} border rounded-lg hover:bg-opacity-75 transition-colors duration-200">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <svg class="w-5 h-5 ${contact.isOverdue ? 'text-red-500' : contact.isDueToday ? 'text-orange-500' : 'text-yellow-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${contact.name}</p>
                                    <p class="text-xs text-gray-500 truncate">${contact.company || 'No company'} • ${formatDate(contact.followupDate)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${statusText}
                            </span>
                            <button onclick="editContact('${contact.id}')" class="text-blue-600 hover:text-blue-800">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Update recent activity feed
         */
        function updateRecentActivityFeed() {
            const recentActivities = activities
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);

            const container = document.getElementById('recent-activity-feed');
            
            if (recentActivities.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <p class="mt-2 text-sm">No recent activity</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <ul class="-mb-8">
                    ${recentActivities.map((activity, index) => {
                        const contact = contacts.find(c => c.id === activity.contactId);
                        const isLast = index === recentActivities.length - 1;
                        const activityIcon = getActivityIcon(activity.type);
                        const activityColor = getActivityColor(activity.type);
                        
                        return `
                            <li>
                                <div class="relative pb-8">
                                    ${!isLast ? '<span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>' : ''}
                                    <div class="relative flex items-start space-x-3">
                                        <div class="relative">
                                            <div class="h-10 w-10 rounded-full ${activityColor} flex items-center justify-center ring-8 ring-white">
                                                ${activityIcon}
                                            </div>
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div>
                                                <div class="text-sm">
                                                    <span class="font-medium text-gray-900">${contact ? contact.name : 'Unknown Contact'}</span>
                                                </div>
                                                <p class="mt-0.5 text-sm text-gray-500">
                                                    ${activity.type} • ${formatRelativeTime(new Date(activity.date))}
                                                </p>
                                            </div>
                                            <div class="mt-2 text-sm text-gray-700">
                                                <p>${activity.notes || 'No notes'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
        }

        /**
         * Update dashboard timestamp
         */
        function updateDashboardTimestamp() {
            const timestamp = document.getElementById('dashboard-last-updated');
            if (timestamp) {
                timestamp.textContent = `Last updated: ${formatTime(new Date())}`;
            }
        }

        /**
         * Refresh dashboard data
         */
        function refreshDashboard() {
            updateDashboardContent();
            showNotification('Dashboard refreshed successfully!', 'success');
        }

        /**
         * Filter to show high priority contacts
         */
        function filterHighPriorityContacts() {
            // Switch to contacts tab
            switchMainTab('contacts');
            
            // Clear existing filters
            clearAllFilters();
            
            // Set priority filter to High
            document.getElementById('priority-filter').value = 'High';
            
            // Apply filters
            applyFilters();
            
            showNotification('Showing high priority contacts', 'info');
        }

        /**
         * Filter to show overdue follow-ups
         */
        function filterOverdueFollowups() {
            // Switch to contacts tab
            switchMainTab('contacts');
            
            // Clear existing filters
            clearAllFilters();
            
            // Filter contacts with overdue follow-ups
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            filteredContacts = contacts.filter(contact => {
                if (!contact.nextFollowUp) return false;
                const followupDate = new Date(contact.nextFollowUp);
                followupDate.setHours(0, 0, 0, 0);
                return followupDate < today;
            });
            
            renderContactsTable();
            updateDashboardStats();
            
            showNotification('Showing overdue follow-ups', 'info');
        }

        /**
         * Open add contact modal
         */
        function openAddContactModal() {
            document.getElementById('add-contact-btn').click();
        }

        /**
         * Get activity icon based on type
         */
        function getActivityIcon(type) {
            const icons = {
                'Email Sent': '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>',
                'Phone Call': '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>',
                'Meeting Scheduled': '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>',
                'Follow-up': '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                'Note Added': '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>'
            };
            return icons[type] || icons['Note Added'];
        }

        /**
         * Get activity color based on type
         */
        function getActivityColor(type) {
            const colors = {
                'Email Sent': 'bg-green-500',
                'Phone Call': 'bg-yellow-500',
                'Meeting Scheduled': 'bg-purple-500',
                'Follow-up': 'bg-red-500',
                'Note Added': 'bg-gray-500'
            };
            return colors[type] || colors['Note Added'];
        }

        /**
         * Format relative time
         */
        function formatRelativeTime(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} days ago`;
            
            return formatDate(date);
        }

        /**
         * Format date for display
         */
        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        /**
         * Format time for display
         */
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        // ============================================
        // BULK OPERATIONS FUNCTIONS
        // ============================================

        /**
         * Apply bulk updates to selected contacts
         * Requirements: 9.1, 9.2, 9.3
         */
        async function applyBulkUpdates() {
            const selectedIds = Array.from(selectedContacts);
            if (selectedIds.length === 0) {
                showNotification('No contacts selected', 'warning');
                return;
            }

            const statusUpdate = document.getElementById('bulk-status-update').value;
            const assigneeUpdate = document.getElementById('bulk-assignee-update').value;
            const priorityUpdate = document.getElementById('bulk-priority-update').value;

            if (!statusUpdate && !assigneeUpdate && !priorityUpdate) {
                showNotification('Please select at least one field to update', 'warning');
                return;
            }

            const updates = {};
            if (statusUpdate) updates.status = statusUpdate;
            if (assigneeUpdate !== undefined) updates.assignee = assigneeUpdate; // Allow empty string for unassigned
            if (priorityUpdate) updates.priority = priorityUpdate;

            // Show progress indicator
            const applyBtn = document.getElementById('apply-bulk-updates');
            let loadingId = null;
            const progressId = loadingManager.showGlobalLoading('Updating contacts...', true);

            try {
                loadingId = loadingManager.showButtonLoading(applyBtn, 'Updating...');

                // Update local contacts with progress tracking
                let updatedCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < selectedIds.length; i++) {
                    const contactId = selectedIds[i];
                    const progress = Math.round(((i + 1) / selectedIds.length) * 100);
                    loadingManager.updateGlobalProgress(progress, `Updating contact ${i + 1} of ${selectedIds.length}...`);

                    try {
                        const contactIndex = contacts.findIndex(c => c.id === contactId);
                        if (contactIndex !== -1) {
                            const contact = contacts[contactIndex];
                            
                            // Track assignment changes
                            if (updates.assignee !== undefined && contact.assignee !== updates.assignee) {
                                // Ensure assignment history exists
                                if (!contact.assignmentHistory) {
                                    contact.assignmentHistory = [];
                                }
                                
                                // Add assignment history entry
                                contact.assignmentHistory.push({
                                    id: 'assignment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    fromAssignee: contact.assignee || 'Unassigned',
                                    toAssignee: updates.assignee || 'Unassigned',
                                    changedBy: 'User (Bulk)',
                                    date: new Date().toISOString(),
                                    reason: 'Bulk assignment change'
                                });
                            }
                            
                            Object.assign(contact, updates);
                            contact.lastModified = new Date().toISOString();
                            updatedCount++;
                        }
                    } catch (contactError) {
                        console.error('Error updating contact:', contactId, contactError);
                        errorCount++;
                    }
                }

                // Save to backend if configured
                if (checkConfiguration()) {
                    try {
                        loadingManager.updateGlobalProgress(100, 'Syncing with server...');
                        await apiHandler.makeRequest(CONFIG.GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'bulkUpdate',
                                data: { contactIds: selectedIds, updates }
                            }),
                            context: 'Bulk update sync'
                        });
                    } catch (error) {
                        console.warn('Bulk update saved locally but sync failed:', error);
                        // Add to offline queue for later sync
                        offlineQueue.addToQueue({
                            type: 'bulkUpdate',
                            data: { contactIds: selectedIds, updates }
                        });
                        showNotification(`Updated ${updatedCount} contacts locally. Will sync when connection is restored.`, 'warning');
                    }
                }

                // Clear selections and reset bulk update dropdowns
                selectedContacts.clear();
                document.getElementById('bulk-status-update').value = '';
                document.getElementById('bulk-assignee-update').value = '';
                document.getElementById('bulk-priority-update').value = '';

                // Update UI
                saveContactsToLocalStorage();
                applyFilters();
                updateDashboardStats();

                // Show detailed success message
                const messages = [`Successfully updated ${updatedCount} contacts`];
                if (errorCount > 0) {
                    messages.push(`${errorCount} contacts failed to update`);
                }

                const actions = [];
                if (errorCount > 0) {
                    actions.push({
                        label: 'View Errors',
                        handler: 'showBulkUpdateErrors()',
                        primary: false
                    });
                }

                showSuccessNotification(messages.join(', '), actions);

            } catch (error) {
                handleError(error, 'Bulk update operation', {
                    userFriendly: true,
                    retryHandler: () => applyBulkUpdates(),
                    fallbackHandler: () => {
                        // Save changes locally as fallback
                        try {
                            saveContactsToLocalStorage();
                            applyFilters();
                            updateDashboardStats();
                            showNotification('Changes saved locally. Will sync when connection is restored.', 'info');
                        } catch (fallbackError) {
                            showNotification('Failed to save changes even locally. Please try again.', 'error');
                        }
                    }
                });
            } finally {
                if (loadingId) {
                    loadingManager.hideButtonLoading(loadingId);
                }
                loadingManager.hideGlobalLoading();
            }
        }

        /**
         * Bulk delete selected contacts
         * Requirements: 9.1, 9.4
         */
        async function bulkDeleteContacts() {
            const selectedIds = Array.from(selectedContacts);
            if (selectedIds.length === 0) {
                showNotification('No contacts selected', 'warning');
                return;
            }

            const confirmMessage = `Are you sure you want to delete ${selectedIds.length} contact${selectedIds.length > 1 ? 's' : ''}? This action cannot be undone.`;
            if (!confirm(confirmMessage)) {
                return;
            }

            // Show progress indicator
            const deleteBtn = document.getElementById('bulk-delete');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<div class="loading-spinner mr-2"></div>Deleting...';

            try {
                // Delete from local contacts
                let deletedCount = 0;
                selectedIds.forEach(contactId => {
                    const contactIndex = contacts.findIndex(c => c.id === contactId);
                    if (contactIndex !== -1) {
                        contacts.splice(contactIndex, 1);
                        deletedCount++;
                    }
                });

                // Delete from backend if configured
                if (checkConfiguration()) {
                    try {
                        await httpHandler.makeRequest(CONFIG.GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'bulkDelete',
                                data: { contactIds: selectedIds }
                            })
                        });
                    } catch (error) {
                        console.warn('Bulk delete completed locally but sync failed:', error);
                        showNotification(`Deleted ${deletedCount} contacts locally. Sync failed - will retry later.`, 'warning');
                    }
                }

                // Clear selections
                selectedContacts.clear();

                // Update UI
                saveContactsToLocalStorage();
                applyFilters();
                updateDashboardStats();

                showNotification(`Successfully deleted ${deletedCount} contacts`, 'success');

            } catch (error) {
                console.error('Bulk delete failed:', error);
                showNotification('Bulk delete failed: ' + error.message, 'error');
            } finally {
                // Restore button state
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
            }
        }

        /**
         * Generate bulk email template for selected contacts
         * Requirements: 9.2
         */
        function generateBulkEmailTemplate() {
            const selectedIds = Array.from(selectedContacts);
            if (selectedIds.length === 0) {
                showNotification('No contacts selected', 'warning');
                return;
            }

            // Update the count in the modal
            document.getElementById('bulk-email-count').textContent = selectedIds.length;
            
            // Show the modal
            showModal('bulk-email-modal');
        }

        /**
         * Close bulk email modal
         */
        function closeBulkEmailModal() {
            hideModal('bulk-email-modal');
            // Clear the preview
            document.getElementById('email-previews').innerHTML = '<p class="text-sm text-gray-500 text-center">Click "Generate Preview" to see personalized emails</p>';
            // Disable action buttons
            document.getElementById('copy-all-emails').disabled = true;
            document.getElementById('export-email-csv').disabled = true;
        }

        /**
         * Generate email previews for selected contacts
         * Requirements: 9.2
         */
        function generateEmailPreviews() {
            const selectedIds = Array.from(selectedContacts);
            const subject = document.getElementById('email-subject').value.trim();
            const template = document.getElementById('email-template').value.trim();
            const senderName = document.getElementById('sender-name').value.trim();

            if (!subject || !template || !senderName) {
                showNotification('Please fill in all required fields (subject, template, and sender name)', 'warning');
                return;
            }

            const selectedContacts = contacts.filter(contact => selectedIds.includes(contact.id));
            const emailPreviews = [];

            selectedContacts.forEach(contact => {
                const personalizedSubject = subject
                    .replace(/\{\{name\}\}/g, contact.name || 'there')
                    .replace(/\{\{title\}\}/g, contact.title || 'Professional')
                    .replace(/\{\{company\}\}/g, contact.company || 'your organization')
                    .replace(/\{\{industry\}\}/g, contact.industry || 'your industry')
                    .replace(/\{\{sender_name\}\}/g, senderName);

                const personalizedBody = template
                    .replace(/\{\{name\}\}/g, contact.name || 'there')
                    .replace(/\{\{title\}\}/g, contact.title || 'Professional')
                    .replace(/\{\{company\}\}/g, contact.company || 'your organization')
                    .replace(/\{\{industry\}\}/g, contact.industry || 'your industry')
                    .replace(/\{\{sender_name\}\}/g, senderName);

                emailPreviews.push({
                    contact: contact,
                    subject: personalizedSubject,
                    body: personalizedBody,
                    email: contact.email
                });
            });

            // Display previews
            const previewsContainer = document.getElementById('email-previews');
            previewsContainer.innerHTML = emailPreviews.map((email, index) => `
                <div class="mb-4 p-3 border border-gray-200 rounded-md bg-white">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="font-medium text-gray-900">${email.contact.name}</h5>
                        <span class="text-xs text-gray-500">${email.email}</span>
                    </div>
                    <div class="mb-2">
                        <strong class="text-sm text-gray-700">Subject:</strong>
                        <div class="text-sm text-gray-900 bg-gray-50 p-2 rounded mt-1">${email.subject}</div>
                    </div>
                    <div>
                        <strong class="text-sm text-gray-700">Body:</strong>
                        <div class="text-sm text-gray-900 bg-gray-50 p-2 rounded mt-1 whitespace-pre-wrap">${email.body}</div>
                    </div>
                    <div class="mt-2 flex space-x-2">
                        <button onclick="copyIndividualEmail(${index})" 
                            class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                            Copy This Email
                        </button>
                        <button onclick="openEmailClient('${email.email}', '${email.subject.replace(/'/g, "\\'")}', '${email.body.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')"
                            class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                            Open in Email Client
                        </button>
                    </div>
                </div>
            `).join('');

            // Store generated emails for copying/exporting
            window.generatedEmails = emailPreviews;

            // Enable action buttons
            document.getElementById('copy-all-emails').disabled = false;
            document.getElementById('export-email-csv').disabled = false;

            showNotification(`Generated ${emailPreviews.length} personalized emails`, 'success');
        }

        /**
         * Copy all generated emails to clipboard
         * Requirements: 9.2
         */
        async function copyAllEmails() {
            if (!window.generatedEmails || window.generatedEmails.length === 0) {
                showNotification('No emails generated yet', 'warning');
                return;
            }

            const emailsText = window.generatedEmails.map(email => 
                `To: ${email.email}\nSubject: ${email.subject}\n\n${email.body}\n\n${'='.repeat(50)}\n`
            ).join('\n');

            try {
                await navigator.clipboard.writeText(emailsText);
                showNotification(`Copied ${window.generatedEmails.length} emails to clipboard`, 'success');
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                showNotification('Failed to copy to clipboard. Please try selecting and copying manually.', 'error');
            }
        }

        /**
         * Copy individual email to clipboard
         * Requirements: 9.2
         */
        async function copyIndividualEmail(index) {
            if (!window.generatedEmails || !window.generatedEmails[index]) {
                showNotification('Email not found', 'error');
                return;
            }

            const email = window.generatedEmails[index];
            const emailText = `To: ${email.email}\nSubject: ${email.subject}\n\n${email.body}`;

            try {
                await navigator.clipboard.writeText(emailText);
                showNotification(`Copied email for ${email.contact.name} to clipboard`, 'success');
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                showNotification('Failed to copy to clipboard', 'error');
            }
        }

        /**
         * Open email client with pre-filled email
         * Requirements: 9.2
         */
        function openEmailClient(email, subject, body) {
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
        }

        /**
         * Export generated emails as CSV
         * Requirements: 9.2
         */
        function exportEmailCSV() {
            if (!window.generatedEmails || window.generatedEmails.length === 0) {
                showNotification('No emails generated yet', 'warning');
                return;
            }

            const csvHeaders = ['Name', 'Email', 'Company', 'Title', 'Subject', 'Body'];
            const csvRows = window.generatedEmails.map(email => [
                email.contact.name || '',
                email.email || '',
                email.contact.company || '',
                email.contact.title || '',
                email.subject || '',
                email.body.replace(/"/g, '""') // Escape quotes for CSV
            ]);

            const csvContent = [
                csvHeaders.join(','),
                ...csvRows.map(row => row.map(field => `"${field}"`).join(','))
            ].join('\n');

            // Create and download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bulk-emails-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification(`Exported ${window.generatedEmails.length} emails to CSV`, 'success');
        }

        /**
         * Show duplicate detection dialog
         * Requirements: 2.4
         */
        async function showDuplicateDialog(newContact, duplicates) {
            return new Promise((resolve) => {
                const duplicateList = duplicates.map(dup =>
                    `<li class="py-2 border-b border-gray-200">
                        <div class="font-medium">${dup.contact.name}</div>
                        <div class="text-sm text-gray-600">${dup.contact.email}</div>
                        <div class="text-sm text-gray-500">${dup.contact.company || 'No company'}</div>
                        <div class="text-xs text-blue-600">Similarity: ${dup.similarity.reasons.join(', ')}</div>
                    </li>`
                ).join('');

                const modalHtml = `
                    <div class="fixed inset-0 z-50 overflow-y-auto">
                        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                            <div class="fixed inset-0 transition-opacity modal-overlay"></div>
                            
                            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
                            
                            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                    <div class="flex items-center mb-4">
                                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 sm:mx-0 sm:h-10 sm:w-10">
                                            <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-4">
                                            <h3 class="text-lg leading-6 font-medium text-gray-900">Possible Duplicate Detected</h3>
                                            <p class="text-sm text-gray-500">We found similar contacts that might be duplicates.</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h4 class="font-medium text-gray-900 mb-2">New Contact:</h4>
                                        <div class="bg-gray-50 p-3 rounded">
                                            <div class="font-medium">${newContact.name}</div>
                                            <div class="text-sm text-gray-600">${newContact.email}</div>
                                            <div class="text-sm text-gray-500">${newContact.company || 'No company'}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h4 class="font-medium text-gray-900 mb-2">Similar Contacts:</h4>
                                        <ul class="bg-gray-50 rounded max-h-40 overflow-y-auto">
                                            ${duplicateList}
                                        </ul>
                                    </div>
                                    
                                    <p class="text-sm text-gray-600">
                                        Do you want to continue adding this contact anyway?
                                    </p>
                                </div>
                                
                                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                    <button type="button" id="continue-anyway" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                        Continue Anyway
                                    </button>
                                    <button type="button" id="cancel-duplicate" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to page
                const modalContainer = document.createElement('div');
                modalContainer.id = 'duplicate-modal';
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);

                // Add event listeners
                document.getElementById('continue-anyway').addEventListener('click', () => {
                    modalContainer.remove();
                    resolve(true);
                });

                document.getElementById('cancel-duplicate').addEventListener('click', () => {
                    modalContainer.remove();
                    resolve(false);
                });

                // Close on overlay click
                modalContainer.querySelector('.modal-overlay').addEventListener('click', () => {
                    modalContainer.remove();
                    resolve(false);
                });
            });
        }

        /**
         * Show notification to user
         */
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 translate-x-full`;

            const bgColor = {
                'success': 'bg-green-50 border-green-200',
                'error': 'bg-red-50 border-red-200',
                'warning': 'bg-yellow-50 border-yellow-200',
                'info': 'bg-blue-50 border-blue-200'
            }[type] || 'bg-gray-50 border-gray-200';

            const iconColor = {
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400',
                'info': 'text-blue-400'
            }[type] || 'text-gray-400';

            const icon = {
                'success': 'M5 13l4 4L19 7',
                'error': 'M6 18L18 6M6 6l12 12',
                'warning': 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z',
                'info': 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
            }[type] || 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';

            notification.innerHTML = `
                <div class="p-4 ${bgColor} border-l-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icon}"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">${message}</p>
                        </div>
                        <div class="ml-auto pl-3">
                            <div class="-mx-1.5 -my-1.5">
                                <button type="button" class="inline-flex bg-transparent rounded-md p-1.5 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" onclick="this.closest('.fixed').remove()">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        // ============================================
        // BACKEND COMMUNICATION FUNCTIONS
        // ============================================

        /**
         * Load contacts from Google Apps Script backend
         */
        async function loadContactsFromBackend() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

            try {
                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    const rawContacts = data.data?.contacts || data.contacts || [];

                    // Sanitize and validate loaded contacts
                    contacts = rawContacts.map(contactData => {
                        try {
                            const contact = new Contact(contactData);
                            // Recalculate score to ensure it's current
                            contact.score = scoringEngine.calculateScore(contact);
                            contact.scoreBreakdown = scoringEngine.getScoreBreakdown(contact);
                            return contact.toJSON();
                        } catch (error) {
                            console.warn('Invalid contact data, using sanitized version:', error, contactData);
                            // Fallback to sanitized raw data
                            return sanitizeContactData(contactData);
                        }
                    });

                    // Save to local storage as backup
                    saveContactsToLocalStorage();

                    console.log('Loaded', contacts.length, 'contacts from backend');
                } else {
                    throw new Error(data.error || 'Failed to load contacts from backend');
                }

            } catch (error) {
                console.error('Error loading from backend:', error);
                throw error;
            }
        }

        /**
         * Save contact to Google Apps Script backend
         */
        async function saveContactToBackend(contact) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

            try {
                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveContact',
                        data: contact.toJSON()
                    })
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to save contact to backend');
                }

                // Update local storage
                saveContactsToLocalStorage();

                return result.data;

            } catch (error) {
                console.error('Error saving to backend:', error);
                throw error;
            }
        }

        /**
         * Delete contact from Google Apps Script backend
         */
        async function deleteContactFromBackend(contactId) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

            try {
                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'deleteContact',
                        data: { id: contactId }
                    })
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to delete contact from backend');
                }

                // Update local storage
                saveContactsToLocalStorage();

                return result.data;

            } catch (error) {
                console.error('Error deleting from backend:', error);
                throw error;
            }
        }

        /**
         * Sanitize contact data for fallback scenarios
         */
        function sanitizeContactData(data) {
            return {
                id: data.id || 'contact_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                type: data.type || 'Individual',
                name: (data.name || '').toString().trim(),
                title: (data.title || '').toString().trim(),
                company: (data.company || '').toString().trim(),
                industry: (data.industry || '').toString().trim(),
                email: (data.email || '').toString().trim().toLowerCase(),
                linkedin: (data.linkedin || '').toString().trim(),
                phone: (data.phone || '').toString().trim(),
                status: CONFIG.CONTACT_STATUSES.includes(data.status) ? data.status : 'New',
                priority: CONFIG.PRIORITY_LEVELS.includes(data.priority) ? data.priority : 'None',
                assignee: CONFIG.TEAM_MEMBERS.includes(data.assignee) ? data.assignee : '',
                nextFollowUp: data.nextFollowUp || null,
                notes: (data.notes || '').toString().trim(),
                score: Number(data.score) || 0,
                scoreBreakdown: data.scoreBreakdown || {},
                tags: Array.isArray(data.tags) ? data.tags : [],
                dateAdded: data.dateAdded || new Date().toISOString(),
                lastModified: new Date().toISOString(),
                lastContacted: data.lastContacted || null
            };
        }

        // Initialize filtered contacts
        filteredContacts = contacts;

        // ============================================
        // API COMMUNICATION FUNCTIONS
        // ============================================

        async function loadContacts() {
            // Check configuration before attempting to load
            if (!checkConfiguration()) {
                console.log('Configuration invalid, skipping contact loading');
                return;
            }

            try {
                updateConnectionStatus('loading', 'Loading contacts...');

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    const rawContacts = data.data.contacts || [];

                    // Sanitize and validate loaded contacts
                    contacts = rawContacts.map(contactData => {
                        try {
                            // Create Contact instance for validation and sanitization
                            const contact = new Contact(contactData);

                            // Always recalculate score to ensure it's current (Requirements 14.1)
                            contact.score = calculateContactScore(contact);
                            contact.scoreBreakdown = getScoreBreakdown(contact);

                            return contact.toJSON();
                        } catch (error) {
                            console.warn('Invalid contact data, using raw data:', error, contactData);
                            // Fallback to raw data if validation fails
                            return DataValidator.sanitizeContactData(contactData);
                        }
                    });

                    filteredContacts = [...contacts];

                    renderContactsTable();
                    updateDashboardStats();
                    updateConnectionStatus('connected', 'Connected');
                    updateSetupStatus('Connected and data loaded successfully!');

                    console.log('Loaded and validated', contacts.length, 'contacts');
                } else {
                    throw new Error(data.error || 'Failed to load contacts');
                }

            } catch (error) {
                console.error('Error loading contacts:', error);

                let errorMessage = 'Connection failed';
                let setupMessage = 'Failed to load contacts. ';

                if (error.name === 'AbortError') {
                    errorMessage = 'Request timeout';
                    setupMessage += 'The request timed out. Please check your connection and try again.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'URL not found';
                    setupMessage += 'Google Apps Script URL not found. Please verify your configuration.';
                } else if (error.message.includes('403')) {
                    errorMessage = 'Access denied';
                    setupMessage += 'Access denied. Please ensure your Google Apps Script is deployed with proper permissions.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error';
                    setupMessage += 'Network error. Please check your internet connection.';
                } else {
                    setupMessage += `Error: ${error.message}`;
                }

                updateConnectionStatus('error', errorMessage);
                updateSetupStatus(setupMessage);

                // Show setup modal for configuration issues
                if (error.message.includes('404') || error.message.includes('Failed to fetch') || error.message.includes('403')) {
                    showSetupModal();
                }

                // Initialize empty state
                contacts = [];
                filteredContacts = [];
                renderContactsTable();
                updateDashboardStats();
            }
        }

        async function saveContact(contactData) {
            // Check configuration before attempting to save
            if (!checkConfiguration()) {
                throw new Error('Google Apps Script not configured. Please complete the setup first.');
            }

            try {
                // Ensure we have a valid Contact object
                let contact;
                if (contactData instanceof Contact) {
                    contact = contactData;
                } else {
                    // Create Contact instance for validation and sanitization
                    const validation = DataValidator.validateContact(contactData);
                    if (!validation.isValid) {
                        throw new ValidationError('Contact validation failed', validation.errors);
                    }
                    contact = validation.contact;
                }

                // Always recalculate score to ensure it's current (Requirements 14.1)
                contact.score = calculateContactScore(contact);
                contact.scoreBreakdown = getScoreBreakdown(contact);

                const sanitizedData = contact.toJSON();

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveContact',
                        data: sanitizedData
                    })
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    console.log('Contact saved successfully:', result.data);

                    // Update local data with sanitized contact data
                    if (result.data.action === 'created') {
                        sanitizedData.id = result.data.id;
                        contacts.push(sanitizedData);
                    } else {
                        const index = contacts.findIndex(c => c.id === result.data.id);
                        if (index !== -1) {
                            contacts[index] = sanitizedData;
                        }
                    }

                    applyFilters();
                    updateDashboardStats();

                    return result.data;
                } else {
                    throw new Error(result.error || 'Failed to save contact');
                }

            } catch (error) {
                console.error('Error saving contact:', error);

                // Handle validation errors specifically
                if (error instanceof ValidationError) {
                    throw error;
                }

                // Handle specific error types
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out. Please try again.');
                } else if (error.message.includes('404')) {
                    throw new Error('Google Apps Script URL not found. Please check your configuration.');
                } else if (error.message.includes('403')) {
                    throw new Error('Access denied. Please check your Google Apps Script permissions.');
                }

                throw error;
            }
        }

        async function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact?')) {
                return;
            }

            try {
                // Use the offline-aware delete function
                const result = await deleteContactWithOfflineSupport(contactId);

                // Update local data immediately for better UX
                contacts = contacts.filter(c => c.id !== contactId);
                selectedContacts.delete(contactId);
                applyFilters();
                updateDashboardStats();
                saveContactsToLocalStorage();

                // Show appropriate success message
                const message = result.offline ? 'Contact deleted offline!' : 'Contact deleted successfully!';
                showNotification(message, result.offline ? 'warning' : 'success');

            } catch (error) {
                console.error('Error deleting contact:', error);
                showNotification('Failed to delete contact: ' + error.message, 'error');
            }
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connection-status');

            statusElement.textContent = message;
            statusElement.className = 'ml-4 px-2 py-1 text-xs rounded-full';

            switch (status) {
                case 'connected':
                    statusElement.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'loading':
                    statusElement.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'error':
                    statusElement.classList.add('bg-red-100', 'text-red-800');
                    break;
                default:
                    statusElement.classList.add('bg-gray-100', 'text-gray-600');
            }
        }

        // ============================================
        // OFFLINE QUEUE AND SYNC MANAGEMENT
        // ============================================

        /**
         * Offline queue for storing changes when connection is lost
         * Requirements: 3.5
         */
        class OfflineQueue {
            constructor() {
                this.queue = this.loadQueue();
                this.isProcessing = false;
                this.maxRetries = 3;
                this.retryDelay = 1000; // Start with 1 second
            }

            loadQueue() {
                try {
                    const stored = localStorageManager.loadData(localStorageManager.storageKeys.queue);
                    return stored && Array.isArray(stored) ? stored : [];
                } catch (error) {
                    console.error('Error loading offline queue:', error);
                    return [];
                }
            }

            saveQueue() {
                try {
                    const success = localStorageManager.saveData(localStorageManager.storageKeys.queue, this.queue);
                    if (!success) {
                        console.error('Failed to save offline queue');
                    }
                } catch (error) {
                    console.error('Error saving offline queue:', error);
                }
            }

            addToQueue(operation) {
                const queueItem = {
                    id: 'queue_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    operation: operation.type, // 'save', 'delete', 'bulk'
                    data: operation.data,
                    timestamp: new Date().toISOString(),
                    retries: 0,
                    maxRetries: this.maxRetries
                };

                this.queue.push(queueItem);
                this.saveQueue();

                console.log('Added operation to offline queue:', queueItem);
                this.updateOfflineStatus();

                return queueItem.id;
            }

            removeFromQueue(itemId) {
                this.queue = this.queue.filter(item => item.id !== itemId);
                this.saveQueue();
                this.updateOfflineStatus();
            }

            async processQueue() {
                if (this.isProcessing || this.queue.length === 0) {
                    return;
                }

                this.isProcessing = true;
                console.log('Processing offline queue with', this.queue.length, 'items');

                const itemsToProcess = [...this.queue];
                let processedCount = 0;
                let failedCount = 0;

                for (const item of itemsToProcess) {
                    try {
                        await this.processQueueItem(item);
                        this.removeFromQueue(item.id);
                        processedCount++;
                    } catch (error) {
                        console.error('Failed to process queue item:', item, error);

                        // Increment retry count
                        item.retries++;

                        if (item.retries >= item.maxRetries) {
                            console.error('Max retries reached for queue item, removing:', item);
                            this.removeFromQueue(item.id);
                            failedCount++;
                        } else {
                            // Update the item in the queue with new retry count
                            const queueIndex = this.queue.findIndex(q => q.id === item.id);
                            if (queueIndex !== -1) {
                                this.queue[queueIndex] = item;
                                this.saveQueue();
                            }
                        }
                    }
                }

                this.isProcessing = false;

                if (processedCount > 0 || failedCount > 0) {
                    const message = `Sync complete: ${processedCount} processed, ${failedCount} failed`;
                    showNotification(message, failedCount > 0 ? 'warning' : 'success');

                    // Refresh data after successful sync
                    if (processedCount > 0) {
                        await loadContacts();
                    }
                }

                this.updateOfflineStatus();
            }

            async processQueueItem(item) {
                switch (item.operation) {
                    case 'save':
                        return await this.processSaveOperation(item.data);
                    case 'delete':
                        return await this.processDeleteOperation(item.data);
                    case 'bulk':
                        return await this.processBulkOperation(item.data);
                    default:
                        throw new Error(`Unknown operation type: ${item.operation}`);
                }
            }

            async processSaveOperation(data) {
                const response = await this.makeRequest('POST', {
                    action: 'saveContact',
                    data: data
                });

                if (!response.success) {
                    throw new Error(response.error || 'Failed to save contact');
                }

                return response;
            }

            async processDeleteOperation(data) {
                const response = await this.makeRequest('POST', {
                    action: 'deleteContact',
                    data: data
                });

                if (!response.success) {
                    throw new Error(response.error || 'Failed to delete contact');
                }

                return response;
            }

            async processBulkOperation(data) {
                const response = await this.makeRequest('POST', {
                    action: 'bulkUpdate',
                    data: data
                });

                if (!response.success) {
                    throw new Error(response.error || 'Failed to process bulk operation');
                }

                return response;
            }

            async makeRequest(method, body = null) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                try {
                    const options = {
                        method: method,
                        signal: controller.signal,
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    };

                    if (body) {
                        options.body = JSON.stringify(body);
                    }

                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, options);
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }

            updateOfflineStatus() {
                const queueCount = this.queue.length;
                const statusElement = document.getElementById('offline-queue-status');

                if (statusElement) {
                    if (queueCount > 0) {
                        statusElement.textContent = `${queueCount} pending`;
                        statusElement.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800';
                        statusElement.style.display = 'inline-block';
                    } else {
                        statusElement.style.display = 'none';
                    }
                }
            }

            getQueueStatus() {
                return {
                    count: this.queue.length,
                    items: this.queue.map(item => ({
                        operation: item.operation,
                        timestamp: item.timestamp,
                        retries: item.retries
                    }))
                };
            }

            clearQueue() {
                this.queue = [];
                this.saveQueue();
                this.updateOfflineStatus();
            }
        }

        /**
         * Enhanced HTTP request handler with retry logic
         * Requirements: 3.1, 3.2, 3.4
         */
        class HttpRequestHandler {
            constructor() {
                this.maxRetries = 3;
                this.baseDelay = 1000; // 1 second
                this.maxDelay = 10000; // 10 seconds
            }

            async makeRequest(url, options = {}, retries = 0) {
                const controller = new AbortController();
                const timeout = options.timeout || 15000;
                const timeoutId = setTimeout(() => controller.abort(), timeout);

                try {
                    const requestOptions = {
                        ...options,
                        signal: controller.signal,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    };

                    const response = await fetch(url, requestOptions);
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data;

                } catch (error) {
                    clearTimeout(timeoutId);

                    // Check if we should retry
                    if (this.shouldRetry(error, retries)) {
                        const delay = this.calculateRetryDelay(retries);
                        console.log(`Request failed, retrying in ${delay}ms (attempt ${retries + 1}/${this.maxRetries + 1}):`, error.message);

                        await this.sleep(delay);
                        return this.makeRequest(url, options, retries + 1);
                    }

                    throw error;
                }
            }

            shouldRetry(error, retries) {
                if (retries >= this.maxRetries) {
                    return false;
                }

                // Don't retry on abort errors (user cancelled)
                if (error.name === 'AbortError') {
                    return false;
                }

                // Don't retry on client errors (4xx) except 408, 429
                if (error.message.includes('HTTP 4')) {
                    const status = parseInt(error.message.match(/HTTP (\d+)/)?.[1]);
                    return status === 408 || status === 429;
                }

                // Retry on network errors and server errors (5xx)
                return error.message.includes('Failed to fetch') ||
                    error.message.includes('HTTP 5') ||
                    error.message.includes('NetworkError') ||
                    error.name === 'TypeError';
            }

            calculateRetryDelay(retries) {
                // Exponential backoff with jitter
                const exponentialDelay = Math.min(this.baseDelay * Math.pow(2, retries), this.maxDelay);
                const jitter = Math.random() * 0.1 * exponentialDelay;
                return Math.floor(exponentialDelay + jitter);
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize offline queue and HTTP handler
        const offlineQueue = new OfflineQueue();
        const httpHandler = new HttpRequestHandler();

        /**
         * Enhanced sync function with offline queue processing
         * Requirements: 3.1, 3.2, 3.5
         */
        async function syncData() {
            const syncBtn = document.getElementById('sync-btn');
            let loadingId = null;

            try {
                // Show loading state
                loadingId = loadingManager.showButtonLoading(syncBtn, 'Syncing...');
                updateConnectionStatus('loading', 'Syncing data...');

                let progress = 0;
                const progressNotificationId = showLoadingNotification('Synchronizing data...', { persistent: true });

                // First, try to process offline queue
                if (offlineQueue.queue.length > 0) {
                    console.log('Processing offline queue before sync...');
                    updateLoadingNotification(progressNotificationId, 'Processing offline changes...', 25);
                    await offlineQueue.processQueue();
                    progress = 50;
                }

                // Then load fresh data from backend
                updateLoadingNotification(progressNotificationId, 'Loading latest data...', progress + 25);
                await loadContacts();
                progress = 100;

                // Save last sync time
                localStorageManager.saveData('gsg_last_sync', new Date().toISOString());

                dismissNotification(progressNotificationId);
                showSuccessNotification('Data synchronized successfully!', [
                    {
                        label: 'View Changes',
                        handler: 'showRecentChanges()',
                        primary: false
                    }
                ]);

                updateConnectionStatus('connected', 'Connected');

            } catch (error) {
                updateConnectionStatus('error', 'Sync failed');
                
                handleError(error, 'Data synchronization', {
                    userFriendly: true,
                    retryHandler: () => syncData(),
                    fallbackHandler: () => {
                        showNotification('Working in offline mode. Your changes are saved locally.', 'info');
                        updateConnectionStatus('error', 'Offline mode');
                    }
                });
            } finally {
                if (loadingId) {
                    loadingManager.hideButtonLoading(loadingId);
                }
            }
        }

        /**
         * Enhanced save function with offline queue support
         * Requirements: 3.1, 3.2, 3.5
         */
        async function saveContactWithOfflineSupport(contactData) {
            // Check if we're online and configured
            if (!navigator.onLine) {
                // Add to offline queue
                offlineQueue.addToQueue({
                    type: 'save',
                    data: contactData
                });

                showNotification('Saved offline. Will sync when connection is restored.', 'info');
                return { success: true, offline: true };
            }

            if (!checkConfiguration()) {
                // Add to offline queue for later processing
                offlineQueue.addToQueue({
                    type: 'save',
                    data: contactData
                });

                showNotification('Saved offline. Please configure Google Apps Script to sync.', 'warning');
                return { success: true, offline: true };
            }

            try {
                // Try to save directly
                const response = await httpHandler.makeRequest(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveContact',
                        data: contactData
                    })
                });

                if (!response.success) {
                    throw new Error(response.error || 'Failed to save contact');
                }

                return response;

            } catch (error) {
                console.error('Failed to save contact, adding to offline queue:', error);

                // Add to offline queue as fallback
                offlineQueue.addToQueue({
                    type: 'save',
                    data: contactData
                });

                showNotification('Saved offline due to connection issue. Will sync later.', 'warning');
                return { success: true, offline: true };
            }
        }

        /**
         * Enhanced delete function with offline queue support
         * Requirements: 3.1, 3.2, 3.5
         */
        async function deleteContactWithOfflineSupport(contactId) {
            // Check if we're online and configured
            if (!navigator.onLine) {
                // Add to offline queue
                offlineQueue.addToQueue({
                    type: 'delete',
                    data: { id: contactId }
                });

                showNotification('Delete queued offline. Will sync when connection is restored.', 'info');
                return { success: true, offline: true };
            }

            if (!checkConfiguration()) {
                // Add to offline queue for later processing
                offlineQueue.addToQueue({
                    type: 'delete',
                    data: { id: contactId }
                });

                showNotification('Delete queued offline. Please configure Google Apps Script to sync.', 'warning');
                return { success: true, offline: true };
            }

            try {
                // Try to delete directly
                const response = await httpHandler.makeRequest(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'deleteContact',
                        data: { id: contactId }
                    })
                });

                if (!response.success) {
                    throw new Error(response.error || 'Failed to delete contact');
                }

                return response;

            } catch (error) {
                console.error('Failed to delete contact, adding to offline queue:', error);

                // Add to offline queue as fallback
                offlineQueue.addToQueue({
                    type: 'delete',
                    data: { id: contactId }
                });

                showNotification('Delete queued offline due to connection issue. Will sync later.', 'warning');
                return { success: true, offline: true };
            }
        }

        /**
         * Enhanced offline mode indicators and user guidance
         * Requirements: 13.4, 13.5
         */
        class OfflineModeManager {
            constructor() {
                this.isOffline = !navigator.onLine;
                this.offlineStartTime = null;
                this.lastSyncTime = null;
                this.setupOfflineIndicators();
            }

            /**
             * Setup offline mode indicators in the UI
             */
            setupOfflineIndicators() {
                // Create offline banner
                this.createOfflineBanner();
                
                // Create offline status in header
                this.updateHeaderStatus();
                
                // Setup periodic status updates
                setInterval(() => this.updateOfflineStatus(), 5000);
            }

            /**
             * Create offline banner for user guidance
             */
            createOfflineBanner() {
                const banner = document.createElement('div');
                banner.id = 'offline-banner';
                banner.className = 'hidden fixed top-0 left-0 right-0 bg-orange-500 text-white px-4 py-2 text-sm z-50';
                banner.innerHTML = `
                    <div class="max-w-7xl mx-auto flex items-center justify-between">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <span id="offline-message">You're working offline. Changes are saved locally.</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="offline-duration" class="text-xs opacity-75"></span>
                            <button onclick="offlineModeManager.tryReconnect()" 
                                    class="text-xs underline hover:no-underline">
                                Try to reconnect
                            </button>
                            <button onclick="offlineModeManager.hideBanner()" 
                                    class="text-xs opacity-75 hover:opacity-100">
                                ×
                            </button>
                        </div>
                    </div>
                `;
                document.body.insertBefore(banner, document.body.firstChild);
            }

            /**
             * Update header connection status
             */
            updateHeaderStatus() {
                const statusElement = document.getElementById('connection-status');
                if (!statusElement) return;

                if (this.isOffline) {
                    statusElement.className = 'ml-4 px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800';
                    statusElement.textContent = 'Offline Mode';
                    statusElement.title = 'Working offline - changes saved locally';
                } else {
                    statusElement.className = 'ml-4 px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
                    statusElement.textContent = 'Online';
                    statusElement.title = 'Connected to server';
                }
            }

            /**
             * Show offline banner with guidance
             */
            showOfflineBanner() {
                const banner = document.getElementById('offline-banner');
                if (banner) {
                    banner.classList.remove('hidden');
                    this.updateOfflineDuration();
                }
            }

            /**
             * Hide offline banner
             */
            hideBanner() {
                const banner = document.getElementById('offline-banner');
                if (banner) {
                    banner.classList.add('hidden');
                }
            }

            /**
             * Update offline duration display
             */
            updateOfflineDuration() {
                if (!this.offlineStartTime) return;

                const duration = Date.now() - this.offlineStartTime;
                const minutes = Math.floor(duration / 60000);
                const hours = Math.floor(minutes / 60);

                const durationElement = document.getElementById('offline-duration');
                if (durationElement) {
                    if (hours > 0) {
                        durationElement.textContent = `Offline for ${hours}h ${minutes % 60}m`;
                    } else if (minutes > 0) {
                        durationElement.textContent = `Offline for ${minutes}m`;
                    } else {
                        durationElement.textContent = 'Just went offline';
                    }
                }
            }

            /**
             * Handle going offline
             */
            goOffline() {
                if (!this.isOffline) {
                    this.isOffline = true;
                    this.offlineStartTime = Date.now();
                    
                    this.showOfflineBanner();
                    this.updateHeaderStatus();
                    this.showOfflineGuidance();
                    
                    console.log('Switched to offline mode');
                }
            }

            /**
             * Handle coming back online
             */
            async goOnline() {
                if (this.isOffline) {
                    this.isOffline = false;
                    this.offlineStartTime = null;
                    this.lastSyncTime = Date.now();
                    
                    this.hideBanner();
                    this.updateHeaderStatus();
                    
                    // Process offline queue
                    try {
                        await offlineQueue.processQueue();
                        showNotification('Back online! All changes synced successfully.', 'success');
                    } catch (error) {
                        console.error('Failed to sync offline changes:', error);
                        showNotification('Back online but some changes failed to sync. Please check the queue.', 'warning');
                    }
                    
                    console.log('Switched to online mode');
                }
            }

            /**
             * Show offline mode guidance
             */
            showOfflineGuidance() {
                const guidance = `
                    <div class="mb-4">
                        <h4 class="font-semibold text-gray-900 mb-2">Working Offline</h4>
                        <p class="text-sm text-gray-600 mb-3">
                            You're currently working offline. Here's what you can do:
                        </p>
                        <ul class="text-sm text-gray-600 space-y-1 list-disc list-inside">
                            <li>View and edit existing contacts</li>
                            <li>Add new contacts and activities</li>
                            <li>Use search and filtering features</li>
                            <li>Export data to CSV</li>
                        </ul>
                        <p class="text-sm text-gray-600 mt-3">
                            <strong>Note:</strong> All changes are saved locally and will sync automatically when you're back online.
                        </p>
                    </div>
                `;

                showNotification(guidance, 'info', { 
                    persistent: true, 
                    html: true,
                    actions: [
                        {
                            label: 'View Pending Changes',
                            handler: () => this.showPendingChanges(),
                            primary: false
                        },
                        {
                            label: 'Got it',
                            handler: () => {},
                            primary: true
                        }
                    ]
                });
            }

            /**
             * Show pending changes in offline queue
             */
            showPendingChanges() {
                const queueStatus = offlineQueue.getQueueStatus();
                
                if (queueStatus.count === 0) {
                    showNotification('No pending changes to sync.', 'info');
                    return;
                }

                const changesList = queueStatus.items.map(item => {
                    const date = new Date(item.timestamp).toLocaleString();
                    return `<li class="text-sm">${item.operation} - ${date} (${item.retries} retries)</li>`;
                }).join('');

                const content = `
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">Pending Changes (${queueStatus.count})</h4>
                        <ul class="space-y-1 list-disc list-inside max-h-40 overflow-y-auto">
                            ${changesList}
                        </ul>
                        <p class="text-sm text-gray-600 mt-3">
                            These changes will sync automatically when you're back online.
                        </p>
                    </div>
                `;

                showNotification(content, 'info', { 
                    html: true,
                    actions: [
                        {
                            label: 'Try Sync Now',
                            handler: () => this.tryReconnect(),
                            primary: true
                        }
                    ]
                });
            }

            /**
             * Try to reconnect and sync
             */
            async tryReconnect() {
                updateConnectionStatus('loading', 'Checking connection...');
                
                try {
                    // Test connection with a simple request
                    const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                        method: 'GET',
                        signal: AbortSignal.timeout(5000)
                    });

                    if (response.ok) {
                        await this.goOnline();
                    } else {
                        throw new Error('Server not responding');
                    }
                } catch (error) {
                    console.log('Still offline:', error.message);
                    updateConnectionStatus('error', 'Still offline');
                    showNotification('Still unable to connect. Will keep trying automatically.', 'warning');
                }
            }

            /**
             * Update offline status periodically
             */
            updateOfflineStatus() {
                const wasOffline = this.isOffline;
                const isCurrentlyOffline = !navigator.onLine;

                if (wasOffline && !isCurrentlyOffline) {
                    // Just came back online
                    this.goOnline();
                } else if (!wasOffline && isCurrentlyOffline) {
                    // Just went offline
                    this.goOffline();
                } else if (this.isOffline) {
                    // Still offline, update duration
                    this.updateOfflineDuration();
                }
            }

            /**
             * Get offline statistics
             */
            getOfflineStats() {
                return {
                    isOffline: this.isOffline,
                    offlineDuration: this.offlineStartTime ? Date.now() - this.offlineStartTime : 0,
                    lastSyncTime: this.lastSyncTime,
                    pendingChanges: offlineQueue.getQueueStatus().count,
                    localStorageUsage: localStorageManager.getStorageStats()
                };
            }
        }

        /**
         * Monitor online/offline status and process queue when back online
         * Requirements: 3.5, 13.4, 13.5
         */
        function initializeOfflineSupport() {
            // Initialize offline mode manager
            window.offlineModeManager = new OfflineModeManager();

            // Listen for online/offline events
            window.addEventListener('online', async () => {
                console.log('Connection restored, processing offline queue...');
                await offlineModeManager.goOnline();
            });

            window.addEventListener('offline', () => {
                console.log('Connection lost, switching to offline mode...');
                offlineModeManager.goOffline();
            });

            // Update initial offline status
            offlineQueue.updateOfflineStatus();
            
            // Set initial state
            if (!navigator.onLine) {
                offlineModeManager.goOffline();
            }
        }

        /**
         * Process offline queue manually
         */
        async function processOfflineQueue() {
            const processBtn = document.getElementById('process-queue-btn');
            const originalText = processBtn.textContent;

            try {
                processBtn.innerHTML = '<div class="loading-spinner mr-1"></div>Processing...';
                processBtn.disabled = true;

                await offlineQueue.processQueue();
                updateQueueStatusDisplay();

            } catch (error) {
                console.error('Error processing queue:', error);
                showNotification('Failed to process queue: ' + error.message, 'error');
            } finally {
                processBtn.textContent = originalText;
                processBtn.disabled = false;
            }
        }

        /**
         * Clear offline queue
         */
        function clearOfflineQueue() {
            if (confirm('Are you sure you want to clear all pending operations? This cannot be undone.')) {
                offlineQueue.clearQueue();
                updateQueueStatusDisplay();
                showNotification('Offline queue cleared', 'info');
            }
        }

        /**
         * Update queue status display in setup modal
         */
        function updateQueueStatusDisplay() {
            const queueCount = document.getElementById('queue-count');
            const processBtn = document.getElementById('process-queue-btn');
            const clearBtn = document.getElementById('clear-queue-btn');

            if (queueCount && processBtn && clearBtn) {
                const status = offlineQueue.getQueueStatus();
                queueCount.textContent = status.count;

                // Enable/disable buttons based on queue status
                processBtn.disabled = status.count === 0;
                clearBtn.disabled = status.count === 0;

                // Update button text
                if (status.count === 0) {
                    processBtn.textContent = 'No items to process';
                    clearBtn.textContent = 'Queue empty';
                } else {
                    processBtn.textContent = 'Process Queue';
                    clearBtn.textContent = 'Clear Queue';
                }
            }

            // Also update storage status
            updateStorageStatusDisplay();
        }

        /**
         * Update storage status display in setup modal
         * Requirements: 13.4, 13.5
         */
        function updateStorageStatusDisplay() {
            try {
                const stats = localStorageManager.getStorageStats();
                
                // Update contact count
                const contactsCount = document.getElementById('storage-contacts-count');
                if (contactsCount) {
                    contactsCount.textContent = contacts.length.toString();
                }

                // Update activities count
                const activitiesCount = document.getElementById('storage-activities-count');
                if (activitiesCount) {
                    activitiesCount.textContent = activities.length.toString();
                }

                // Update storage usage
                const usagePercent = document.getElementById('storage-usage-percent');
                if (usagePercent) {
                    const percent = Math.round(stats.usagePercent);
                    usagePercent.textContent = `${percent}%`;
                    
                    // Color code based on usage
                    if (percent > 90) {
                        usagePercent.className = 'font-medium text-red-600';
                    } else if (percent > 75) {
                        usagePercent.className = 'font-medium text-yellow-600';
                    } else {
                        usagePercent.className = 'font-medium text-green-600';
                    }
                }

                // Update last sync time
                const lastSync = document.getElementById('storage-last-sync');
                if (lastSync) {
                    const lastSyncData = localStorageManager.loadData('gsg_last_sync');
                    if (lastSyncData) {
                        const date = new Date(lastSyncData);
                        lastSync.textContent = date.toLocaleString();
                    } else {
                        lastSync.textContent = 'Never';
                    }
                }

            } catch (error) {
                console.error('Failed to update storage status display:', error);
            }
        }

        /**
         * Create data backup and download
         * Requirements: 13.4
         */
        function createDataBackup() {
            try {
                const backup = localStorageManager.exportData();
                const backupData = JSON.stringify(backup, null, 2);
                
                // Create download link
                const blob = new Blob([backupData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `gsg-contact-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('Data backup created and downloaded successfully!', 'success');
                
            } catch (error) {
                console.error('Failed to create backup:', error);
                showNotification('Failed to create data backup: ' + error.message, 'error');
            }
        }

        /**
         * Clear local storage with confirmation
         * Requirements: 13.4
         */
        function clearLocalStorage() {
            const confirmation = confirm(
                'Are you sure you want to clear all local data? This will:\n\n' +
                '• Delete all contacts and activities stored locally\n' +
                '• Clear the offline queue\n' +
                '• Remove all cached data\n\n' +
                'This action cannot be undone. Make sure you have synced with the server or created a backup first.'
            );

            if (confirmation) {
                try {
                    // Create backup before clearing
                    const backupKey = backupLocalData();
                    
                    // Clear all data
                    localStorageManager.clearAllData();
                    
                    // Reset application state
                    contacts = [];
                    activities = [];
                    offlineQueue.clearQueue();
                    
                    // Update UI
                    renderContactsTable();
                    updateDashboardStats();
                    updateQueueStatusDisplay();
                    
                    showNotification(
                        `Local storage cleared successfully! ${backupKey ? 'A backup was created automatically.' : ''}`, 
                        'success'
                    );
                    
                } catch (error) {
                    console.error('Failed to clear local storage:', error);
                    showNotification('Failed to clear local storage: ' + error.message, 'error');
                }
            }
        }

        // ============================================
        // CONFIGURATION MANAGEMENT
        // ============================================

        function checkConfiguration() {
            console.log('Checking configuration...');

            // Check if URL is configured
            if (!CONFIG.GOOGLE_SCRIPT_URL ||
                CONFIG.GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE' ||
                CONFIG.GOOGLE_SCRIPT_URL.trim() === '') {

                updateConnectionStatus('error', 'Not configured');
                updateSetupStatus('Google Apps Script URL not configured. Please follow the setup instructions.');
                showSetupModal();
                return false;
            }

            // Check if URL format is valid
            if (!isValidGoogleAppsScriptUrl(CONFIG.GOOGLE_SCRIPT_URL)) {
                updateConnectionStatus('error', 'Invalid URL format');
                updateSetupStatus('Invalid Google Apps Script URL format. Please check your configuration.');
                showSetupModal();
                return false;
            }

            console.log('Configuration appears valid, testing connection...');
            return true;
        }

        function isValidGoogleAppsScriptUrl(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname === 'script.google.com' &&
                    urlObj.pathname.includes('/macros/s/') &&
                    urlObj.pathname.endsWith('/exec');
            } catch (e) {
                return false;
            }
        }

        async function validateConnection() {
            if (!checkConfiguration()) {
                return false;
            }

            try {
                updateConnectionStatus('loading', 'Testing connection...');

                // Test connection with a simple ping
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL + '?action=ping', {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Try to parse response
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    // If response is not JSON, it might still be a valid endpoint
                    console.warn('Response is not JSON, but connection seems to work');
                    updateConnectionStatus('connected', 'Connected');
                    updateSetupStatus('Connection successful! Google Apps Script is responding.');
                    return true;
                }

                // Check if it's our expected response format
                if (data && (data.success !== undefined || data.error !== undefined)) {
                    updateConnectionStatus('connected', 'Connected');
                    updateSetupStatus('Connection successful! Google Apps Script is properly configured.');
                    return true;
                } else {
                    updateConnectionStatus('connected', 'Connected');
                    updateSetupStatus('Connection successful! Google Apps Script is responding.');
                    return true;
                }

            } catch (error) {
                console.error('Connection validation failed:', error);

                let errorMessage = 'Connection failed';
                let setupMessage = 'Failed to connect to Google Apps Script. ';

                if (error.name === 'AbortError') {
                    errorMessage = 'Connection timeout';
                    setupMessage += 'The request timed out. Please check your URL and try again.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'URL not found';
                    setupMessage += 'The URL was not found. Please verify your Google Apps Script Web App URL.';
                } else if (error.message.includes('403')) {
                    errorMessage = 'Access denied';
                    setupMessage += 'Access denied. Please ensure your Google Apps Script is deployed with "Anyone" access.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error';
                    setupMessage += 'Network error. Please check your internet connection and CORS settings.';
                } else {
                    setupMessage += `Error: ${error.message}`;
                }

                updateConnectionStatus('error', errorMessage);
                updateSetupStatus(setupMessage);

                return false;
            }
        }

        function updateSetupStatus(message) {
            const statusElement = document.getElementById('setup-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        function showSetupModal() {
            document.getElementById('setup-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Update queue and storage status when modal opens
            updateQueueStatusDisplay();
            updateStorageStatusDisplay();
        }

        function hideSetupModal() {
            document.getElementById('setup-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function testConnection() {
            const testBtn = document.getElementById('test-connection-btn');
            const originalText = testBtn.textContent;

            testBtn.disabled = true;
            testBtn.innerHTML = '<div class="loading-spinner mr-2"></div>Testing...';

            try {
                const isValid = await validateConnection();

                if (isValid) {
                    showNotification('Connection test successful! Your Google Apps Script is working correctly.', 'success');

                    // Try to load contacts to fully test the integration
                    setTimeout(async () => {
                        try {
                            await loadContacts();
                            showNotification('Data loaded successfully! Setup is complete.', 'success');
                        } catch (error) {
                            console.warn('Connection works but data loading failed:', error);
                            showNotification('Connection works, but there may be issues with data format. Check your Google Apps Script implementation.', 'warning');
                        }
                    }, 1000);

                } else {
                    showNotification('Connection test failed. Please check the setup instructions and try again.', 'error');
                }
            } catch (error) {
                console.error('Test connection error:', error);
                showNotification('Connection test failed: ' + error.message, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        // ============================================
        // CONTACT MODAL FUNCTIONS
        // ============================================

        function openAddContactModal() {
            isEditMode = false;
            currentEditId = null;
            document.getElementById('modal-title').textContent = 'Add New Contact';
            document.getElementById('contact-form').reset();

            // Set default values
            document.getElementById('contact-status').value = 'New';
            document.getElementById('contact-priority').value = 'None';

            document.getElementById('contact-modal').classList.remove('hidden');
        }

        function openEditContactModal(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;

            isEditMode = true;
            currentEditId = contactId;
            document.getElementById('modal-title').textContent = 'Edit Contact';

            // Populate form with contact data
            Object.keys(contact).forEach(key => {
                const element = document.getElementById('contact-' + key);
                if (element) {
                    element.value = contact[key] || '';
                }
            });

            document.getElementById('contact-modal').classList.remove('hidden');
        }

        function closeContactModal() {
            document.getElementById('contact-modal').classList.add('hidden');
            document.getElementById('contact-form').reset();
            isEditMode = false;
            currentEditId = null;
        }

        async function handleContactFormSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const contactData = {};

            // Convert form data to object
            for (let [key, value] of formData.entries()) {
                contactData[key] = value;
            }

            // Add metadata
            if (isEditMode) {
                contactData.id = currentEditId;
            }

            // Validate contact data using the Contact model
            const validation = DataValidator.validateContact(contactData);

            if (!validation.isValid) {
                // Show validation errors in the form
                DataValidator.showValidationErrors(validation.errors);
                return;
            }

            try {
                // Use the offline-aware save function
                const result = await saveContactWithOfflineSupport(validation.contact.toJSON());
                closeContactModal();

                // Show appropriate success message based on result
                let message;
                if (result.offline) {
                    message = isEditMode ? 'Contact updated offline!' : 'Contact added offline!';
                } else {
                    message = isEditMode ? 'Contact updated successfully!' : 'Contact added successfully!';
                }
                showNotification(message, result.offline ? 'warning' : 'success');

                // Update local data immediately for better UX
                if (isEditMode) {
                    const index = contacts.findIndex(c => c.id === validation.contact.id);
                    if (index !== -1) {
                        contacts[index] = validation.contact.toJSON();
                    }
                } else {
                    // Generate temporary ID for new contacts saved offline
                    if (!validation.contact.id) {
                        validation.contact.id = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    contacts.push(validation.contact.toJSON());
                }

                // Update UI
                applyFilters();
                updateDashboardStats();
                saveContactsToLocalStorage();

            } catch (error) {
                console.error('Error saving contact:', error);
                showNotification('Failed to save contact: ' + error.message, 'error');
            }
        }

        // ============================================
        // ENHANCED ERROR HANDLING AND USER FEEDBACK
        // ============================================

        /**
         * Enhanced notification system with better UX and recovery options
         * Requirements: 3.4, 7.5, 9.4
         */
        function showNotification(message, type = 'info', options = {}) {
            const {
                duration = type === 'error' ? 8000 : type === 'warning' ? 6000 : 4000,
                persistent = false,
                actions = [],
                details = null,
                canDismiss = true
            } = options;

            // Create notification container if it doesn't exist
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.className = 'fixed top-4 right-4 z-50 space-y-2 max-w-sm w-full';
                document.body.appendChild(container);
            }

            // Create notification element
            const notification = document.createElement('div');
            const notificationId = 'notification-' + Date.now();
            notification.id = notificationId;
            notification.className = `bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 translate-x-full opacity-0`;

            const bgColor = {
                'success': 'bg-green-50 border-green-200',
                'error': 'bg-red-50 border-red-200',
                'warning': 'bg-yellow-50 border-yellow-200',
                'info': 'bg-blue-50 border-blue-200',
                'loading': 'bg-blue-50 border-blue-200'
            }[type] || 'bg-gray-50 border-gray-200';

            const iconColor = {
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400',
                'info': 'text-blue-400',
                'loading': 'text-blue-400'
            }[type] || 'text-gray-400';

            const icon = {
                'success': 'M5 13l4 4L19 7',
                'error': 'M6 18L18 6M6 6l12 12',
                'warning': 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z',
                'info': 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
                'loading': 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15'
            }[type] || 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z';

            let actionsHtml = '';
            if (actions.length > 0) {
                actionsHtml = `
                    <div class="mt-3 flex space-x-2">
                        ${actions.map(action => `
                            <button onclick="${action.handler}" 
                                    class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-white ${action.primary ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 hover:bg-gray-700'} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                ${action.label}
                            </button>
                        `).join('')}
                    </div>
                `;
            }

            let detailsHtml = '';
            if (details) {
                detailsHtml = `
                    <div class="mt-2">
                        <button onclick="toggleNotificationDetails('${notificationId}')" 
                                class="text-xs text-gray-500 hover:text-gray-700 underline">
                            Show details
                        </button>
                        <div id="${notificationId}-details" class="hidden mt-2 text-xs text-gray-600 bg-gray-100 p-2 rounded">
                            ${details}
                        </div>
                    </div>
                `;
            }

            notification.innerHTML = `
                <div class="p-4 ${bgColor} border-l-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            ${type === 'loading' ? 
                                `<div class="loading-spinner"></div>` :
                                `<svg class="h-5 w-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icon}"></path>
                                </svg>`
                            }
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium text-gray-900">${message}</p>
                            ${actionsHtml}
                            ${detailsHtml}
                        </div>
                        ${canDismiss ? `
                            <div class="ml-auto pl-3">
                                <div class="-mx-1.5 -my-1.5">
                                    <button type="button" class="inline-flex bg-transparent rounded-md p-1.5 text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" onclick="dismissNotification('${notificationId}')">
                                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            container.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 100);

            // Auto remove after duration (unless persistent)
            if (!persistent && duration > 0) {
                setTimeout(() => {
                    dismissNotification(notificationId);
                }, duration);
            }

            return notificationId;
        }

        /**
         * Dismiss a specific notification
         */
        function dismissNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            if (notification) {
                notification.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }

        /**
         * Toggle notification details
         */
        function toggleNotificationDetails(notificationId) {
            const details = document.getElementById(notificationId + '-details');
            if (details) {
                details.classList.toggle('hidden');
            }
        }

        /**
         * Clear all notifications
         */
        function clearAllNotifications() {
            const container = document.getElementById('notification-container');
            if (container) {
                container.innerHTML = '';
            }
        }

        /**
         * Show loading notification with progress tracking
         */
        function showLoadingNotification(message, options = {}) {
            return showNotification(message, 'loading', {
                persistent: true,
                canDismiss: false,
                ...options
            });
        }

        /**
         * Update loading notification with progress
         */
        function updateLoadingNotification(notificationId, message, progress = null) {
            const notification = document.getElementById(notificationId);
            if (notification) {
                const messageElement = notification.querySelector('.text-sm.font-medium');
                if (messageElement) {
                    let progressHtml = '';
                    if (progress !== null) {
                        progressHtml = `
                            <div class="mt-2">
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">${progress}% complete</div>
                            </div>
                        `;
                    }
                    messageElement.innerHTML = message + progressHtml;
                }
            }
        }

        /**
         * Enhanced error handler with recovery options
         */
        function handleError(error, context = '', options = {}) {
            console.error(`Error in ${context}:`, error);

            const {
                showNotification: shouldShowNotification = true,
                retryHandler = null,
                fallbackHandler = null,
                userFriendly = true
            } = options;

            let message = error.message || 'An unexpected error occurred';
            let details = null;
            let actions = [];

            // Make error messages more user-friendly
            if (userFriendly) {
                if (error.message?.includes('fetch')) {
                    message = 'Connection failed. Please check your internet connection.';
                } else if (error.message?.includes('JSON')) {
                    message = 'Invalid response from server. Please try again.';
                } else if (error.message?.includes('timeout')) {
                    message = 'Request timed out. Please try again.';
                } else if (error.name === 'ValidationError') {
                    message = 'Please check your input and try again.';
                }
            }

            // Add technical details for debugging
            if (error.stack) {
                details = `Context: ${context}<br>Error: ${error.message}<br>Stack: ${error.stack.substring(0, 500)}...`;
            }

            // Add retry action if handler provided
            if (retryHandler) {
                actions.push({
                    label: 'Retry',
                    handler: `(${retryHandler.toString()})()`,
                    primary: true
                });
            }

            // Add fallback action if handler provided
            if (fallbackHandler) {
                actions.push({
                    label: 'Use Offline Mode',
                    handler: `(${fallbackHandler.toString()})()`,
                    primary: false
                });
            }

            if (shouldShowNotification) {
                return showNotification(message, 'error', {
                    duration: 8000,
                    actions,
                    details
                });
            }

            return null;
        }

        /**
         * Show success notification with optional actions
         */
        function showSuccessNotification(message, actions = []) {
            return showNotification(message, 'success', { actions });
        }

        /**
         * Show confirmation dialog with promise-based response
         */
        function showConfirmationDialog(title, message, options = {}) {
            return new Promise((resolve) => {
                const {
                    confirmText = 'Confirm',
                    cancelText = 'Cancel',
                    type = 'warning'
                } = options;

                const actions = [
                    {
                        label: confirmText,
                        handler: `resolveConfirmation('${Date.now()}', true)`,
                        primary: true
                    },
                    {
                        label: cancelText,
                        handler: `resolveConfirmation('${Date.now()}', false)`,
                        primary: false
                    }
                ];

                const confirmationId = Date.now().toString();
                window[`resolveConfirmation`] = (id, result) => {
                    if (id === confirmationId) {
                        resolve(result);
                        delete window[`resolveConfirmation`];
                    }
                };

                showNotification(`<strong>${title}</strong><br>${message}`, type, {
                    persistent: true,
                    actions,
                    canDismiss: false
                });
            });
        }

        // ============================================
        // LOADING STATE MANAGEMENT
        // ============================================

        /**
         * Global loading state manager
         */
        class LoadingStateManager {
            constructor() {
                this.activeOperations = new Map();
                this.globalOverlay = null;
            }

            /**
             * Show loading state for a specific button
             */
            showButtonLoading(buttonElement, loadingText = null) {
                if (!buttonElement) return null;

                const operationId = 'btn-' + Date.now();
                const originalState = {
                    text: buttonElement.innerHTML,
                    disabled: buttonElement.disabled,
                    className: buttonElement.className
                };

                this.activeOperations.set(operationId, {
                    type: 'button',
                    element: buttonElement,
                    originalState
                });

                buttonElement.disabled = true;
                buttonElement.classList.add('btn-loading');
                
                if (loadingText) {
                    buttonElement.innerHTML = `<div class="loading-spinner-sm mr-2"></div>${loadingText}`;
                } else {
                    buttonElement.innerHTML = '<div class="loading-spinner-sm"></div>';
                }

                return operationId;
            }

            /**
             * Hide loading state for a specific button
             */
            hideButtonLoading(operationId) {
                const operation = this.activeOperations.get(operationId);
                if (!operation || operation.type !== 'button') return;

                const { element, originalState } = operation;
                element.innerHTML = originalState.text;
                element.disabled = originalState.disabled;
                element.className = originalState.className;

                this.activeOperations.delete(operationId);
            }

            /**
             * Show global loading overlay
             */
            showGlobalLoading(message = 'Loading...', showProgress = false) {
                this.hideGlobalLoading(); // Remove any existing overlay

                const operationId = 'global-' + Date.now();
                
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.id = 'global-loading-overlay';

                let progressHtml = '';
                if (showProgress) {
                    progressHtml = `
                        <div class="progress-container mt-4">
                            <div class="progress-bar-fill" id="global-progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="text-sm text-gray-600 mt-2" id="global-progress-text">0% complete</div>
                    `;
                }

                overlay.innerHTML = `
                    <div class="loading-content">
                        <div class="loading-spinner-lg mx-auto mb-4"></div>
                        <div class="text-lg font-medium text-gray-900" id="global-loading-message">${message}</div>
                        ${progressHtml}
                    </div>
                `;

                document.body.appendChild(overlay);
                this.globalOverlay = overlay;

                this.activeOperations.set(operationId, {
                    type: 'global',
                    element: overlay
                });

                return operationId;
            }

            /**
             * Update global loading progress
             */
            updateGlobalProgress(progress, message = null) {
                const progressBar = document.getElementById('global-progress-bar');
                const progressText = document.getElementById('global-progress-text');
                const messageElement = document.getElementById('global-loading-message');

                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }

                if (progressText) {
                    progressText.textContent = `${progress}% complete`;
                }

                if (message && messageElement) {
                    messageElement.textContent = message;
                }
            }

            /**
             * Hide global loading overlay
             */
            hideGlobalLoading() {
                if (this.globalOverlay) {
                    this.globalOverlay.remove();
                    this.globalOverlay = null;
                }

                // Remove any global operations from the map
                for (const [id, operation] of this.activeOperations.entries()) {
                    if (operation.type === 'global') {
                        this.activeOperations.delete(id);
                    }
                }
            }

            /**
             * Show loading state for a specific element
             */
            showElementLoading(element, message = 'Loading...') {
                if (!element) return null;

                const operationId = 'elem-' + Date.now();
                const originalContent = element.innerHTML;

                this.activeOperations.set(operationId, {
                    type: 'element',
                    element,
                    originalContent
                });

                element.innerHTML = `
                    <div class="flex items-center justify-center py-8">
                        <div class="loading-spinner mr-3"></div>
                        <span class="text-gray-600">${message}</span>
                    </div>
                `;

                return operationId;
            }

            /**
             * Hide loading state for a specific element
             */
            hideElementLoading(operationId) {
                const operation = this.activeOperations.get(operationId);
                if (!operation || operation.type !== 'element') return;

                const { element, originalContent } = operation;
                element.innerHTML = originalContent;

                this.activeOperations.delete(operationId);
            }

            /**
             * Clear all loading states
             */
            clearAllLoading() {
                for (const [id, operation] of this.activeOperations.entries()) {
                    switch (operation.type) {
                        case 'button':
                            this.hideButtonLoading(id);
                            break;
                        case 'element':
                            this.hideElementLoading(id);
                            break;
                        case 'global':
                            this.hideGlobalLoading();
                            break;
                    }
                }
            }
        }

        // Global loading state manager instance
        const loadingManager = new LoadingStateManager();

        // ============================================
        // ENHANCED API ERROR HANDLING
        // ============================================

        /**
         * Enhanced API wrapper with comprehensive error handling
         */
        class APIHandler {
            constructor() {
                this.baseTimeout = 10000; // 10 seconds
                this.maxRetries = 3;
                this.retryDelay = 1000;
            }

            /**
             * Make API request with comprehensive error handling
             */
            async makeRequest(url, options = {}) {
                const {
                    method = 'GET',
                    body = null,
                    headers = {},
                    timeout = this.baseTimeout,
                    retries = this.maxRetries,
                    showLoading = true,
                    context = 'API request'
                } = options;

                let loadingId = null;
                if (showLoading) {
                    loadingId = showLoadingNotification(`${context}...`);
                }

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);

                    const response = await fetch(url, {
                        method,
                        body,
                        headers: {
                            'Content-Type': 'application/json',
                            ...headers
                        },
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (loadingId) {
                        dismissNotification(loadingId);
                    }

                    return { success: true, data };

                } catch (error) {
                    if (loadingId) {
                        dismissNotification(loadingId);
                    }

                    // Handle different types of errors
                    if (error.name === 'AbortError') {
                        error.message = 'Request timed out. Please try again.';
                    } else if (!navigator.onLine) {
                        error.message = 'No internet connection. Please check your network.';
                    }

                    // Retry logic for certain errors
                    if (retries > 0 && this.shouldRetry(error)) {
                        await this.delay(this.retryDelay);
                        return this.makeRequest(url, { ...options, retries: retries - 1 });
                    }

                    return { success: false, error };
                }
            }

            /**
             * Determine if an error should trigger a retry
             */
            shouldRetry(error) {
                const retryableErrors = [
                    'fetch',
                    'network',
                    'timeout',
                    'AbortError',
                    'TypeError'
                ];

                return retryableErrors.some(type => 
                    error.name?.includes(type) || error.message?.toLowerCase().includes(type)
                );
            }

            /**
             * Delay utility for retries
             */
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Global API handler instance
        const apiHandler = new APIHandler();

        // ============================================
        // ERROR REPORTING AND RECOVERY UTILITIES
        // ============================================

        /**
         * Show detailed error information in a modal
         */
        function showErrorDetails(error, context) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900">Error Details</h3>
                                    <div class="mt-2">
                                        <p class="text-sm text-gray-500 mb-3"><strong>Context:</strong> ${context}</p>
                                        <p class="text-sm text-gray-500 mb-3"><strong>Error:</strong> ${error.message}</p>
                                        ${error.stack ? `<details class="text-xs text-gray-400">
                                            <summary class="cursor-pointer">Technical Details</summary>
                                            <pre class="mt-2 p-2 bg-gray-100 rounded overflow-x-auto">${error.stack}</pre>
                                        </details>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        /**
         * Show recent changes and activity
         */
        function showRecentChanges() {
            // Get recent activities from contacts
            const recentActivities = [];
            contacts.forEach(contact => {
                if (contact.activities && contact.activities.length > 0) {
                    contact.activities.slice(-5).forEach(activity => {
                        recentActivities.push({
                            ...activity,
                            contactName: contact.name,
                            contactId: contact.id
                        });
                    });
                }
            });

            // Sort by date
            recentActivities.sort((a, b) => new Date(b.date) - new Date(a.date));

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                    </div>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Recent Changes</h3>
                            <div class="max-h-96 overflow-y-auto">
                                ${recentActivities.length > 0 ? 
                                    recentActivities.slice(0, 20).map(activity => `
                                        <div class="border-b border-gray-200 py-3">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <p class="text-sm font-medium text-gray-900">${activity.contactName}</p>
                                                    <p class="text-sm text-gray-600">${activity.type}: ${activity.notes}</p>
                                                </div>
                                                <span class="text-xs text-gray-500">${new Date(activity.date).toLocaleDateString()}</span>
                                            </div>
                                        </div>
                                    `).join('') :
                                    '<p class="text-gray-500 text-center py-8">No recent activities found</p>'
                                }
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        /**
         * Show import errors
         */
        function showImportErrors() {
            // This would show detailed import errors if we tracked them
            showNotification('Import error details would be shown here in a future version', 'info');
        }

        /**
         * Show bulk update errors
         */
        function showBulkUpdateErrors() {
            // This would show detailed bulk update errors if we tracked them
            showNotification('Bulk update error details would be shown here in a future version', 'info');
        }

        /**
         * Enhanced connection status with recovery suggestions
         */
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connection-status');
            if (!statusElement) return;

            statusElement.textContent = message;
            statusElement.className = 'ml-4 px-2 py-1 text-xs rounded-full cursor-pointer';

            // Add click handler for detailed status
            statusElement.onclick = () => showConnectionDetails(status, message);

            switch (status) {
                case 'connected':
                    statusElement.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'loading':
                    statusElement.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'error':
                    statusElement.classList.add('bg-red-100', 'text-red-800');
                    break;
                default:
                    statusElement.classList.add('bg-gray-100', 'text-gray-600');
            }
        }

        /**
         * Show detailed connection status and recovery options
         */
        function showConnectionDetails(status, message) {
            let content = '';
            let actions = [];

            switch (status) {
                case 'connected':
                    content = `
                        <p class="text-green-600 mb-2">✓ Connected to Google Sheets</p>
                        <p class="text-sm text-gray-600">Your data is syncing properly with the backend.</p>
                    `;
                    actions = [
                        {
                            label: 'Test Connection',
                            handler: 'validateConnection()',
                            primary: false
                        }
                    ];
                    break;
                case 'error':
                    content = `
                        <p class="text-red-600 mb-2">✗ Connection Error</p>
                        <p class="text-sm text-gray-600 mb-3">${message}</p>
                        <div class="text-sm text-gray-600">
                            <p class="font-medium mb-2">Troubleshooting steps:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Check your internet connection</li>
                                <li>Verify Google Apps Script URL is correct</li>
                                <li>Ensure Google Apps Script is deployed and accessible</li>
                                <li>Try refreshing the page</li>
                            </ul>
                        </div>
                    `;
                    actions = [
                        {
                            label: 'Retry Connection',
                            handler: 'validateConnection()',
                            primary: true
                        },
                        {
                            label: 'Setup Guide',
                            handler: 'showSetupModal()',
                            primary: false
                        }
                    ];
                    break;
                case 'loading':
                    content = `
                        <p class="text-yellow-600 mb-2">⏳ ${message}</p>
                        <p class="text-sm text-gray-600">Please wait while the operation completes.</p>
                    `;
                    break;
                default:
                    content = `
                        <p class="text-gray-600 mb-2">Status: ${message}</p>
                    `;
            }

            showNotification(content, status === 'error' ? 'error' : status === 'connected' ? 'success' : 'info', {
                duration: 0,
                persistent: true,
                actions
            });
        }

        // ============================================
        // DATA MODELS AND VALIDATION
        // ============================================

        /**
         * Contact Data Model
         * Represents a business contact with validation and data integrity
         */
        class Contact {
            constructor(data = {}) {
                this.id = data.id || this.generateId();
                this.projectId = data.projectId || 'default';
                this.type = data.type || 'Individual';
                this.name = data.name || '';
                this.title = data.title || '';
                this.company = data.company || '';
                this.industry = data.industry || '';
                this.email = data.email || '';
                this.linkedin = data.linkedin || '';
                this.phone = data.phone || '';
                this.status = data.status || 'New';
                this.priority = data.priority || 'None';
                this.assignee = data.assignee || '';
                this.nextFollowUp = data.nextFollowUp || null;
                this.notes = data.notes || '';
                this.score = data.score || 0;
                this.scoreBreakdown = data.scoreBreakdown || {};
                this.manualScore = data.manualScore || null; // Manual score override
                this.tags = data.tags || [];
                this.dateAdded = data.dateAdded || new Date().toISOString();
                this.lastModified = data.lastModified || new Date().toISOString();
                this.lastContacted = data.lastContacted || null;
                this.assignmentHistory = Array.isArray(data.assignmentHistory) ? data.assignmentHistory : [];

                // Validate and sanitize data
                this.validate();
                this.sanitize();
            }

            generateId() {
                return 'contact_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            validate() {
                const errors = [];

                // Required field validation
                if (!this.name || this.name.trim().length === 0) {
                    errors.push('Name is required');
                }

                if (!this.email || this.email.trim().length === 0) {
                    errors.push('Email is required');
                }

                // Email format validation
                if (this.email && !this.isValidEmail(this.email)) {
                    errors.push('Email format is invalid');
                }

                // LinkedIn URL validation
                if (this.linkedin && !this.isValidLinkedInUrl(this.linkedin)) {
                    errors.push('LinkedIn URL format is invalid');
                }

                // Phone number validation
                if (this.phone && !this.isValidPhone(this.phone)) {
                    errors.push('Phone number format is invalid');
                }

                // Enum validation
                if (!CONFIG.CONTACT_STATUSES.includes(this.status)) {
                    errors.push('Invalid status value');
                }

                if (!CONFIG.PRIORITY_LEVELS.includes(this.priority)) {
                    errors.push('Invalid priority value');
                }

                if (!['Individual', 'Company'].includes(this.type)) {
                    errors.push('Invalid contact type');
                }

                // Team member validation
                if (this.assignee && !CONFIG.TEAM_MEMBERS.includes(this.assignee)) {
                    errors.push('Invalid assignee');
                }

                // Date validation
                if (this.nextFollowUp && !this.isValidDate(this.nextFollowUp)) {
                    errors.push('Invalid follow-up date');
                }

                if (errors.length > 0) {
                    throw new ValidationError('Contact validation failed', errors);
                }

                return true;
            }

            sanitize() {
                // Trim whitespace from string fields
                this.name = this.sanitizeString(this.name);
                this.title = this.sanitizeString(this.title);
                this.company = this.sanitizeString(this.company);
                this.industry = this.sanitizeString(this.industry);
                this.email = this.sanitizeEmail(this.email);
                this.linkedin = this.sanitizeUrl(this.linkedin);
                this.phone = this.sanitizePhone(this.phone);
                this.notes = this.sanitizeString(this.notes);
                this.assignee = this.sanitizeString(this.assignee);

                // Ensure arrays are properly formatted
                if (!Array.isArray(this.tags)) {
                    this.tags = [];
                }

                // Update last modified timestamp
                this.lastModified = new Date().toISOString();
            }

            sanitizeString(str) {
                if (typeof str !== 'string') return '';
                return str.trim().replace(/\s+/g, ' ');
            }

            sanitizeEmail(email) {
                if (typeof email !== 'string') return '';
                return email.trim().toLowerCase();
            }

            sanitizeUrl(url) {
                if (typeof url !== 'string') return '';
                url = url.trim();
                if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                return url;
            }

            sanitizePhone(phone) {
                if (typeof phone !== 'string') return '';
                // Remove all non-digit characters except + and spaces
                return phone.trim().replace(/[^\d\s\+\-\(\)]/g, '');
            }

            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            isValidLinkedInUrl(url) {
                if (!url) return true; // Optional field
                const linkedinRegex = /^https?:\/\/(www\.)?linkedin\.com\/(in|company)\/[a-zA-Z0-9\-]+\/?$/;
                return linkedinRegex.test(url);
            }

            isValidPhone(phone) {
                if (!phone) return true; // Optional field
                // Basic phone validation - at least 7 digits
                const phoneRegex = /[\d\s\+\-\(\)]{7,}/;
                return phoneRegex.test(phone);
            }

            isValidDate(dateString) {
                if (!dateString) return true; // Optional field
                const date = new Date(dateString);
                return date instanceof Date && !isNaN(date);
            }

            toJSON() {
                return {
                    id: this.id,
                    projectId: this.projectId,
                    type: this.type,
                    name: this.name,
                    title: this.title,
                    company: this.company,
                    industry: this.industry,
                    email: this.email,
                    linkedin: this.linkedin,
                    phone: this.phone,
                    status: this.status,
                    priority: this.priority,
                    assignee: this.assignee,
                    nextFollowUp: this.nextFollowUp,
                    notes: this.notes,
                    score: this.score,
                    scoreBreakdown: this.scoreBreakdown,
                    tags: this.tags,
                    dateAdded: this.dateAdded,
                    lastModified: this.lastModified,
                    lastContacted: this.lastContacted,
                    assignmentHistory: this.assignmentHistory
                };
            }

            /**
             * Track assignment changes
             */
            updateAssignment(newAssignee, user = 'System') {
                const oldAssignee = this.assignee;
                if (oldAssignee !== newAssignee) {
                    this.assignmentHistory.push({
                        id: 'assignment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        fromAssignee: oldAssignee || 'Unassigned',
                        toAssignee: newAssignee || 'Unassigned',
                        changedBy: user,
                        date: new Date().toISOString(),
                        reason: 'Manual assignment change'
                    });
                    this.assignee = newAssignee;
                    this.lastModified = new Date().toISOString();
                }
            }
        }

        /**
         * Activity Data Model
         * Represents an interaction or activity with a contact
         */
        class Activity {
            constructor(data = {}) {
                this.id = data.id || this.generateId();
                this.contactId = data.contactId || '';
                this.type = data.type || 'Note Added';
                this.notes = data.notes || '';
                this.date = data.date || new Date().toISOString();
                this.user = data.user || 'System';
                this.metadata = data.metadata || {};

                // Validate and sanitize data
                this.validate();
                this.sanitize();
            }

            generateId() {
                return 'activity_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            validate() {
                const errors = [];

                // Required field validation
                if (!this.contactId || this.contactId.trim().length === 0) {
                    errors.push('Contact ID is required');
                }

                if (!this.type || this.type.trim().length === 0) {
                    errors.push('Activity type is required');
                }

                // Activity type validation
                if (!CONFIG.ACTIVITY_TYPES.includes(this.type)) {
                    errors.push('Invalid activity type');
                }

                // Date validation
                if (!this.isValidDate(this.date)) {
                    errors.push('Invalid activity date');
                }

                if (errors.length > 0) {
                    throw new ValidationError('Activity validation failed', errors);
                }

                return true;
            }

            sanitize() {
                // Trim whitespace from string fields
                this.contactId = this.sanitizeString(this.contactId);
                this.type = this.sanitizeString(this.type);
                this.notes = this.sanitizeString(this.notes);
                this.user = this.sanitizeString(this.user);

                // Ensure metadata is an object
                if (typeof this.metadata !== 'object' || this.metadata === null) {
                    this.metadata = {};
                }
            }

            sanitizeString(str) {
                if (typeof str !== 'string') return '';
                return str.trim().replace(/\s+/g, ' ');
            }

            isValidDate(dateString) {
                const date = new Date(dateString);
                return date instanceof Date && !isNaN(date);
            }

            toJSON() {
                return {
                    id: this.id,
                    contactId: this.contactId,
                    type: this.type,
                    notes: this.notes,
                    date: this.date,
                    user: this.user,
                    metadata: this.metadata
                };
            }
        }

        /**
         * Custom Validation Error Class
         */
        class ValidationError extends Error {
            constructor(message, errors = []) {
                super(message);
                this.name = 'ValidationError';
                this.errors = errors;
            }
        }

        /**
         * Data Validation Utilities
         */
        class DataValidator {
            static validateContact(data) {
                try {
                    const contact = new Contact(data);
                    return { isValid: true, contact: contact, errors: [] };
                } catch (error) {
                    if (error instanceof ValidationError) {
                        return { isValid: false, contact: null, errors: error.errors };
                    }
                    return { isValid: false, contact: null, errors: [error.message] };
                }
            }

            static validateActivity(data) {
                try {
                    const activity = new Activity(data);
                    return { isValid: true, activity: activity, errors: [] };
                } catch (error) {
                    if (error instanceof ValidationError) {
                        return { isValid: false, activity: null, errors: error.errors };
                    }
                    return { isValid: false, activity: null, errors: [error.message] };
                }
            }

            static sanitizeContactData(data) {
                try {
                    const contact = new Contact(data);
                    return contact.toJSON();
                } catch (error) {
                    console.error('Error sanitizing contact data:', error);
                    return data;
                }
            }

            static sanitizeActivityData(data) {
                try {
                    const activity = new Activity(data);
                    return activity.toJSON();
                } catch (error) {
                    console.error('Error sanitizing activity data:', error);
                    return data;
                }
            }

            static showValidationErrors(errors, fieldPrefix = 'contact-') {
                // Clear previous error states
                document.querySelectorAll('.field-error').forEach(el => el.remove());
                document.querySelectorAll('.border-red-500').forEach(el => {
                    el.classList.remove('border-red-500');
                    el.classList.add('border-gray-300');
                });

                // Show new errors
                errors.forEach(error => {
                    let fieldName = '';
                    if (error.includes('Name')) fieldName = 'name';
                    else if (error.includes('Email')) fieldName = 'email';
                    else if (error.includes('LinkedIn')) fieldName = 'linkedin';
                    else if (error.includes('Phone')) fieldName = 'phone';
                    else if (error.includes('status')) fieldName = 'status';
                    else if (error.includes('priority')) fieldName = 'priority';
                    else if (error.includes('type')) fieldName = 'type';
                    else if (error.includes('assignee')) fieldName = 'assignee';
                    else if (error.includes('follow-up')) fieldName = 'nextFollowUp';

                    if (fieldName) {
                        const field = document.getElementById(fieldPrefix + fieldName);
                        if (field) {
                            field.classList.remove('border-gray-300');
                            field.classList.add('border-red-500');

                            // Add error message
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'field-error text-red-600 text-sm mt-1';
                            errorDiv.textContent = error;
                            field.parentNode.appendChild(errorDiv);
                        }
                    }
                });

                // Show general error notification if there are errors
                if (errors.length > 0) {
                    showNotification('Please fix the validation errors before saving.', 'error');
                }
            }
        }

        // ============================================
        // INTELLIGENT SCORING ENGINE
        // ============================================

        /**
         * Intelligent Scoring Engine for Contact Prioritization
         * Automatically evaluates contacts based on multiple factors according to GSG requirements
         */
        class ScoringEngine {
            constructor() {
                // Configurable scoring weights (Requirements 14.1-14.6)
                this.weights = {
                    title: 40,      // Title seniority weight (0-40 points)
                    industry: 30,   // Industry relevance weight (0-30 points)
                    companyType: 20, // Company type weight (0-20 points)
                    engagement: 10   // Engagement level weight (0-10 points)
                };

                // Title scoring matrix based on seniority
                this.titleScores = {
                    // C-Level and Founders (40 points)
                    'ceo': 40, 'chief executive officer': 40, 'founder': 40, 'co-founder': 40,
                    'president': 40, 'chairman': 40, 'chairwoman': 40, 'owner': 40,

                    // Senior Leadership (30 points)
                    'director': 30, 'vp': 30, 'vice president': 30, 'head of': 30,
                    'general manager': 30, 'managing director': 30, 'executive director': 30,
                    'senior director': 30, 'regional director': 30,

                    // Management Level (20 points)
                    'manager': 20, 'senior manager': 20, 'team lead': 20, 'team leader': 20,
                    'project manager': 20, 'program manager': 20, 'operations manager': 20,
                    'business manager': 20, 'account manager': 20,

                    // Specialist Level (10 points)
                    'specialist': 10, 'coordinator': 10, 'analyst': 10, 'consultant': 10,
                    'associate': 10, 'officer': 10, 'executive': 10, 'representative': 10,

                    // Other/Unknown (5 points)
                    'other': 5
                };

                // Industry scoring matrix based on relevance to GSG
                this.industryScores = {
                    // High Priority Industries (30 points)
                    'sustainability': 30, 'renewable energy': 30, 'clean energy': 30,
                    'green technology': 30, 'environmental': 30, 'climate': 30,
                    'solar': 30, 'wind energy': 30, 'clean tech': 30,

                    // Technology & Finance (25 points)
                    'technology': 25, 'fintech': 25, 'software': 25, 'it': 25,
                    'finance': 25, 'banking': 25, 'investment': 25, 'venture capital': 25,
                    'private equity': 25, 'financial services': 25,

                    // Business Services (20 points)
                    'consulting': 20, 'professional services': 20, 'business services': 20,
                    'management consulting': 20, 'strategy': 20, 'advisory': 20,

                    // Healthcare & Education (15 points)
                    'healthcare': 15, 'medical': 15, 'pharmaceutical': 15, 'biotech': 15,
                    'education': 15, 'training': 15, 'research': 15, 'academic': 15,

                    // Media & Communications (15 points)
                    'media': 15, 'communications': 15, 'marketing': 15, 'advertising': 15,
                    'public relations': 15, 'journalism': 15,

                    // Other Industries (10 points)
                    'other': 10
                };

                // Company type scoring
                this.companyTypeScores = {
                    'Company': 20,      // Established companies
                    'Individual': 10    // Individual contacts
                };

                // Engagement scoring based on contact status
                this.engagementScores = {
                    'Converted': 10,    // Highest engagement
                    'Qualified': 8,     // High engagement
                    'Contacted': 5,     // Medium engagement
                    'New': 2,          // Low engagement
                    'Inactive': 0       // No engagement
                };
            }

            /**
             * Calculate comprehensive contact score (Requirements 14.1, 14.2)
             * @param {Object} contact - Contact object to score
             * @returns {number} - Score between 0-100
             */
            calculateScore(contact) {
                if (!contact) return 0;

                const breakdown = this.getScoreBreakdown(contact);
                const totalScore = Object.values(breakdown).reduce((sum, score) => sum + score, 0);

                // Cap at 100 and ensure minimum of 0
                return Math.min(Math.max(totalScore, 0), 100);
            }

            /**
             * Get detailed score breakdown (Requirements 14.3, 14.6)
             * @param {Object} contact - Contact object to analyze
             * @returns {Object} - Detailed breakdown of scoring factors
             */
            getScoreBreakdown(contact) {
                const breakdown = {
                    title: this.calculateTitleScore(contact.title),
                    industry: this.calculateIndustryScore(contact.industry),
                    companyType: this.calculateCompanyTypeScore(contact.type),
                    engagement: this.calculateEngagementScore(contact.status, contact.lastContacted)
                };

                return breakdown;
            }

            /**
             * Calculate title-based score (Requirements 14.2)
             * @param {string} title - Contact's job title
             * @returns {number} - Title score (0-40 points)
             */
            calculateTitleScore(title) {
                if (!title || typeof title !== 'string') return 5;

                const normalizedTitle = title.toLowerCase().trim();

                // Check for exact matches first
                for (const [key, score] of Object.entries(this.titleScores)) {
                    if (key !== 'other' && normalizedTitle.includes(key)) {
                        return score;
                    }
                }

                // Check for common variations and patterns
                if (normalizedTitle.includes('c.e.o') || normalizedTitle.includes('chief')) {
                    return 40;
                }

                if (normalizedTitle.includes('senior') && normalizedTitle.includes('director')) {
                    return 30;
                }

                if (normalizedTitle.includes('senior') && normalizedTitle.includes('manager')) {
                    return 25;
                }

                // Default score for unrecognized titles
                return this.titleScores.other;
            }

            /**
             * Calculate industry-based score (Requirements 14.3)
             * @param {string} industry - Contact's industry
             * @returns {number} - Industry score (0-30 points)
             */
            calculateIndustryScore(industry) {
                if (!industry || typeof industry !== 'string') return 10;

                const normalizedIndustry = industry.toLowerCase().trim();

                // Check for exact matches and partial matches
                for (const [key, score] of Object.entries(this.industryScores)) {
                    if (key !== 'other' && normalizedIndustry.includes(key)) {
                        return score;
                    }
                }

                // Check for additional sustainability-related keywords
                const sustainabilityKeywords = ['green', 'eco', 'carbon', 'emission', 'renewable', 'clean'];
                if (sustainabilityKeywords.some(keyword => normalizedIndustry.includes(keyword))) {
                    return 30;
                }

                // Check for technology-related keywords
                const techKeywords = ['tech', 'digital', 'software', 'platform', 'app', 'data'];
                if (techKeywords.some(keyword => normalizedIndustry.includes(keyword))) {
                    return 25;
                }

                // Default score for unrecognized industries
                return this.industryScores.other;
            }

            /**
             * Calculate company type score (Requirements 14.4)
             * @param {string} type - Contact type (Individual/Company)
             * @returns {number} - Company type score (0-20 points)
             */
            calculateCompanyTypeScore(type) {
                return this.companyTypeScores[type] || this.companyTypeScores['Individual'];
            }

            /**
             * Calculate engagement score based on status and activity (Requirements 14.5)
             * @param {string} status - Contact status
             * @param {string} lastContacted - Last contact date
             * @returns {number} - Engagement score (0-10 points)
             */
            calculateEngagementScore(status, lastContacted) {
                let baseScore = this.engagementScores[status] || this.engagementScores['New'];

                // Bonus for recent activity
                if (lastContacted) {
                    const lastContactDate = new Date(lastContacted);
                    const daysSinceContact = (new Date() - lastContactDate) / (1000 * 60 * 60 * 24);

                    // Bonus for recent contact (within 30 days)
                    if (daysSinceContact <= 30) {
                        baseScore = Math.min(baseScore + 2, 10);
                    }
                }

                return baseScore;
            }

            /**
             * Update scoring weights (Requirements 14.6)
             * @param {Object} newWeights - New weight configuration
             */
            updateWeights(newWeights) {
                this.weights = { ...this.weights, ...newWeights };
            }

            /**
             * Get current scoring configuration
             * @returns {Object} - Current weights and scoring matrices
             */
            getConfiguration() {
                return {
                    weights: this.weights,
                    titleScores: this.titleScores,
                    industryScores: this.industryScores,
                    companyTypeScores: this.companyTypeScores,
                    engagementScores: this.engagementScores
                };
            }

            /**
             * Recalculate scores for all contacts (Requirements 14.1)
             * @param {Array} contacts - Array of contact objects
             * @returns {Array} - Contacts with updated scores
             */
            recalculateAllScores(contacts) {
                if (!Array.isArray(contacts)) return [];

                return contacts.map(contact => {
                    const score = this.calculateScore(contact);
                    const scoreBreakdown = this.getScoreBreakdown(contact);

                    return {
                        ...contact,
                        score: score,
                        scoreBreakdown: scoreBreakdown
                    };
                });
            }

            /**
             * Get score display information for UI
             * @param {number} score - Contact score
             * @returns {Object} - Display information including color and label
             */
            getScoreDisplayInfo(score) {
                if (score >= 80) {
                    return {
                        color: 'text-green-600',
                        bgColor: 'bg-green-100',
                        label: 'High Priority',
                        barColor: 'bg-green-500'
                    };
                } else if (score >= 60) {
                    return {
                        color: 'text-yellow-600',
                        bgColor: 'bg-yellow-100',
                        label: 'Medium Priority',
                        barColor: 'bg-yellow-500'
                    };
                } else if (score >= 40) {
                    return {
                        color: 'text-blue-600',
                        bgColor: 'bg-blue-100',
                        label: 'Low Priority',
                        barColor: 'bg-blue-500'
                    };
                } else {
                    return {
                        color: 'text-gray-600',
                        bgColor: 'bg-gray-100',
                        label: 'Very Low',
                        barColor: 'bg-gray-500'
                    };
                }
            }
        }

        // Initialize global scoring engine instance
        const scoringEngine = new ScoringEngine();

        /**
         * Legacy function for backward compatibility
         * @param {Object} contact - Contact object
         * @returns {number} - Calculated score
         */
        function calculateContactScore(contact) {
            return scoringEngine.calculateScore(contact);
        }

        /**
         * Legacy function for backward compatibility
         * @param {Object} contact - Contact object
         * @returns {Object} - Score breakdown
         */
        function getScoreBreakdown(contact) {
            return scoringEngine.getScoreBreakdown(contact);
        }

    </script>
</body>

</html>
            // Modal controls
            document.getElementById('add-contact-btn').addEventListener('click', openAddContactModal);
            document.getElementById('cancel-modal').addEventListener('click', closeContactModal);
            document.getElementById('close-setup-modal').addEventListener('click', hideSetupModal);
            document.getElementById('test-connection-btn').addEventListener('click', testConnection);
            document.getElementById('process-queue-btn').addEventListener('click', processOfflineQueue);
            document.getElementById('clear-queue-btn').addEventListener('click', clearOfflineQueue);
            document.getElementById('backup-data-btn').addEventListener('click', createDataBackup);
            document.getElementById('clear-storage-btn').addEventListener('click', clearLocalStorage);

            // Form submission - prevent default form submission since we use button click
            document.getElementById('contact-form').addEventListener('submit', (e) => {
                e.preventDefault();
                saveContact();
            });

            // Real-time form validation
            setupFormValidation();

            // Search and filters
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.getElementById('status-filter').addEventListener('change', handleFilter);
            document.getElementById('assignee-filter').addEventListener('change', handleFilter);
            document.getElementById('priority-filter').addEventListener('change', handleFilter);
            
            // Advanced search fields
            const advancedSearchFields = ['search-name', 'search-company', 'search-title', 'search-email', 'search-industry', 'search-notes'];
            advancedSearchFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', handleSearch);
                }
            });
            
            // Search logic radio buttons
            document.querySelectorAll('input[name="search-logic"]').forEach(radio => {
                radio.addEventListener('change', handleFilter);
            });
            
            // Advanced filter fields
            const advancedFilterFields = [
                'type-filter', 'industry-filter', 'score-filter', 'date-added-from', 'date-added-to',
                'last-contacted-from', 'last-contacted-to', 'followup-filter', 'linkedin-filter',
                'phone-filter', 'score-min', 'score-max'
            ];
            advancedFilterFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', handleFilter);
                    if (field.type === 'number' || field.type === 'date') {
                        field.addEventListener('input', handleFilter);
                    }
                }
            });
            
            // Save search modal controls
            document.getElementById('confirm-save-search-btn').addEventListener('click', saveSearchPreset);
            document.getElementById('cancel-save-search-btn').addEventListener('click', () => {
                document.getElementById('save-search-modal').classList.add('hidden');
            });
            
            // Close saved searches dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('saved-searches-dropdown');
                const button = document.getElementById('saved-searches-btn');
                if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Select all checkbox
            document.getElementById('select-all').addEventListener('change', handleSelectAll);

            // Sync button
            document.getElementById('sync-btn').addEventListener('click', async () => {
                try {
                    await loadContacts();
                    showNotification('Data synchronized successfully!', 'success');
                } catch (error) {
                    showNotification('Sync failed: ' + error.message, 'error');
                }
            });

            // Close modals when clicking outside
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeContactModal();
                    hideSetupModal();
                }
            });
        }

        function setupFormValidation() {
            // Real-time validation for contact form fields
            const formFields = [
                { id: 'contact-name', validator: 'validateName' },
                { id: 'contact-email', validator: 'validateEmail' },
                { id: 'contact-linkedin', validator: 'validateLinkedIn' },
                { id: 'contact-phone', validator: 'validatePhone' }
            ];

            formFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    // Validate on blur (when user leaves the field)
                    element.addEventListener('blur', (e) => {
                        validateField(e.target, field.validator);
                    });

                    // Clear validation errors on input
                    element.addEventListener('input', (e) => {
                        clearFieldError(e.target);
                    });
                }
            });
        }

        function validateField(field, validatorType) {
            const value = field.value.trim();
            let isValid = true;
            let errorMessage = '';

            // Clear previous errors
            clearFieldError(field);

            // Skip validation for empty optional fields
            if (!value && !field.required) {
                return true;
            }

            switch (validatorType) {
                case 'validateName':
                    if (!value) {
                        isValid = false;
                        errorMessage = 'Name is required';
                    }
                    break;

                case 'validateEmail':
                    if (!value) {
                        isValid = false;
                        errorMessage = 'Email is required';
                    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                        isValid = false;
                        errorMessage = 'Please enter a valid email address';
                    }
                    break;

                case 'validateLinkedIn':
                    if (value && !/^https?:\/\/(www\.)?linkedin\.com\/(in|company)\/[a-zA-Z0-9\-]+\/?$/.test(value)) {
                        isValid = false;
                        errorMessage = 'Please enter a valid LinkedIn URL';
                    }
                    break;

                case 'validatePhone':
                    if (value && !/[\d\s\+\-\(\)]{7,}/.test(value)) {
                        isValid = false;
                        errorMessage = 'Please enter a valid phone number';
                    }
                    break;
            }

            if (!isValid) {
                showFieldError(field, errorMessage);
            }

            return isValid;
        }

        function showFieldError(field, message) {
            // Remove existing error
            clearFieldError(field);

            // Add error styling
            field.classList.remove('border-gray-300');
            field.classList.add('border-red-500');

            // Add error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'field-error text-red-600 text-sm mt-1';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
        }

        function clearFieldError(field) {
            // Remove error styling
            field.classList.remove('border-red-500');
            field.classList.add('border-gray-300');

            // Remove error message
            const existingError = field.parentNode.querySelector('.field-error');
            if (existingError) {
                existingError.remove();
            }
        }

        // ============================================
        // ACTIVITY TRACKING FUNCTIONS
        // Requirements: 5.1, 5.2, 5.3, 5.4, 5.5
        // ============================================

        /**
         * Switch between contact tabs (details/activities)
         */
        function switchContactTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.contact-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`contact-${tabName}-tab`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.contact-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`contact-${tabName}-content`).classList.remove('hidden');

            // Load activities if switching to activities tab and in edit mode
            if (tabName === 'activities' && isEditMode && currentEditId) {
                loadContactActivities(currentEditId);
            }
        }

        /**
         * Add new activity to current contact
         * Requirements: 5.2, 5.4, 5.5
         */
        function addActivity() {
            if (!isEditMode || !currentEditId) {
                showNotification('Please save the contact first before adding activities', 'warning');
                return;
            }

            const form = document.getElementById('activity-form');
            const formData = new FormData(form);
            const activityData = Object.fromEntries(formData.entries());

            try {
                // Create activity
                const activity = new Activity({
                    ...activityData,
                    contactId: currentEditId,
                    date: activityData.date || new Date().toISOString()
                });

                activity.validate();

                // Add to activities array
                activities.push(activity.toJSON());

                // Update contact's last contacted date
                updateContactLastContacted(currentEditId, activity.date);

                // Save to local storage
                saveActivitiesToLocalStorage();
                saveContactsToLocalStorage();

                // Refresh activity timeline
                loadContactActivities(currentEditId);

                // Clear form
                form.reset();
                document.getElementById('activity-date').value = new Date().toISOString().slice(0, 16);

                showNotification('Activity added successfully!', 'success');

            } catch (error) {
                console.error('Error adding activity:', error);
                if (error instanceof ValidationError) {
                    showNotification('Validation failed: ' + error.errors.join(', '), 'error');
                } else {
                    showNotification('Failed to add activity: ' + error.message, 'error');
                }
            }
        }

        /**
         * Load activities for a specific contact
         * Requirements: 5.1, 5.3
         */
        function loadContactActivities(contactId) {
            const contactActivities = activities
                .filter(activity => activity.contactId === contactId)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Most recent first

            renderActivityTimeline(contactActivities);
            updateActivityCount(contactActivities.length);
        }

        /**
         * Render activity timeline
         * Requirements: 5.1, 5.3
         */
        function renderActivityTimeline(contactActivities) {
            const timeline = document.getElementById('activity-timeline');

            if (contactActivities.length === 0) {
                timeline.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="mt-2 text-sm">No activities recorded yet</p>
                        <p class="text-xs text-gray-400">Activities will appear here once you add them</p>
                    </div>
                `;
                return;
            }

            timeline.innerHTML = contactActivities.map(activity => `
                <div class="activity-item activity-type-${activity.type.toLowerCase().replace(/\s+/g, '')} bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getActivityTypeClass(activity.type)}">
                                    ${getActivityTypeIcon(activity.type)}
                                    ${activity.type}
                                </span>
                                <span class="text-xs text-gray-500">
                                    ${formatActivityDate(activity.date)}
                                </span>
                            </div>
                            ${activity.notes ? `
                                <p class="mt-2 text-sm text-gray-700">${escapeHtml(activity.notes)}</p>
                            ` : ''}
                            <div class="mt-2 text-xs text-gray-400">
                                by ${activity.user}
                            </div>
                        </div>
                        <button onclick="deleteActivity('${activity.id}')" class="text-red-400 hover:text-red-600 ml-2" title="Delete activity">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Update contact's last contacted date
         * Requirements: 5.5
         */
        function updateContactLastContacted(contactId, activityDate) {
            const contactIndex = contacts.findIndex(c => c.id === contactId);
            if (contactIndex !== -1) {
                const currentLastContacted = contacts[contactIndex].lastContacted;
                const newDate = new Date(activityDate);

                // Only update if this activity is more recent
                if (!currentLastContacted || new Date(currentLastContacted) < newDate) {
                    contacts[contactIndex].lastContacted = activityDate;
                    contacts[contactIndex].lastModified = new Date().toISOString();
                }
            }
        }

        /**
         * Delete activity
         */
        function deleteActivity(activityId) {
            if (!confirm('Are you sure you want to delete this activity?')) {
                return;
            }

            try {
                // Remove from activities array
                activities = activities.filter(a => a.id !== activityId);

                // Save to local storage
                saveActivitiesToLocalStorage();

                // Refresh timeline
                if (isEditMode && currentEditId) {
                    loadContactActivities(currentEditId);
                }

                showNotification('Activity deleted successfully!', 'success');

            } catch (error) {
                console.error('Error deleting activity:', error);
                showNotification('Failed to delete activity: ' + error.message, 'error');
            }
        }

        /**
         * Update activity count badge
         */
        function updateActivityCount(count) {
            const badge = document.getElementById('activity-count-badge');
            if (badge) {
                badge.textContent = count;
            }
        }

        /**
         * Get CSS class for activity type
         */
        function getActivityTypeClass(type) {
            const typeMap = {
                'Email Sent': 'bg-green-100 text-green-800',
                'Phone Call': 'bg-yellow-100 text-yellow-800',
                'Meeting Scheduled': 'bg-purple-100 text-purple-800',
                'Follow-up': 'bg-red-100 text-red-800',
                'Note Added': 'bg-gray-100 text-gray-800'
            };
            return typeMap[type] || 'bg-gray-100 text-gray-800';
        }

        /**
         * Get icon for activity type
         */
        function getActivityTypeIcon(type) {
            const iconMap = {
                'Email Sent': '📧',
                'Phone Call': '📞',
                'Meeting Scheduled': '📅',
                'Follow-up': '🔄',
                'Note Added': '📝'
            };
            return iconMap[type] || '📝';
        }

        /**
         * Format activity date for display
         */
        function formatActivityDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
                return 'Today at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 2) {
                return 'Yesterday at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays <= 7) {
                return date.toLocaleDateString([], { weekday: 'long' }) + ' at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Enhanced save activities to local storage with integrity checks
         * Requirements: 13.4, 13.5
         */
        function saveActivitiesToLocalStorage() {
            try {
                const success = localStorageManager.saveData(localStorageManager.storageKeys.activities, activities);
                if (success) {
                    updateLocalStorageStatus();
                    console.log('Activities saved to local storage successfully');
                } else {
                    throw new Error('Failed to save activities');
                }
            } catch (error) {
                console.error('Error saving activities to local storage:', error);
                showNotification('Failed to save activities locally. Storage may be full.', 'error');
            }
        }

        /**
         * Enhanced load activities from local storage with integrity checks
         * Requirements: 13.4, 13.5
         */
        function loadActivitiesFromLocalStorage() {
            try {
                const storedActivities = localStorageManager.loadData(localStorageManager.storageKeys.activities);
                if (storedActivities && Array.isArray(storedActivities)) {
                    activities = storedActivities;
                    console.log('Loaded', activities.length, 'activities from local storage');
                } else {
                    activities = [];
                    console.log('No activities found in local storage, starting with empty array');
                }
                updateLocalStorageStatus();
            } catch (error) {
                console.error('Error loading activities from local storage:', error);
                activities = [];
                showNotification('Failed to load activities from local storage.', 'warning');
            }
        }

        /**
         * Enhanced local storage system with data integrity checks
         * Requirements: 13.4, 13.5
         */
        class LocalStorageManager {
            constructor() {
                this.storageKeys = {
                    contacts: 'gsg_contacts',
                    activities: 'gsg_activities',
                    queue: 'gsg_offline_queue',
                    config: 'gsg_config',
                    lastSync: 'gsg_last_sync',
                    metadata: 'gsg_metadata'
                };
                this.maxStorageSize = 5 * 1024 * 1024; // 5MB limit
            }

            /**
             * Save data with compression and integrity checks
             */
            saveData(key, data) {
                try {
                    const serialized = JSON.stringify(data);
                    const compressed = this.compressData(serialized);
                    
                    // Check storage size
                    if (this.getStorageSize() + compressed.length > this.maxStorageSize) {
                        this.cleanupOldData();
                    }

                    localStorage.setItem(key, compressed);
                    this.updateMetadata(key, {
                        size: compressed.length,
                        timestamp: new Date().toISOString(),
                        checksum: this.calculateChecksum(serialized)
                    });

                    return true;
                } catch (error) {
                    console.error('Failed to save data to local storage:', error);
                    this.handleStorageError(error);
                    return false;
                }
            }

            /**
             * Load data with integrity verification
             */
            loadData(key) {
                try {
                    const compressed = localStorage.getItem(key);
                    if (!compressed) return null;

                    const decompressed = this.decompressData(compressed);
                    const data = JSON.parse(decompressed);

                    // Verify data integrity
                    const metadata = this.getMetadata(key);
                    if (metadata && metadata.checksum) {
                        const currentChecksum = this.calculateChecksum(decompressed);
                        if (currentChecksum !== metadata.checksum) {
                            console.warn('Data integrity check failed for:', key);
                            this.handleCorruptedData(key);
                        }
                    }

                    return data;
                } catch (error) {
                    console.error('Failed to load data from local storage:', error);
                    this.handleCorruptedData(key);
                    return null;
                }
            }

            /**
             * Simple compression using string manipulation
             */
            compressData(data) {
                // Basic compression - remove extra whitespace and use shorter keys
                return data.replace(/\s+/g, ' ').trim();
            }

            /**
             * Decompress data
             */
            decompressData(data) {
                return data; // For basic implementation, no actual decompression needed
            }

            /**
             * Calculate simple checksum for data integrity
             */
            calculateChecksum(data) {
                let hash = 0;
                for (let i = 0; i < data.length; i++) {
                    const char = data.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return hash.toString();
            }

            /**
             * Get current storage usage
             */
            getStorageSize() {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length;
                    }
                }
                return total;
            }

            /**
             * Clean up old data when storage is full
             */
            cleanupOldData() {
                try {
                    // Remove old queue items first
                    const queue = this.loadData(this.storageKeys.queue) || [];
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - 7); // Keep only last 7 days

                    const filteredQueue = queue.filter(item => 
                        new Date(item.timestamp) > cutoffDate
                    );

                    if (filteredQueue.length < queue.length) {
                        this.saveData(this.storageKeys.queue, filteredQueue);
                        console.log('Cleaned up old queue items');
                    }

                    // If still not enough space, show warning
                    if (this.getStorageSize() > this.maxStorageSize * 0.9) {
                        showNotification('Local storage is nearly full. Some old data may be lost.', 'warning');
                    }
                } catch (error) {
                    console.error('Failed to cleanup old data:', error);
                }
            }

            /**
             * Handle storage errors
             */
            handleStorageError(error) {
                if (error.name === 'QuotaExceededError') {
                    showNotification('Local storage is full. Please clear some data or sync to server.', 'error');
                    this.cleanupOldData();
                } else {
                    showNotification('Failed to save data locally. Changes may be lost.', 'error');
                }
            }

            /**
             * Handle corrupted data
             */
            handleCorruptedData(key) {
                console.warn('Corrupted data detected for key:', key);
                localStorage.removeItem(key);
                this.removeMetadata(key);
                showNotification('Corrupted local data detected and removed. Please sync from server.', 'warning');
            }

            /**
             * Update metadata for stored data
             */
            updateMetadata(key, metadata) {
                try {
                    const allMetadata = JSON.parse(localStorage.getItem(this.storageKeys.metadata) || '{}');
                    allMetadata[key] = metadata;
                    localStorage.setItem(this.storageKeys.metadata, JSON.stringify(allMetadata));
                } catch (error) {
                    console.error('Failed to update metadata:', error);
                }
            }

            /**
             * Get metadata for stored data
             */
            getMetadata(key) {
                try {
                    const allMetadata = JSON.parse(localStorage.getItem(this.storageKeys.metadata) || '{}');
                    return allMetadata[key];
                } catch (error) {
                    console.error('Failed to get metadata:', error);
                    return null;
                }
            }

            /**
             * Remove metadata for a key
             */
            removeMetadata(key) {
                try {
                    const allMetadata = JSON.parse(localStorage.getItem(this.storageKeys.metadata) || '{}');
                    delete allMetadata[key];
                    localStorage.setItem(this.storageKeys.metadata, JSON.stringify(allMetadata));
                } catch (error) {
                    console.error('Failed to remove metadata:', error);
                }
            }

            /**
             * Get storage statistics
             */
            getStorageStats() {
                const stats = {
                    totalSize: this.getStorageSize(),
                    maxSize: this.maxStorageSize,
                    usagePercent: (this.getStorageSize() / this.maxStorageSize) * 100,
                    keys: {}
                };

                for (const [name, key] of Object.entries(this.storageKeys)) {
                    const data = localStorage.getItem(key);
                    const metadata = this.getMetadata(key);
                    stats.keys[name] = {
                        size: data ? data.length : 0,
                        lastUpdated: metadata ? metadata.timestamp : null,
                        exists: !!data
                    };
                }

                return stats;
            }

            /**
             * Clear all application data
             */
            clearAllData() {
                for (const key of Object.values(this.storageKeys)) {
                    localStorage.removeItem(key);
                }
                showNotification('All local data cleared.', 'info');
            }

            /**
             * Export all data for backup
             */
            exportData() {
                const exportData = {};
                for (const [name, key] of Object.entries(this.storageKeys)) {
                    const data = this.loadData(key);
                    if (data) {
                        exportData[name] = data;
                    }
                }
                exportData.exportDate = new Date().toISOString();
                return exportData;
            }

            /**
             * Import data from backup
             */
            importData(importData) {
                try {
                    for (const [name, key] of Object.entries(this.storageKeys)) {
                        if (importData[name]) {
                            this.saveData(key, importData[name]);
                        }
                    }
                    showNotification('Data imported successfully.', 'success');
                    return true;
                } catch (error) {
                    console.error('Failed to import data:', error);
                    showNotification('Failed to import data.', 'error');
                    return false;
                }
            }
        }

        // Initialize local storage manager
        const localStorageManager = new LocalStorageManager();

        /**
         * Update local storage status indicators
         * Requirements: 13.4, 13.5
         */
        function updateLocalStorageStatus() {
            try {
                const stats = localStorageManager.getStorageStats();
                
                // Update storage usage indicator if it exists
                const storageIndicator = document.getElementById('storage-usage-indicator');
                if (storageIndicator) {
                    const usagePercent = Math.round(stats.usagePercent);
                    storageIndicator.textContent = `Storage: ${usagePercent}%`;
                    
                    // Color code based on usage
                    if (usagePercent > 90) {
                        storageIndicator.className = 'text-xs text-red-600';
                    } else if (usagePercent > 75) {
                        storageIndicator.className = 'text-xs text-yellow-600';
                    } else {
                        storageIndicator.className = 'text-xs text-green-600';
                    }
                }

                // Show warning if storage is getting full
                if (stats.usagePercent > 90) {
                    showNotification('Local storage is nearly full. Consider syncing to server or clearing old data.', 'warning');
                }

                console.log('Local storage stats:', stats);
            } catch (error) {
                console.error('Failed to update local storage status:', error);
            }
        }

        /**
         * Enhanced automatic sync when connection is restored
         * Requirements: 3.5, 13.5
         */
        async function autoSyncOnReconnect() {
            try {
                // Check if we have pending changes
                const queueStatus = offlineQueue.getQueueStatus();
                if (queueStatus.count === 0) {
                    console.log('No pending changes to sync');
                    return;
                }

                console.log('Auto-syncing', queueStatus.count, 'pending changes...');
                
                // Show progress notification
                const progressId = showLoadingNotification('Auto-syncing offline changes...', { persistent: true });
                
                // Process the queue
                await offlineQueue.processQueue();
                
                // Update UI
                dismissNotification(progressId);
                showNotification('All offline changes synced successfully!', 'success');
                
                // Refresh data to ensure consistency
                await loadContacts();
                
            } catch (error) {
                console.error('Auto-sync failed:', error);
                showNotification('Auto-sync failed. Please try manual sync.', 'warning');
            }
        }

        /**
         * Backup local data before major operations
         * Requirements: 13.4
         */
        function backupLocalData() {
            try {
                const backup = localStorageManager.exportData();
                const backupKey = `gsg_backup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(backup));
                
                // Keep only the last 3 backups
                const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('gsg_backup_'));
                if (backupKeys.length > 3) {
                    backupKeys.sort().slice(0, -3).forEach(key => {
                        localStorage.removeItem(key);
                    });
                }
                
                console.log('Local data backed up successfully');
                return backupKey;
            } catch (error) {
                console.error('Failed to backup local data:', error);
                return null;
            }
        }

        /**
         * Restore local data from backup
         * Requirements: 13.4
         */
        function restoreLocalData(backupKey) {
            try {
                const backupData = localStorage.getItem(backupKey);
                if (!backupData) {
                    throw new Error('Backup not found');
                }

                const backup = JSON.parse(backupData);
                const success = localStorageManager.importData(backup);
                
                if (success) {
                    // Reload data
                    loadContactsFromLocalStorage();
                    loadActivitiesFromLocalStorage();
                    applyFilters();
                    updateDashboardStats();
                    
                    showNotification('Data restored from backup successfully!', 'success');
                } else {
                    throw new Error('Failed to import backup data');
                }
            } catch (error) {
                console.error('Failed to restore from backup:', error);
                showNotification('Failed to restore from backup: ' + error.message, 'error');
            }
        }

        // ============================================
        // MOBILE INTERFACE FUNCTIONS
        // ============================================

        /**
         * Toggle mobile menu
         */
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        }

        /**
         * Toggle mobile filters
         */
        function toggleMobileFilters() {
            const filtersContent = document.getElementById('mobile-filters-content');
            const chevron = document.getElementById('mobile-filters-chevron');
            
            filtersContent.classList.toggle('active');
            chevron.classList.toggle('rotate-180');
            
            // Sync mobile filters with desktop filters
            if (filtersContent.classList.contains('active')) {
                syncMobileFilters();
            }
        }

        /**
         * Sync mobile filters with desktop filters
         */
        function syncMobileFilters() {
            const mobileSearch = document.getElementById('mobile-search-input');
            const desktopSearch = document.getElementById('search-input');
            
            const mobileStatus = document.getElementById('mobile-status-filter');
            const desktopStatus = document.getElementById('status-filter');
            
            const mobileAssignee = document.getElementById('mobile-assignee-filter');
            const desktopAssignee = document.getElementById('assignee-filter');
            
            const mobilePriority = document.getElementById('mobile-priority-filter');
            const desktopPriority = document.getElementById('priority-filter');
            
            // Sync values
            mobileSearch.value = desktopSearch.value;
            mobileStatus.value = desktopStatus.value;
            mobileAssignee.value = desktopAssignee.value;
            mobilePriority.value = desktopPriority.value;
            
            // Populate mobile filter options
            mobileStatus.innerHTML = desktopStatus.innerHTML;
            mobileAssignee.innerHTML = desktopAssignee.innerHTML;
            mobilePriority.innerHTML = desktopPriority.innerHTML;
            
            // Add event listeners for mobile filters
            mobileSearch.addEventListener('input', function() {
                desktopSearch.value = this.value;
                applyFilters();
            });
            
            mobileStatus.addEventListener('change', function() {
                desktopStatus.value = this.value;
                applyFilters();
            });
            
            mobileAssignee.addEventListener('change', function() {
                desktopAssignee.value = this.value;
                applyFilters();
            });
            
            mobilePriority.addEventListener('change', function() {
                desktopPriority.value = this.value;
                applyFilters();
            });
        }

        /**
         * Clear mobile selection
         */
        function clearMobileSelection() {
            selectedContacts.clear();
            updateMobileBulkActions();
            updateCheckboxStates();
        }

        /**
         * Apply mobile bulk updates
         */
        function applyMobileBulkUpdates() {
            const status = document.getElementById('mobile-bulk-status').value;
            const assignee = document.getElementById('mobile-bulk-assignee').value;
            const priority = document.getElementById('mobile-bulk-priority').value;
            
            // Sync with desktop bulk actions
            if (status) document.getElementById('bulk-status-update').value = status;
            if (assignee) document.getElementById('bulk-assignee-update').value = assignee;
            if (priority) document.getElementById('bulk-priority-update').value = priority;
            
            // Apply the updates
            applyBulkUpdates();
        }

        /**
         * Update mobile bulk actions visibility
         */
        function updateMobileBulkActions() {
            const selectedCount = selectedContacts.size;
            const mobileBulkActions = document.getElementById('mobile-bulk-actions');
            const mobileSelectedCount = document.getElementById('mobile-selected-count');
            
            if (selectedCount > 0) {
                mobileBulkActions.classList.add('active');
                mobileSelectedCount.textContent = `${selectedCount} contact${selectedCount > 1 ? 's' : ''} selected`;
                
                // Populate mobile bulk action dropdowns
                const mobileBulkAssignee = document.getElementById('mobile-bulk-assignee');
                const desktopBulkAssignee = document.getElementById('bulk-assignee-update');
                mobileBulkAssignee.innerHTML = desktopBulkAssignee.innerHTML;
            } else {
                mobileBulkActions.classList.remove('active');
            }
        }

        /**
         * Update mobile pagination controls
         */
        function updateMobilePaginationControls() {
            const mobileCurrentPage = document.getElementById('mobile-current-page');
            const mobileTotalPages = document.getElementById('mobile-total-pages');
            const mobileShowingStart = document.getElementById('mobile-showing-start');
            const mobileShowingEnd = document.getElementById('mobile-showing-end');
            const mobileTotalContacts = document.getElementById('mobile-total-contacts-count');
            const mobilePrevBtn = document.getElementById('mobile-prev-page');
            const mobileNextBtn = document.getElementById('mobile-next-page');
            
            if (mobileCurrentPage) mobileCurrentPage.textContent = currentPage;
            if (mobileTotalPages) mobileTotalPages.textContent = totalPages;
            
            const startItem = filteredContacts.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
            const endItem = Math.min(currentPage * itemsPerPage, filteredContacts.length);
            
            if (mobileShowingStart) mobileShowingStart.textContent = startItem;
            if (mobileShowingEnd) mobileShowingEnd.textContent = endItem;
            if (mobileTotalContacts) mobileTotalContacts.textContent = filteredContacts.length;
            
            // Update button states
            if (mobilePrevBtn) {
                mobilePrevBtn.disabled = currentPage <= 1;
                mobilePrevBtn.classList.toggle('opacity-50', currentPage <= 1);
            }
            
            if (mobileNextBtn) {
                mobileNextBtn.disabled = currentPage >= totalPages;
                mobileNextBtn.classList.toggle('opacity-50', currentPage >= totalPages);
            }
        }

        /**
         * Update mobile connection status
         */
        function updateMobileConnectionStatus(status, message) {
            const mobileStatus = document.getElementById('connection-status-mobile');
            if (mobileStatus) {
                mobileStatus.className = 'ml-2 w-2 h-2 rounded-full';
                switch (status) {
                    case 'connected':
                        mobileStatus.classList.add('bg-green-400');
                        break;
                    case 'error':
                        mobileStatus.classList.add('bg-red-400');
                        break;
                    case 'syncing':
                        mobileStatus.classList.add('bg-yellow-400');
                        break;
                    default:
                        mobileStatus.classList.add('bg-gray-400');
                }
            }
        }

        /**
         * Handle mobile contact card tap
         */
        function handleMobileContactTap(contactId) {
            // On mobile, tapping a card opens the edit modal
            openEditContactModal(contactId);
        }

        /**
         * Initialize mobile interface
         */
        function initializeMobileInterface() {
            // Add touch event listeners for better mobile interaction
            document.addEventListener('touchstart', function() {}, { passive: true });
            
            // Sync mobile filters on initialization
            setTimeout(syncMobileFilters, 100);
            
            // Update mobile connection status when desktop status changes
            const originalUpdateConnectionStatus = updateConnectionStatus;
            updateConnectionStatus = function(status, message) {
                originalUpdateConnectionStatus(status, message);
                updateMobileConnectionStatus(status, message);
            };
            
            // Override bulk actions update to include mobile
            const originalUpdateBulkActionButtons = updateBulkActionButtons;
            updateBulkActionButtons = function() {
                originalUpdateBulkActionButtons();
                updateMobileBulkActions();
            };
            
            // Override pagination update to include mobile
            const originalUpdatePaginationControls = updatePaginationControls;
            updatePaginationControls = function() {
                originalUpdatePaginationControls();
                updateMobilePaginationControls();
            };
            
            // Add mobile-specific event listeners
            document.addEventListener('DOMContentLoaded', function() {
                // Close mobile menu when clicking outside
                document.addEventListener('click', function(event) {
                    const mobileMenu = document.getElementById('mobile-menu');
                    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
                    
                    if (mobileMenu && !mobileMenu.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        mobileMenu.classList.add('hidden');
                    }
                });
                
                // Handle mobile card interactions
                document.addEventListener('click', function(event) {
                    const mobileCard = event.target.closest('.mobile-contact-card');
                    if (mobileCard && !event.target.closest('.mobile-checkbox') && !event.target.closest('.mobile-action-btn')) {
                        const contactId = mobileCard.dataset.contactId;
                        if (contactId) {
                            handleMobileContactTap(contactId);
                        }
                    }
                });
            });
        }

        // Initialize mobile interface
        initializeMobileInterface();
    </script>
</body>

</html>